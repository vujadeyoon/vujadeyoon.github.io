<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://vujadeyoon.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://vujadeyoon.github.io/" rel="alternate" type="text/html" hreflang="en" /><updated>2023-05-24T21:18:40+00:00</updated><id>https://vujadeyoon.github.io/feed.xml</id><title type="html">blank</title><subtitle>A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
</subtitle><entry><title type="html">Amazon Elastic Kubernetes Service (EKS)</title><link href="https://vujadeyoon.github.io/blog/2022/eks/" rel="alternate" type="text/html" title="Amazon Elastic Kubernetes Service (EKS)" /><published>2022-01-28T00:00:00+00:00</published><updated>2022-01-28T00:00:00+00:00</updated><id>https://vujadeyoon.github.io/blog/2022/eks</id><content type="html" xml:base="https://vujadeyoon.github.io/blog/2022/eks/"><![CDATA[<h2 id="table-of-contents">Table of contents</h2>
<ol>
  <li><a href="#notice">Notice</a></li>
  <li><a href="#k8s">What is Kubernetes (K8s)?</a></li>
  <li><a href="#eks">What is Amazon Elastic Kubernetes Service (EKS)?</a></li>
  <li><a href="#cluster">How to create a cluster</a></li>
  <li><a href="#nodegroup">How to create a node group</a></li>
  <li><a href="#ca">How to configure a cluster autoscaler (CA)</a></li>
  <li><a href="#aws_lbc">How to install the AWS load balancer controller</a></li>
  <li><a href="#metric_server">How to install a metric server</a></li>
  <li><a href="#namespace">How to apply a namespace</a></li>
  <li><a href="#deployment">How to apply a deployment</a></li>
  <li><a href="#service">How to apply a service</a></li>
  <li><a href="#hpa">How to apply a horizontal pod autoscaler (HPA)</a></li>
  <li><a href="#ingress">How to apply an ingress</a></li>
  <li><a href="#kubectl_commands">Useful kubectl commands</a></li>
  <li><a href="#fix_error">How to fix error</a></li>
  <li><a href="#ref">Reference</a></li>
</ol>

<hr />

<h2 id="1-notice-">1. Notice <a name="notice"></a></h2>
<ul>
  <li>A guide for setting the Amazon Web Services (AWS) Cloud9</li>
  <li>The name of region is Asia Pacific (Seoul) and the corresponding code is ap-northeast-2 [1].</li>
  <li>I recommend that you should ignore the commented instructions with an octothorpe, #.</li>
  <li>I recommend that you should fill in the appropriate letters between the parentheses, &lt;&gt;.</li>
</ul>

<hr />

<h2 id="2-what-is-kubernetes-k8s-">2. What is Kubernetes (K8s)? <a name="k8s"></a></h2>
<p>Kubernetes is a portable, extensible, open-source platform for managing containerized workloads and services, that
facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem.
Kubernetes services, support, and tools are widely available. The name Kubernetes originates from Greek, meaning
helmsman or pilot. K8s as an abbreviation results from counting the eight letters between the “K” and the “s”. Google
open-sourced the Kubernetes project in 2014. Kubernetes combines over 15 years of Google’s experience running production
workloads at scale with best-of-breed ideas and practices from the community [2].</p>

<hr />

<h2 id="3-what-is-amazon-elastic-kubernetes-service-eks-">3. What is Amazon Elastic Kubernetes Service (EKS)? <a name="eks"></a></h2>
<p>Amazon Elastic Kubernetes Service (Amazon EKS) is a managed Kubernetes service that makes it easy for you to run
Kubernetes on AWS and on-premises. Kubernetes is an open-source system for automating deployment, scaling, and
management of containerized applications. Amazon EKS is certified Kubernetes-conformant, so existing applications that
run on upstream Kubernetes are compatible with Amazon EKS [3].</p>

<h5 id="1-amazon-eks-cluster">1. Amazon EKS cluster</h5>
<p>An Amazon EKS cluster, which calls cluster for short, consists of two primary components:</p>
<ul>
  <li>The Amazon EKS control plane</li>
  <li>Amazon EKS nodes that are registered with the control plane</li>
</ul>

<p>The Amazon EKS control plane consists of control plane nodes that run the Kubernetes software, such as etcd and the
Kubernetes API server. The control plane runs in an account managed by AWS, and the Kubernetes API is exposed via the
Amazon EKS endpoint associated with your cluster. Each Amazon EKS cluster control plane is single-tenant and unique, and
runs on its own set of Amazon EC2 instances [4].</p>

<p>The kinds of the Amazon EKS cluster are public (non-private) and private cluster.</p>
<ul>
  <li>Public cluster (non-private cluster): All node groups in the cluster are in the public subnet.</li>
  <li>Private cluster: All node groups in the cluster are in the private subnet. Thus, it enables that all pods (in nodes)
in the node groups are only internally accessed.</li>
</ul>

<h5 id="2-amazon-eks-managed-node-group">2. Amazon EKS managed node group</h5>
<p>A node group means a set of worker nodes which calls just nodes for short. A cluster consists of a number of node groups.
Please note that a cluster can be composed of various types of the node groups (e.g. g4dn.xlarge and t5.large).
There are two types of the node groups [5].</p>
<ul>
  <li>EKS managed node group
    <ul>
      <li>Flag: managedNodeGroups</li>
      <li>When creating a worker node, it supports Amazon Linux based EKS optimized Amazon Linux 2 AMI.</li>
      <li>It automates the provisioning and lifecycle management of nodes (Amazon EC2 instances) for Amazon EKS Kubernetes
clusters [6].</li>
    </ul>
  </li>
  <li>Self managed nodes
    <ul>
      <li>Flag: nodeGroups</li>
      <li>When creating a worker node, it supports other operating system (OS) which is not based on Amazon Linux (e.g. Windows).</li>
    </ul>
  </li>
</ul>

<h5 id="3-cluster-autosacler-ca">3. Cluster Autosacler (CA)</h5>
<p>The Kubernetes Cluster Autoscaler automatically adjusts the number of nodes in your cluster when pods fail or are
rescheduled onto other nodes [7].</p>

<h5 id="4-aws-load-balancer-controller">4. AWS Load Balancer Controller</h5>
<p>The AWS Load Balancer Controller manages AWS Elastic Load Balancers for a Kubernetes cluster. Please note that The
AWS Load Balancer Controller replaces the functionality of the AWS ALB Ingress Controller for Kubernetes [8].</p>

<h5 id="5-metrics-server">5. Metrics Server</h5>
<p>The Kubernetes Metrics Server is an aggregator of resource usage data in your cluster, and it is not deployed by default
in Amazon EKS clusters. The Metrics Server is commonly used by other Kubernetes add ons, such as the Horizontal Pod
Autoscaler (HPA) or the Kubernetes Dashboard [9].</p>

<h5 id="6-namespace">6. Namespace</h5>
<p>A namespace is a way to group services for an application. When you create a namespace, you specify how you want to
discover service instances that you register with AWS Cloud Map: using API calls or using DNS queries. You also specify
the name that you want your application to use to discover instances [10].</p>

<h5 id="7-deployment">7. Deployment</h5>
<p>A deployment provides declarative updates for pods and replicaset [11] In other words, the deployment manages a
replicated application on the cluster. The pods are the smallest deployable units of computing that you can create and
manage in Kubernetes [12]. The replicaset ensures that a specified number of pod replicas are running at any given time
[13].</p>

<h5 id="8-service">8. Service</h5>
<p>An abstract way to expose an application running on a set of pods as a network service [14].</p>

<h5 id="9-horizontal-pod-autoscaling">9. Horizontal Pod Autoscaling</h5>
<p>In Kubernetes, a horizontal pod autoscaler (HPA) automatically updates a workload resource (such as a Deployment or StatefulSet),
with the aim of automatically scaling the workload to match demand [15].
The statefulset is the workload API object used to manage stateful applications. it manages deployment and scaling of a
set of pods, with durable storage and persistent identifier for each pod [16].</p>

<h5 id="10-ingress">10. Ingress</h5>
<p>Ingress is an Application Programming Interface (API) object that manages external access to the services in a cluster,
typically Hypertext Transfer Protocol (HTTP) [17].</p>

<hr />

<h2 id="4-how-to-create-a-cluster-">4. How to create a cluster <a name="cluster"></a></h2>
<h5 id="1-how-to-create-a-cluster">1. How to create a cluster</h5>
<p>In about 40 minutes, you can create a cluster with a <a href="/assets/blog/AWS/4_EKS/dev/cluster/cluster.yaml">cluster.yaml</a>.
I recommend that you should check the field of the yaml file.</p>
<ul>
  <li>metadata:name: vujade-cluster</li>
  <li>metadata:region: ap-northeast-2</li>
  <li>metadata:version: “1.21”</li>
  <li>vpc:subnets:private:
    <ul>
      <li>ap-northeast-2a: { id: subnet-012a3456b78cde9f0 }</li>
      <li>ap-northeast-2c: { id: subnet-0123a4bc5d678e901 }</li>
    </ul>
  </li>
  <li>secretsEncryption:keyARN: arn:aws:kms:ap-northeast-2:123456789123:key/a0b1234c-de5f-6789-g01h-2i3456j789k0</li>
</ul>

<p>In this case, the <em>vpc:subnets:private</em> is required because of the private cluster. The values of the field which can be obtained on
<a href="https://ap-northeast-2.console.aws.amazon.com/vpc">VPC Dashboard</a> correspond to the subnets of the data plane which are
created in the <a href="/blog/2022/vpc/#subnet">Amazon Virtual Private Cloud (VPC) - Section 5. How to set up subnets</a>. Also, as far as I mentioned in
<a href="/blog/2022/vpc/#subnet">Amazon Virtual Private Cloud (VPC) - Section 5. How to set up subnets</a>, the considered EC2 instance type, g4dn.xlarge is only
supported ap-northeast-2a and ap-northeast-2c. The value of the <em>secretsEncryption:keyARN</em> is the MASTER_ARN which is
created in the <a href="/blog/2022/cloud9/#aws_cmk">Amazon Web Services (AWS) Cloud9 - Section 8. How to create an AWS KMS custom managed key (CMK)</a>. Please note that
any tags for the VPC are not required because the cluster version is 1.19+ as far as I mentioned in
<a href="/blog/2022/vpc/#vpc">Amazon Virtual Private Cloud (VPC) - Section 4. How to create a VPC</a>.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">eksctl.io/v1alpha5</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfig</span>
 
 <span class="na">metadata</span><span class="pi">:</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">vujade-cluster</span>
   <span class="na">region</span><span class="pi">:</span> <span class="s">ap-northeast-2</span>
   <span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.21"</span>
  
 <span class="na">vpc</span><span class="pi">:</span>
   <span class="na">subnets</span><span class="pi">:</span>
     <span class="na">private</span><span class="pi">:</span>
       <span class="na">ap-northeast-2a</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">id</span><span class="pi">:</span> <span class="nv">subnet-012a3456b78cde9f0</span> <span class="pi">}</span>
       <span class="na">ap-northeast-2c</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">id</span><span class="pi">:</span> <span class="nv">subnet-0123a4bc5d678e901</span> <span class="pi">}</span>
 <span class="na">secretsEncryption</span><span class="pi">:</span>
   <span class="na">keyARN</span><span class="pi">:</span> <span class="s">arn:aws:kms:ap-northeast-2:123456789123:key/a0b1234c-de5f-6789-g01h-2i3456j789k0</span>
</pre></td></tr></tbody></table></code></pre></figure>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl create cluster <span class="nt">-f</span> ./cluster.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    2022-01-27 06:49:03 <span class="o">[</span>ℹ]  eksctl version 0.80.0
    2022-01-27 06:49:03 <span class="o">[</span>ℹ]  using region ap-northeast-2
    2022-01-27 06:49:03 <span class="o">[</span>✔]  using existing VPC <span class="o">(</span>vpc-012abcde34fg5678h<span class="o">)</span> and subnets <span class="o">(</span>private:map[ap-northeast-2a:<span class="o">{</span>subnet-012a3456b78cde9f0 ap-northeast-2a 10.172.92.0/23<span class="o">}</span> ap-northeast-2c:<span class="o">{</span>subnet-0123a4bc5d678e901 ap-northeast-2c 10.172.94.0/23<span class="o">}]</span> public:map[]<span class="o">)</span>
    2022-01-27 06:49:03 <span class="o">[!]</span>  custom VPC/subnets will be used<span class="p">;</span> <span class="k">if </span>resulting cluster doesn<span class="s1">'t function as expected, make sure to review the configuration of VPC/subnets
    2022-01-27 06:49:03 [ℹ]  using Kubernetes version 1.21
    2022-01-27 06:49:03 [ℹ]  creating EKS cluster "vujade-cluster" in "ap-northeast-2" region with 
    2022-01-27 06:49:03 [ℹ]  will create a CloudFormation stack for cluster itself and 0 nodegroup stack(s)
    2022-01-27 06:49:03 [ℹ]  will create a CloudFormation stack for cluster itself and 0 managed nodegroup stack(s)
    2022-01-27 06:49:03 [ℹ]  if you encounter any issues, check CloudFormation console or try '</span>eksctl utils describe-stacks <span class="nt">--region</span><span class="o">=</span>ap-northeast-2 <span class="nt">--cluster</span><span class="o">=</span>vujade-cluster<span class="s1">'
    2022-01-27 06:49:03 [ℹ]  Kubernetes API endpoint access will use default of {publicAccess=true, privateAccess=false} for cluster "vujade-cluster" in "ap-northeast-2"
    2022-01-27 06:49:03 [ℹ]  CloudWatch logging will not be enabled for cluster "vujade-cluster" in "ap-northeast-2"
    2022-01-27 06:49:03 [ℹ]  you can enable it with '</span>eksctl utils update-cluster-logging <span class="nt">--enable-types</span><span class="o">={</span>SPECIFY-YOUR-LOG-TYPES-HERE <span class="o">(</span>e.g. all<span class="o">)}</span> <span class="nt">--region</span><span class="o">=</span>ap-northeast-2 <span class="nt">--cluster</span><span class="o">=</span>vujade-cluster<span class="s1">'
    2022-01-27 06:49:03 [ℹ]  
    2 sequential tasks: { create cluster control plane "vujade-cluster", wait for control plane to become ready 
    }
    2022-01-27 06:49:03 [ℹ]  building cluster stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:49:04 [ℹ]  deploying stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:49:34 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:50:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:51:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:52:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:53:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:54:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:55:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:56:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:57:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:58:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:59:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 07:00:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 07:02:05 [ℹ]  waiting for the control plane availability...
    2022-01-27 07:02:05 [✔]  saved kubeconfig as "/home/ubuntu/.kube/config"
    2022-01-27 07:02:05 [ℹ]  no tasks
    2022-01-27 07:02:05 [✔]  all EKS cluster resources for "vujade-cluster" have been created
    2022-01-27 07:02:06 [ℹ]  kubectl command should work with "/home/ubuntu/.kube/config", try '</span>kubectl get nodes<span class="s1">'
    2022-01-27 07:02:06 [✔]  EKS cluster "vujade-cluster" in "ap-northeast-2" region is ready
</span></code></pre></div></div>

<h5 id="2-how-to-check-the-created-cluster">2. How to check the created cluster</h5>
<p>You can check the created cluster with three options.</p>
<ol>
  <li>You can check the cluster on <a href="https://ap-northeast-2.console.aws.amazon.com/cloudformation">CloudFormation</a>.</li>
  <li>You can check the cluster on <a href="https://ap-northeast-2.console.aws.amazon.com/eks/home?region=ap-northeast-2#/clusters">Amazon Container Services - Clusters</a>.</li>
  <li>You can check the cluster with an eksctl command.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 <span class="nv">$ </span>eksctl get cluster
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     2022-01-27 14:27:46 <span class="o">[</span>ℹ]  eksctl version 0.80.0
     2022-01-27 14:27:46 <span class="o">[</span>ℹ]  using region ap-northeast-2
     NAME            REGION          EKSCTL CREATED
     vujade-cluster  ap-northeast-2  True
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="3-how-to-connect-a-cluster">3. How to connect a cluster</h5>
<p>You can connect the created cluster as follows. Please note that the field, <em>region</em> and <em>name</em> are the AWS region
and the cluster name, respectively.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws eks <span class="nt">--region</span> ap-northeast-2 update-kubeconfig <span class="nt">--name</span> vujade-cluster
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Added new context arn:aws:eks:ap-northeast-2:123456789123:cluster/vujade-cluster to /home/ubuntu/.kube/config
</code></pre></div></div>

<h5 id="4-how-to-delete-a-cluster">4. How to delete a cluster</h5>
<p>You can delete the created cluster as follows. Please note that the field, <em>name</em> is the cluster name.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl delete cluster <span class="nt">--name</span> vujade-cluster
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    2022-01-27 14:27:46 <span class="o">[</span>ℹ]  eksctl version 0.79.0
    2022-01-27 14:27:46 <span class="o">[</span>ℹ]  using region ap-northeast-2
    2022-01-27 14:27:46 <span class="o">[</span>ℹ]  deleting EKS cluster <span class="s2">"vujade-cluster"</span>
    2022-01-27 14:27:46 <span class="o">[</span>ℹ]  deleted 0 Fargate profile<span class="o">(</span>s<span class="o">)</span>
    2022-01-27 14:27:46 <span class="o">[</span>✔]  kubeconfig has been updated
    2022-01-18 07:43:29 <span class="o">[</span>ℹ]  cleaning up AWS load balancers created by Kubernetes objects of Kind Service or Ingress
    2022-01-27 14:27:30 <span class="o">[</span>ℹ]  1 task: <span class="o">{</span> delete cluster control plane <span class="s2">"vujade-cluster"</span> <span class="o">[</span>async] <span class="o">}</span>
    2022-01-27 14:27:30 <span class="o">[</span>ℹ]  will delete stack <span class="s2">"eksctl-vujade-cluster-cluster"</span>
    2022-01-27 14:27:30 <span class="o">[</span>✔]  all cluster resources were deleted
</code></pre></div></div>

<hr />

<h2 id="5-how-to-create-a-node-group-">5. How to create a node group <a name="nodegroup"></a></h2>
<h5 id="1-how-to-create-a-node-group">1. How to create a node group</h5>
<p>In about 20 minutes, you can create a node group with a <a href="/assets/blog/AWS/4_EKS/dev/nodegroup/nodegroup.yaml">nodegroup.yaml</a>.
Please note that the node group is based on the
EKS managed node group in this case. I recommend that you should check the field of the yaml file.</p>
<ul>
  <li>metadata:name: vujade-cluster</li>
  <li>metadata:region: ap-northeast-2</li>
  <li>managedNodeGroups:name: ng-dl</li>
  <li>managedNodeGroups:instanceType: g4dn.xlarge</li>
  <li>managedNodeGroups:minSize: 1</li>
  <li>managedNodeGroups:maxSize: 5</li>
  <li>managedNodeGroups:desiredCapacity: 1</li>
  <li>managedNodeGroups:volumeSize: 80</li>
  <li>managedNodeGroups:privateNetworking: true</li>
  <li>managedNodeGroups:ssh:allow: true</li>
  <li>managedNodeGroups:ssh:publicKeyName: vujade-eks</li>
</ul>

<p>The fields, <em>managedNodeGroups:minSize</em>, <em>managedNodeGroups:maxSize</em> and <em>managedNodeGroups:desiredCapacity</em> are
parameters for the Cluster Autoscaler (CA) which scales up and down EC2 instances in node groups.
the <em>managedNodeGroups:volumeSize</em> means the size of the Elastic Block Storage (EBS). The default value is 80.
In this case, the <em>managedNodeGroups:privateNetworking</em> is true because the cluster is private cluster. The value of
the field, <em>managedNodeGroups:ssh:publicKeyName</em> is the name of the SSH key obtained from the
<a href="/blog/2022/cloud9/#aws_ssh">Amazon Web Services (AWS) Cloud9 - Section 7. How to create and import a SSH key</a>.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">eksctl.io/v1alpha5</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfig</span>
 <span class="na">metadata</span><span class="pi">:</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">vujade-cluster</span>
   <span class="na">region</span><span class="pi">:</span> <span class="s">ap-northeast-2</span>
 <span class="na">managedNodeGroups</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ng-dl</span>
     <span class="na">instanceType</span><span class="pi">:</span> <span class="s">g4dn.xlarge</span>
     <span class="na">minSize</span><span class="pi">:</span> <span class="m">1</span>
     <span class="na">maxSize</span><span class="pi">:</span> <span class="m">5</span>
     <span class="na">desiredCapacity</span><span class="pi">:</span> <span class="m">1</span>
     <span class="na">volumeSize</span><span class="pi">:</span> <span class="m">80</span>
     <span class="na">privateNetworking</span><span class="pi">:</span> <span class="kc">true</span>
     <span class="na">ssh</span><span class="pi">:</span>
       <span class="na">allow</span><span class="pi">:</span> <span class="kc">true</span>
       <span class="na">publicKeyName</span><span class="pi">:</span> <span class="s">vujade-eks</span>
</pre></td></tr></tbody></table></code></pre></figure>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl create nodegroup <span class="nt">-f</span> ./eks_yaml/dev/nodegroup/nodegroup.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  eksctl version 0.80.0
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  using region ap-northeast-2
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  will use version 1.21 <span class="k">for </span>new nodegroup<span class="o">(</span>s<span class="o">)</span> based on control plane version
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  nodegroup <span class="s2">"ng-dl"</span> will use <span class="s2">""</span> <span class="o">[</span>AmazonLinux2/1.21]
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  using EC2 key pair <span class="s2">"vujade-eks"</span>
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  1 nodegroup <span class="o">(</span>ng-dl<span class="o">)</span> was included <span class="o">(</span>based on the include/exclude rules<span class="o">)</span>
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  will create a CloudFormation stack <span class="k">for </span>each of 1 managed nodegroups <span class="k">in </span>cluster <span class="s2">"vuajde-cluster"</span>
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  
    2 sequential tasks: <span class="o">{</span> fix cluster compatibility, 1 task: <span class="o">{</span> 1 task: <span class="o">{</span> create managed nodegroup <span class="s2">"ng-dl"</span> <span class="o">}</span> <span class="o">}</span> 
    <span class="o">}</span>
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  checking cluster stack <span class="k">for </span>missing resources
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  cluster stack has all required resources
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  building managed nodegroup stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  deploying stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:11:39 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:11:56 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:12:14 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:12:31 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:12:47 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:13:03 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:13:19 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:13:39 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:13:55 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:14:13 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:14:32 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:14:50 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:15:09 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  1 task: <span class="o">{</span> <span class="nb">install </span>Nvidia device plugin <span class="o">}</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  created <span class="s2">"kube-system:DaemonSet.apps/nvidia-device-plugin-daemonset"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  as you are using the EKS-Optimized Accelerated AMI with a GPU-enabled instance <span class="nb">type</span>, the Nvidia Kubernetes device plugin was automatically installed.
            to skip installing it, use <span class="nt">--install-nvidia-plugin</span><span class="o">=</span>false.
    2022-01-27 07:15:27 <span class="o">[</span>✔]  created 0 nodegroup<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>cluster <span class="s2">"vuajde-cluster"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  nodegroup <span class="s2">"ng-dl"</span> has 1 node<span class="o">(</span>s<span class="o">)</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  node <span class="s2">"ip-10-172-95-87.ap-northeast-2.compute.internal"</span> is ready
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>at least 1 node<span class="o">(</span>s<span class="o">)</span> to become ready <span class="k">in</span> <span class="s2">"ng-dl"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  nodegroup <span class="s2">"ng-dl"</span> has 1 node<span class="o">(</span>s<span class="o">)</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  node <span class="s2">"ip-10-172-95-87.ap-northeast-2.compute.internal"</span> is ready
    2022-01-27 07:15:27 <span class="o">[</span>✔]  created 1 managed nodegroup<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>cluster <span class="s2">"vuajde-cluster"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  checking security group configuration <span class="k">for </span>all nodegroups
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  all nodegroups have up-to-date cloudformation templates
</code></pre></div></div>

<h5 id="2-how-to-check-the-created-node-group">2. How to check the created node group</h5>
<ol>
  <li>Check node groups. <br />
You can check node groups as follows.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl get nodegroup <span class="nt">--cluster</span> vujade-cluster
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 2022-01-28 00:47:46 <span class="o">[</span>ℹ]  eksctl version 0.80.0
 2022-01-28 00:47:46 <span class="o">[</span>ℹ]  using region ap-northeast-2
 CLUSTER         NODEGROUP       STATUS  CREATED                 MIN SIZE        MAX SIZE        DESIRED CAPACITY        INSTANCE TYPE   IMAGE ID        ASG NAME
 vujade-cluster  ng-dl           ACTIVE  2022-01-27T07:12:18Z    1               5               1                       g4dn.xlarge     AL2_x86_64_GPU  eks-ng-dl-0abc1d23-01a2-0a12-012a-a0bc1234d5e6
</code></pre></div>    </div>
  </li>
  <li>Check nodes. <br />
You can also check nodes in the node groups. Please note that you should connect the created cluster as described in
<a href="#cluster">Section 5. How to create a cluster</a> before listing nodes below.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get nodes <span class="nt">--show-labels</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> NAME                                              STATUS   ROLES    AGE   VERSION               LABELS
 ip-10-172-95-87.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   17h   v1.21.5-eks-9017834   alpha.eksctl.io/cluster-name<span class="o">=</span>vujade-cluster,alpha.eksctl.io/nodegroup-name<span class="o">=</span>ng-dl,beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/instance-type<span class="o">=</span>g4dn.xlarge,beta.kubernetes.io/os<span class="o">=</span>linux,eks.amazonaws.com/capacityType<span class="o">=</span>ON_DEMAND,eks.amazonaws.com/nodegroup-image<span class="o">=</span>ami-04a860d4e53598406,eks.amazonaws.com/nodegroup<span class="o">=</span>ng-dl,eks.amazonaws.com/sourceLaunchTemplateId<span class="o">=</span>lt-0fbc06a2d297490d2,eks.amazonaws.com/sourceLaunchTemplateVersion<span class="o">=</span>1,failure-domain.beta.kubernetes.io/region<span class="o">=</span>ap-northeast-2,failure-domain.beta.kubernetes.io/zone<span class="o">=</span>ap-northeast-2c,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>ip-10-172-95-87.ap-northeast-2.compute.internal,kubernetes.io/os<span class="o">=</span>linux,node.kubernetes.io/instance-type<span class="o">=</span>g4dn.xlarge,topology.kubernetes.io/region<span class="o">=</span>ap-northeast-2,topology.kubernetes.io/zone<span class="o">=</span>ap-northeast-2c
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="3-how-to-delete-a-node-group">3. How to delete a node group</h5>
<p>You can delete a node group as follows.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl delete nodegroup <span class="nt">--region</span><span class="o">=</span>ap-northeast-2 <span class="nt">--cluster</span><span class="o">=</span>vujade-cluster <span class="nt">--name</span><span class="o">=</span>ng-dl
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  eksctl version 0.79.0
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  using region ap-northeast-2
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  1 nodegroup <span class="o">(</span>ng-dl<span class="o">)</span> was included <span class="o">(</span>based on the include/exclude rules<span class="o">)</span>
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  will drain 1 nodegroup<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>cluster <span class="s2">"vujade-cluster"</span>
    2022-01-18 07:41:36 <span class="o">[!]</span>  no nodes found <span class="k">in </span>nodegroup <span class="s2">"ng-dl"</span> <span class="o">(</span>label selector: <span class="s2">"alpha.eksctl.io/nodegroup-name=ng-dl"</span><span class="o">)</span>
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  will delete 1 nodegroups from cluster <span class="s2">"vujade-cluster"</span>
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  1 task: <span class="o">{</span> 1 task: <span class="o">{</span> delete nodegroup <span class="s2">"ng-dl"</span> <span class="o">[</span>async] <span class="o">}</span> <span class="o">}</span>
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  will delete stack <span class="s2">"eksctl-vujade-cluster-nodegroup-ng-dl"</span>
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  will delete 0 nodegroups from auth ConfigMap <span class="k">in </span>cluster <span class="s2">"vujade-cluster"</span>
    2022-01-18 07:41:36 <span class="o">[</span>✔]  deleted 1 nodegroup<span class="o">(</span>s<span class="o">)</span> from cluster <span class="s2">"vujade-cluster"</span>
</code></pre></div></div>

<hr />

<h2 id="6-how-to-configure-a-cluster-autoscaler-ca-">6. How to configure a cluster autoscaler (CA) <a name="ca"></a></h2>
<p>You can configure a cluster autoscaler (CA) by executing following commands. You can get more information in the AWS EKS
workshop guide, <a href="https://www.eksworkshop.com/beginner/080_scaling/deploy_ca">Configure Cluster Autoscaler (CA)</a>.
Please note the CA only works when there is a node group at least.</p>

<p>I provide a bash script, <a href="/assets/blog/AWS/4_EKS/bash_install_ca.sh">bash_install_ca.sh</a> to install the CA easily. Please
note that you can get the <em>ACCOUNT_ID</em> in the <a href="/blog/2022/cloud9/#aws_cmk">Amazon Web Services (AWS) Cloud9 - Section 8. How to create an AWS KMS
custom managed key (CMK)</a>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>bash ./bash_install_ca.sh NAME_CLUSTER ACCOUNT_ID
</code></pre></div></div>

<h5 id="1-iam-roles-for-service-accounts">1. IAM roles for service accounts</h5>
<ol>
  <li>Enabling IAM roles for service accounts on your cluster (i.e. Creating IAM OIDC provider).
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl utils associate-iam-oidc-provider <span class="nt">--cluster</span> vujade-cluster <span class="nt">--approve</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 2022-01-28 08:41:31 <span class="o">[</span>ℹ]  eksctl version 0.80.0
 2022-01-28 08:41:31 <span class="o">[</span>ℹ]  using region ap-northeast-2
 2022-01-28 08:41:32 <span class="o">[</span>ℹ]  will create IAM Open ID Connect provider <span class="k">for </span>cluster <span class="s2">"vujade-cluster"</span> <span class="k">in</span> <span class="s2">"ap-northeast-2"</span>
 2022-01-28 08:41:32 <span class="o">[</span>✔]  created IAM Open ID Connect provider <span class="k">for </span>cluster <span class="s2">"vujade-cluster"</span> <span class="k">in</span> <span class="s2">"ap-northeast-2"</span>
</code></pre></div>    </div>
  </li>
  <li>Creating an IAM policy for your service account that will allow your CA pod to interact with the autoscaling groups. <br />
You can create the IAM policy with <a href="/assets/blog/AWS/4_EKS/k8s-asg-policy.json">k8s-asg-policy.json</a> as below. Please
note that you don’t need to create the customer managed IAM policy if it already exists as below.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws iam create-policy <span class="nt">--policy-name</span> k8s-asg-policy <span class="nt">--policy-document</span> file://./k8s-asg-policy.json
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> An error occurred <span class="o">(</span>EntityAlreadyExists<span class="o">)</span> when calling the CreatePolicy operation: A policy called k8s-asg-policy already exists. Duplicate names are not allowed.
</code></pre></div>    </div>
  </li>
  <li>Finally, create an IAM role for the cluster-autoscaler Service Account in the kube-system namespace. <br />
You can obtain the policy ARN in <a href="https://console.aws.amazon.com/iamv2/home#/policies">IAM - Policies</a> with k8s-asg-policy.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl create iamserviceaccount <span class="se">\</span>
2   <span class="nt">--name</span> cluster-autoscaler <span class="se">\</span>
3   <span class="nt">--namespace</span> kube-system <span class="se">\</span>
4   <span class="nt">--cluster</span> vujade-cluster <span class="se">\</span>
5   <span class="nt">--attach-policy-arn</span> <span class="s2">"arn:aws:iam::123456789123:policy/k8s-asg-policy"</span> <span class="se">\</span>
6   <span class="nt">--approve</span> <span class="se">\</span>
7   <span class="nt">--override-existing-serviceaccounts</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 2022-01-28 09:15:51 <span class="o">[</span>ℹ]  eksctl version 0.80.0
 2022-01-28 09:15:51 <span class="o">[</span>ℹ]  using region ap-northeast-2
 2022-01-28 09:15:52 <span class="o">[</span>ℹ]  1 iamserviceaccount <span class="o">(</span>kube-system/cluster-autoscaler<span class="o">)</span> was included <span class="o">(</span>based on the include/exclude rules<span class="o">)</span>
 2022-01-28 09:15:52 <span class="o">[!]</span>  metadata of serviceaccounts that exist <span class="k">in </span>Kubernetes will be updated, as <span class="nt">--override-existing-serviceaccounts</span> was <span class="nb">set
 </span>2022-01-28 09:15:52 <span class="o">[</span>ℹ]  1 task: <span class="o">{</span> 
     2 sequential sub-tasks: <span class="o">{</span> 
         create IAM role <span class="k">for </span>serviceaccount <span class="s2">"kube-system/cluster-autoscaler"</span>,
         create serviceaccount <span class="s2">"kube-system/cluster-autoscaler"</span>,
     <span class="o">}</span> <span class="o">}</span>2022-01-28 09:15:52 <span class="o">[</span>ℹ]  building iamserviceaccount stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span>
 2022-01-28 09:15:52 <span class="o">[</span>ℹ]  deploying stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span>
 2022-01-28 09:15:52 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span>
 2022-01-28 09:16:12 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span>
 2022-01-28 09:16:27 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span>
 2022-01-28 09:16:27 <span class="o">[</span>ℹ]  created serviceaccount <span class="s2">"kube-system/cluster-autoscaler"</span>
</code></pre></div>    </div>
  </li>
  <li>Make sure your service account with the ARN of the IAM role is annotated. <br />
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system describe sa cluster-autoscaler 
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Name:                cluster-autoscaler
 Namespace:           kube-system
 Labels:              app.kubernetes.io/managed-by<span class="o">=</span>eksctl
 Annotations:         eks.amazonaws.com/role-arn: arn:aws:iam::123456789123:role/eksctl-vujade-cluster-addon-iamserviceaccount-Role1-1DOGJCHJ8OE45
 Image pull secrets:  &lt;none&gt;
 Mountable secrets:   cluster-autoscaler-token-29s2h
 Tokens:              cluster-autoscaler-token-29s2h
 Events:              &lt;none&gt;
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="2-deploy-the-cluster-autoscaler-ca">2. Deploy the Cluster Autoscaler (CA)</h5>
<ol>
  <li>Deploy the Cluster Autoscaler to your cluster with the following command. <br />
You can get a yaml file for deploying a cluster from <a href="https://www.eksworkshop.com/beginner/080_scaling/deploy_ca.files/cluster-autoscaler-autodiscover.yaml">official EKS workshop site</a>
or <a href="/assets/blog/AWS/4_EKS/cluster-autoscaler-autodiscover.yaml">my GitHub</a>. Please note that you should modify the
cluster name to yours.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ./cluster-autoscaler-autodiscover.yaml
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> clusterrole.rbac.authorization.k8s.io/cluster-autoscaler created
 role.rbac.authorization.k8s.io/cluster-autoscaler created
 clusterrolebinding.rbac.authorization.k8s.io/cluster-autoscaler created
 rolebinding.rbac.authorization.k8s.io/cluster-autoscaler created
 deployment.apps/cluster-autoscaler created
</code></pre></div>    </div>
  </li>
  <li>To prevent CA from removing nodes where its own pod is running, we will add the
cluster-autoscaler.kubernetes.io/safe-to-evict annotation to its deployment with the following command.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system annotate deployment.apps/cluster-autoscaler cluster-autoscaler.kubernetes.io/safe-to-evict<span class="o">=</span><span class="s2">"false"</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> deployment.apps/cluster-autoscaler annotated
</code></pre></div>    </div>
  </li>
  <li>Finally let’s update the autoscaler image.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">export </span><span class="nv">K8S_VERSION</span><span class="o">=</span><span class="si">$(</span>kubectl version <span class="nt">--short</span> | <span class="nb">grep</span> <span class="s1">'Server Version:'</span> | <span class="nb">sed</span> <span class="s1">'s/[^0-9.]*\([0-9.]*\).*/\1/'</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="nb">.</span> <span class="nt">-f1</span>,2<span class="si">)</span>
2 <span class="nv">$ </span><span class="nb">export </span><span class="nv">AUTOSCALER_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="s2">"https://api.github.com/repos/kubernetes/autoscaler/releases"</span> | <span class="nb">grep</span> <span class="s1">'"tag_name":'</span> | <span class="nb">sed</span> <span class="nt">-s</span> <span class="s1">'s/.*-\([0-9][0-9\.]*\).*/\1/'</span> | <span class="nb">grep</span> <span class="nt">-m1</span> <span class="k">${</span><span class="nv">K8S_VERSION</span><span class="k">}</span><span class="si">)</span>
3 <span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">set </span>image deployment.apps/cluster-autoscaler cluster-autoscaler<span class="o">=</span>us.gcr.io/k8s-artifacts-prod/autoscaling/cluster-autoscaler:v<span class="k">${</span><span class="nv">AUTOSCALER_VERSION</span><span class="k">}</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> deployment.apps/cluster-autoscaler image updated
</code></pre></div>    </div>
  </li>
  <li>You can watch logs.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-f</span> deployment/cluster-autoscaler
</code></pre></div>    </div>
  </li>
  <li>Check the created cluster autoscaler.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get deploy <span class="nt">-A</span> 
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> NAMESPACE     NAME                 READY   UP-TO-DATE   AVAILABLE   AGE
 kube-system   cluster-autoscaler   1/1     1            1           7m39s
 kube-system   coredns              2/2     2            2           28h
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<h2 id="7-how-to-install-the-aws-load-balancer-controller-">7. How to install the AWS load balancer controller <a name="aws_lbc"></a></h2>
<p>You can install the AWS load balanacer controller by executing following commands. You can get more information in the
<a href="https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html">AWS Load Balancer Controller</a>,
<a href="https://www.eksworkshop.com/beginner/130_exposing-service/ingress_controller_alb">Ingress Controller</a> and
<a href="https://www.eksworkshop.com/020_prerequisites/k8stools/#set-the-aws-load-balancer-controller-version">Install Kubernetes Tools</a>.</p>

<p>I provide a bash script, <a href="/assets/blog/AWS/4_EKS/bash_install_lbc.sh">bash_install_lbc.sh</a> to install the AWS load
balancer controller easily. Please note that you can get the <em>ACCOUNT_ID</em> and <em>NAME_ROLE_AWS_LBC</em> in the
<a href="/blog/2022/cloud9/#aws_cmk">Amazon Web Services (AWS) Cloud9 - Section 8. How to create an AWS KMS custom managed key (CMK)</a>
and <a href="#role_aws_lbc">Step 7. Attach the IAM policy to the IAM role</a>, respectively.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>bash ./bash_install_lbc.sh NAME_CLUSTER ACCOUNT_ID NAME_ROLE_AWS_LBC
</code></pre></div></div>

<h5 id="1-deploy-the-aws-load-balancer-controller">1. Deploy the AWS Load Balancer Controller</h5>
<ol>
  <li>We will verify if the AWS Load Balancer Controller version has been set.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'export LBC_VERSION="v2.3.1"'</span> <span class="o">&gt;&gt;</span>  ~/.bash_profile
2 <span class="nv">$ </span><span class="nb">.</span> ~/.bash_profile
3 <span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-x</span> <span class="k">${</span><span class="nv">LBC_VERSION</span><span class="k">}</span> <span class="o">]</span>
4     <span class="k">then
</span>5       tput setaf 2<span class="p">;</span> <span class="nb">echo</span> <span class="s1">'${LBC_VERSION} has been set.'</span>
6     <span class="k">else
</span>7       tput setaf 1<span class="p">;</span> <span class="nb">echo</span> <span class="s1">'${LBC_VERSION} has NOT been set.'</span>
8   <span class="k">fi</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">${</span><span class="nv">LBC_VERSION</span><span class="k">}</span> has been set.
</code></pre></div>    </div>
  </li>
  <li>Create IAM OIDC provider. <br />
You can skip this step if you already execute the command in <a href="#ca">7. How to configure a cluster autoscaler (CA)</a>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl utils associate-iam-oidc-provider <span class="nt">--cluster</span> vujade-cluster <span class="nt">--approve</span>
</code></pre></div>    </div>
  </li>
  <li>Create an IAM policy, AWSLoadBalancerControllerIAMPolicy. <br />
Please note that you don’t need to create the customer managed IAM policy if it already exists as below.
You can also download the <a href="/assets/blog/AWS/4_EKS/iam_policy.json">iam_policy.json</a>.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>curl <span class="nt">-o</span> iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.3.1/docs/install/iam_policy.json
2 <span class="nv">$ </span>aws iam create-policy <span class="se">\</span>
3   <span class="nt">--policy-name</span> AWSLoadBalancerControllerIAMPolicy <span class="se">\</span>
4   <span class="nt">--policy-document</span> file://iam_policy.json
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> An error occurred <span class="o">(</span>EntityAlreadyExists<span class="o">)</span> when calling the CreatePolicy operation: A policy called AWSLoadBalancerControllerIAMPolicy already exists. Duplicate names are not allowed.
</code></pre></div>    </div>
  </li>
  <li>Create a IAM role and ServiceAccount. <br />
You can obtain the policy ARN in <a href="https://console.aws.amazon.com/iamv2/home#/policies">IAM - Policies</a> with AWSLoadBalancerControllerIAMPolicy.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl create iamserviceaccount <span class="se">\</span>
2   <span class="nt">--cluster</span> vujade-cluster <span class="se">\</span>
3   <span class="nt">--namespace</span> kube-system <span class="se">\</span>
4   <span class="nt">--name</span> aws-load-balancer-controller <span class="se">\</span>
5   <span class="nt">--attach-policy-arn</span> arn:aws:iam::123456789123:policy/AWSLoadBalancerControllerIAMPolicy <span class="se">\</span>
6   <span class="nt">--override-existing-serviceaccounts</span> <span class="se">\</span>
7   <span class="nt">--approve</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 2022-01-28 13:32:15 <span class="o">[</span>ℹ]  eksctl version 0.80.0
 2022-01-28 13:32:15 <span class="o">[</span>ℹ]  using region ap-northeast-2
 2022-01-28 13:32:16 <span class="o">[</span>ℹ]  1 existing iamserviceaccount<span class="o">(</span>s<span class="o">)</span> <span class="o">(</span>kube-system/cluster-autoscaler<span class="o">)</span> will be excluded
 2022-01-28 13:32:16 <span class="o">[</span>ℹ]  1 iamserviceaccount <span class="o">(</span>kube-system/aws-load-balancer-controller<span class="o">)</span> was included <span class="o">(</span>based on the include/exclude rules<span class="o">)</span>
 2022-01-28 13:32:16 <span class="o">[!]</span>  metadata of serviceaccounts that exist <span class="k">in </span>Kubernetes will be updated, as <span class="nt">--override-existing-serviceaccounts</span> was <span class="nb">set
 </span>2022-01-28 13:32:16 <span class="o">[</span>ℹ]  1 task: <span class="o">{</span> 
     2 sequential sub-tasks: <span class="o">{</span> 
         create IAM role <span class="k">for </span>serviceaccount <span class="s2">"kube-system/aws-load-balancer-controller"</span>,
         create serviceaccount <span class="s2">"kube-system/aws-load-balancer-controller"</span>,
     <span class="o">}</span> <span class="o">}</span>2022-01-28 13:32:16 <span class="o">[</span>ℹ]  building iamserviceaccount stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span>
 2022-01-28 13:32:16 <span class="o">[</span>ℹ]  deploying stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span>
 2022-01-28 13:32:16 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span>
 2022-01-28 13:32:34 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span>
 2022-01-28 13:32:53 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span>
 2022-01-28 13:32:54 <span class="o">[</span>ℹ]  created serviceaccount <span class="s2">"kube-system/aws-load-balancer-controller"</span>
</code></pre></div>    </div>
  </li>
  <li>Download the IAM policy. <br />
You can also download the <a href="/assets/blog/AWS/4_EKS/iam_policy_v1_to_v2_additional.json">iam_policy_v1_to_v2_additional.json</a>.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>curl <span class="nt">-o</span> iam_policy_v1_to_v2_additional.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.3.1/docs/install/iam_policy_v1_to_v2_additional.json 
</code></pre></div>    </div>
  </li>
  <li>Create the IAM policy and note the ARN that is returned. <br />
Please note that you don’t need to create the customer managed IAM policy if it already exists as below.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws iam create-policy <span class="se">\</span>
2   <span class="nt">--policy-name</span> AWSLoadBalancerControllerAdditionalIAMPolicy <span class="se">\</span>
3   <span class="nt">--policy-document</span> file://iam_policy_v1_to_v2_additional.json 
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> An error occurred <span class="o">(</span>EntityAlreadyExists<span class="o">)</span> when calling the CreatePolicy operation: A policy called AWSLoadBalancerControllerAdditionalIAMPolicy already exists. Duplicate names are not allowed.
</code></pre></div>    </div>
  </li>
  <li>Attach the IAM policy to the IAM role. <a name="role_aws_lbc"><br />
You can find the role name as follows:
</a>    <ul>
     <li>Open the AWS CloudFormation console</li>
     <li>Select the eksctl-your-cluster-name-addon-iamserviceaccount-kube-system-aws-load-balancer-controller stack.</li>
     <li>Click the Resources tab.</li>
     <li>The role name is in the Physical ID column. bag</li>
 </ul>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws iam attach-role-policy <span class="se">\</span>
2   <span class="nt">--role-name</span> eksctl-vujade-cluster-addon-iamserviceaccount-Role1-1ABC2D3E4FGHI <span class="se">\</span>
3   <span class="nt">--policy-arn</span> arn:aws:iam::123456789123:policy/AWSLoadBalancerControllerAdditionalIAMPolicy 
</code></pre></div>    </div>
  </li>
  <li>Add the eks-charts repository.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>helm repo add eks https://aws.github.io/eks-charts
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="s2">"eks"</span> has been added to your repositories
</code></pre></div>    </div>
  </li>
  <li>Update your local repo to make sure that you have the most recent charts.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>helm repo update
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Hang tight <span class="k">while </span>we grab the latest from your chart repositories...
 ...Successfully got an update from the <span class="s2">"eks"</span> chart repository
 ...Successfully got an update from the <span class="s2">"stable"</span> chart repository
 Update Complete. ⎈Happy Helming!⎈
</code></pre></div>    </div>
  </li>
  <li>Install the TargetGroupBinding CRDs.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-k</span> <span class="s2">"github.com/aws/eks-charts/stable/aws-load-balancer-controller/crds?ref=master"</span>
2 <span class="nv">$ </span>kubectl get crd 
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>customresourcedefinition.apiextensions.k8s.io/ingressclassparams.elbv2.k8s.aws created
customresourcedefinition.apiextensions.k8s.io/targetgroupbindings.elbv2.k8s.aws created
    
NAME                                         CREATED AT
eniconfigs.crd.k8s.amazonaws.com             2022-01-27T06:57:16Z
ingressclassparams.elbv2.k8s.aws             2022-01-28T13:59:28Z
securitygrouppolicies.vpcresources.k8s.aws   2022-01-27T06:57:19Z
targetgroupbindings.elbv2.k8s.aws            2022-01-28T13:59:28Z
</code></pre></div>    </div>
  </li>
  <li>Install the AWS Load Balancer Controller.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>helm <span class="nb">install </span>aws-load-balancer-controller eks/aws-load-balancer-controller <span class="se">\</span>
2   <span class="nt">-n</span> kube-system <span class="se">\</span>
3   <span class="nt">--set</span> <span class="nv">clusterName</span><span class="o">=</span>vujade-cluster <span class="se">\</span>
4   <span class="nt">--set</span> serviceAccount.create<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
5   <span class="nt">--set</span> serviceAccount.name<span class="o">=</span>aws-load-balancer-controller
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME: aws-load-balancer-controller
LAST DEPLOYED: Fri Jan 28 14:02:37 2022
NAMESPACE: kube-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
AWS Load Balancer controller installed!
</code></pre></div>    </div>
  </li>
  <li>Verify that the controller is installed.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get deployment <span class="nt">-n</span> kube-system aws-load-balancer-controller 
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
aws-load-balancer-controller   2/2     2            2           38s
</code></pre></div>    </div>
  </li>
</ol>
<hr />

<h2 id="8-how-to-install-a-metric-server-">8. How to install a metric server <a name="metric_server"></a></h2>
<p>You can install a metric server which is a scalable, efficient source of container resource metrics for Kubernetes
built-in autoscaling pipelines by executing following commands. You can get more information in the 
<a href="https://www.eksworkshop.com/beginner/080_scaling/deploy_hpa">Configure Horizontal Pod Autoscaler (HPA)</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.5.0/components.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    serviceaccount/metrics-server created
    clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
    clusterrole.rbac.authorization.k8s.io/system:metrics-server created
    rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
    clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
    clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
    service/metrics-server created
    deployment.apps/metrics-server created
    apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get apiservice v1beta1.metrics.k8s.io <span class="nt">-o</span> json | jq <span class="s1">'.status'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">{</span>
      <span class="s2">"conditions"</span>: <span class="o">[</span>
        <span class="o">{</span>
          <span class="s2">"lastTransitionTime"</span>: <span class="s2">"2022-01-28T14:15:04Z"</span>,
          <span class="s2">"message"</span>: <span class="s2">"all checks passed"</span>,
          <span class="s2">"reason"</span>: <span class="s2">"Passed"</span>,
          <span class="s2">"status"</span>: <span class="s2">"True"</span>,
          <span class="s2">"type"</span>: <span class="s2">"Available"</span>
        <span class="o">}</span>
      <span class="o">]</span>
    <span class="o">}</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get pods <span class="nt">-A</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAMESPACE     NAME                                           READY   STATUS    RESTARTS   AGE
    kube-system   aws-load-balancer-controller-cb56f956d-cmvh7   1/1     Running   0          13m
    kube-system   aws-load-balancer-controller-cb56f956d-d76rf   1/1     Running   0          13m
    kube-system   aws-node-frdxk                                 1/1     Running   0          31h
    kube-system   cluster-autoscaler-77d7c6c9b8-8bzck            1/1     Running   0          155m
    kube-system   coredns-6dbb778559-2dhqq                       1/1     Running   0          31h
    kube-system   coredns-6dbb778559-t4twm                       1/1     Running   0          31h
    kube-system   kube-proxy-glbbl                               1/1     Running   0          31h
    kube-system   metrics-server-6dfddc5fb8-zq97v                1/1     Running   0          111s
    kube-system   nvidia-device-plugin-daemonset-q2fbv           1/1     Running   0          31h
</code></pre></div></div>
<hr />

<h2 id="9-how-to-apply-a-namespace-">9. How to apply a namespace <a name="namespace"></a></h2>
<h5 id="1-preparations">1. Preparations</h5>
<p>You can check the <a href="/assets/blog/AWS/4_EKS/dev/namespace/namespace.yaml">namespace.yaml</a>.</p>

<h5 id="2-how-to-apply-a-namespace">2. How to apply a namespace</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> namespace.yaml 
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    namespace/ns-vujade created
</code></pre></div></div>

<h5 id="3-how-to-check-the-applied-namespace">3. How to check the applied namespace</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get namespace
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAME              STATUS   AGE
    default           Active   2d4h
    kube-node-lease   Active   2d4h
    kube-public       Active   2d4h
    kube-system       Active   2d4h
    ns-vujade         Active   50s
</code></pre></div></div>

<h5 id="4-how-to-delete-the-applied-namespace">4. How to delete the applied namespace</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> namespace.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    namespace <span class="s2">"ns-vujade"</span> deleted
</code></pre></div></div>

<hr />

<h2 id="10-how-to-apply-a-deployment-">10. How to apply a deployment <a name="deployment"></a></h2>
<h5 id="1-preparations-1">1. Preparations</h5>
<p>You can check the <a href="/assets/blog/AWS/4_EKS/dev/deployment/dep_dl.yaml">dep_dl.yaml</a>.</p>

<h5 id="2-how-to-apply-a-deployment">2. How to apply a deployment</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> deployment.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    deployment.apps/dep-dl created
</code></pre></div></div>

<h5 id="3-how-to-check-the-applied-deployment">3. How to check the applied deployment</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get deployment <span class="nt">-A</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAMESPACE     NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
    kube-system   aws-load-balancer-controller   2/2     2            2           21h
    kube-system   cluster-autoscaler             1/1     1            1           23h
    kube-system   coredns                        2/2     2            2           2d4h
    kube-system   metrics-server                 1/1     1            1           21h
    ns-vujade     dep-dl                         3/3     3            3           32s
</code></pre></div></div>

<h5 id="4-how-to-delete-the-applied-deployment">4. How to delete the applied deployment</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> deployment.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    deployment.apps <span class="s2">"dep-dl"</span> deleted
</code></pre></div></div>

<hr />

<h2 id="11-how-to-apply-a-service-">11. How to apply a service <a name="service"></a></h2>
<h5 id="1-preparations-2">1. Preparations</h5>
<p>You can check the <a href="/assets/blog/AWS/4_EKS/dev/service/svc_dl.yaml">svc_dl.yaml</a>.</p>

<h5 id="2-how-to-apply-a-service">2. How to apply a service</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> service.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    service/svc-dl created
</code></pre></div></div>

<h5 id="3-how-to-check-the-applied-service">3. How to check the applied service</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get service <span class="nt">-A</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAMESPACE     NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>           AGE
    default       kubernetes                          ClusterIP   172.20.0.1       &lt;none&gt;        443/TCP           2d4h
    kube-system   aws-load-balancer-webhook-service   ClusterIP   172.20.122.144   &lt;none&gt;        443/TCP           21h
    kube-system   kube-dns                            ClusterIP   172.20.0.10      &lt;none&gt;        53/UDP,53/TCP     2d4h
    kube-system   metrics-server                      ClusterIP   172.20.46.230    &lt;none&gt;        443/TCP           21h
    ns-vujade     svc-dl                              NodePort    172.20.205.201   &lt;none&gt;        11001:31803/TCP   15s
</code></pre></div></div>

<h5 id="4-how-to-delete-the-applied-service">4. How to delete the applied service</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> service.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    service <span class="s2">"svc-dl"</span> deleted
</code></pre></div></div>

<hr />

<h2 id="12-how-to-apply-a-horizontal-pod-autoscaler-hpa-">12. How to apply a horizontal pod autoscaler (HPA) <a name="hpa"></a></h2>
<h5 id="1-preparations-3">1. Preparations</h5>
<p>You can check the <a href="/assets/blog/AWS/4_EKS/dev/hpa/hpa_dl.yaml">hpa_dl.yaml</a>.</p>

<h5 id="2-how-to-apply-a-hpa">2. How to apply a HPA</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> hpa.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    horizontalpodautoscaler.autoscaling/hpa-dl created
</code></pre></div></div>

<h5 id="3-how-to-check-the-applied-hpa">3. How to check the applied HPA</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get hpa <span class="nt">-A</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAMESPACE   NAME     REFERENCE           TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
    ns-vujade   hpa-dl   Deployment/dep-dl   0%/65%    3         12        3          20s
</code></pre></div></div>

<h5 id="4-how-to-delete-the-applied-hpa">4. How to delete the applied HPA</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> hpa.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    horizontalpodautoscaler.autoscaling <span class="s2">"hpa-dl"</span> deleted
</code></pre></div></div>

<h5 id="5-how-does-the-hpa-work">5. How does the HPA work?</h5>
<p>The HPA is based on how many resources are being used compared to the requests allocated to the pod.
In other words, the condition for scale-out of pods by the HPA as follows:</p>

<p>\begin{equation}
\label{eq:cauchy-schwarz}
averageUtilization \le 100 * \frac{CPU_{Total}}{N_{Pod} \times CPU_{Request}}
\end{equation}</p>

<ul>
  <li><strong><em>CPU<sub>Total</sub></em></strong> is the total central processing unit (CPU) usage in a worker node.</li>
  <li><strong><em>N<sub>Pod</sub></em></strong> is the number of pod in a worker node.</li>
  <li><strong><em>CPU<sub>Request</sub></em></strong> is assigned in the deployment. It means minimum resources that the CPU must be guaranteed.
Please note that the CPU usage is controlled in units of milli-cores (i.e m) by the Kubernetes. A single CPU is
equivalent to 1m.</li>
</ul>

<hr />

<h2 id="13-how-to-apply-an-ingress-">13. How to apply an ingress <a name="ingress"></a></h2>
<h5 id="1-preparations-4">1. Preparations</h5>
<p>You can check the <a href="/assets/blog/AWS/4_EKS/dev/ingress/ingress.yaml">ingress.yaml</a>.</p>

<h5 id="2-how-to-apply-an-ingress">2. How to apply an ingress</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ingress.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ingress.extensions/alb-ing-eks-vujade created
</code></pre></div></div>

<h5 id="3-how-to-check-the-applied-ingress">3. How to check the applied ingress</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get ingress <span class="nt">-A</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAMESPACE   NAME                  CLASS    HOSTS   ADDRESS                                                                                PORTS   AGE
    ns-vujade   alb-ing-eks-vujade   &lt;none&gt;   <span class="k">*</span>       internal-k8s-nsvujade-albingea-1716e099f7-114012471.ap-northeast-2.elb.amazonaws.com   80      54s
</code></pre></div></div>

<h5 id="4-how-to-delete-the-applied-ingress">4. How to delete the applied ingress</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> ingress.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ingress.extensions <span class="s2">"alb-ing-eks-vujade"</span> deleted
</code></pre></div></div>

<hr />

<h2 id="14-useful-kubectl-commands-">14. Useful kubectl commands <a name="kubectl_commands"></a></h2>
<h5 id="1-how-to-list-nodes-in-details">1. How to list nodes in details</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get nodes <span class="nt">-A</span> <span class="nt">-o</span> wide
</code></pre></div></div>

<h5 id="2-how-to-list-pods-in-details">2. How to list pods in details</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get pods <span class="nt">-A</span> <span class="nt">-o</span> wide
</code></pre></div></div>

<h5 id="3-how-to-watch-logs-for-a-pod">3. How to watch logs for a pod</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl logs <span class="nt">-f</span> <span class="nt">--namespace</span> <span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span> <span class="k">${</span><span class="nv">NAME_POD</span><span class="k">}</span>
</code></pre></div></div>

<h5 id="4-how-to-execute-a-command-for-a-pod">4. How to execute a command for a pod</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">--namespace</span> <span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span> <span class="k">${</span><span class="nv">NAME_POD</span><span class="k">}</span> <span class="k">${</span><span class="nv">COMMAND</span><span class="k">}</span>
</code></pre></div></div>

<hr />

<h2 id="15-how-to-fix-error-">15. How to fix error <a name="fix_error"></a></h2>
<h5 id="1-cannot-create-a-node-group">1. Cannot create a node group</h5>
<p>When the node is deployed in a private subnet, the subnet must have a route to a NAT gateway where a public IP address is assigned.
<a href="/blog/2022/vpc/#route_table_nat">Amazon Virtual Private Cloud (VPC) - Section 10. How to set up a route table for the NAT gateway</a>.
The error messages are as follows.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    2022-01-18 08:32:14 <span class="o">[</span>✖]  unexpected status <span class="s2">"ROLLBACK_IN_PROGRESS"</span> <span class="k">while </span>waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-nodegroup-ng-dl"</span>
    2022-01-18 08:32:14 <span class="o">[</span>ℹ]  fetching stack events <span class="k">in </span>attempt to troubleshoot the root cause of the failure
    2022-01-18 08:32:14 <span class="o">[</span>✖]  AWS::EKS::Nodegroup/ManagedNodeGroup: CREATE_FAILED – <span class="s2">"Nodegroup ng-dl failed to stabilize: [{Code: NodeCreationFailure,Message: Instances failed to join the kubernetes cluster,ResourceIds: [i-0a12bc3d45e67fg8h]}]"</span>
    2022-01-18 08:32:14 <span class="o">[</span>ℹ]  1 error<span class="o">(</span>s<span class="o">)</span> occurred and nodegroups haven<span class="s1">'t been created properly, you may wish to check CloudFormation console
</span></code></pre></div></div>

<hr />

<h2 id="16-reference-">16. Reference <a name="ref"></a></h2>
<ol>
  <li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" title="Regions and Zones"> Regions and Zones</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes" title="What is Kubernetes?"> What is Kubernetes?</a></li>
  <li><a href="https://aws.amazon.com/eks/features" title="Amazon EKS features"> Amazon EKS features</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/clusters.html" title="Amazon EKS clusters"> Amazon EKS clusters</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-compute.html" title="Amazon EKS nodes"> Amazon EKS nodes</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html" title="Managed node groups"> Managed node groups</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/autoscaling.html" title="Autoscaling"> Autoscaling</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html" title="AWS Load Balancer Controller"> AWS Load Balancer Controller</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/metrics-server.html" title="Installing the Kubernetes Metrics Server"> Installing the Kubernetes Metrics Server</a></li>
  <li><a href="https://docs.aws.amazon.com/cloud-map/latest/dg/working-with-namespaces.html" title="Working with Namespaces"> Working with Namespaces</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment" title="Deployments"> Deployments</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/pods" title="Pods"> Pods</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset" title="ReplicaSet"> ReplicaSet</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/services-networking/service" title="Service"> Service</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale" title="Horizontal Pod Autoscaling"> Horizontal Pod Autoscaling</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset" title="StatefulSets"> StatefulSets</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress" title="Ingress"> Ingress</a></li>
</ol>

<hr />]]></content><author><name></name></author><category term="software" /><category term="aws," /><category term="eks" /><summary type="html"><![CDATA[Setting up the Amazon EKS]]></summary></entry><entry><title type="html">Amazon Web Services (AWS) Cloud9</title><link href="https://vujadeyoon.github.io/blog/2022/cloud9/" rel="alternate" type="text/html" title="Amazon Web Services (AWS) Cloud9" /><published>2022-01-27T00:00:00+00:00</published><updated>2022-01-27T00:00:00+00:00</updated><id>https://vujadeyoon.github.io/blog/2022/cloud9</id><content type="html" xml:base="https://vujadeyoon.github.io/blog/2022/cloud9/"><![CDATA[<h2 id="table-of-contents">Table of contents</h2>
<ol>
  <li><a href="#notice">Notice</a></li>
  <li><a href="#aws_cloud9">What is AWS Cloud9?</a></li>
  <li><a href="#iam_role">How to create an IAM role for an AWS cloud9 workspace</a></li>
  <li><a href="#cloud9_create">How to create an AWS cloud9</a></li>
  <li><a href="#cloud9_config">How to set configurations of the AWS cloud9</a></li>
  <li><a href="#utils_eks">How to install utilities for developing the Amazon EKS on the AWS cloud9</a></li>
  <li><a href="#aws_ssh">How to create and import a SSH key</a></li>
  <li><a href="#aws_cmk">How to create an AWS KMS custom managed key (CMK)</a></li>
  <li><a href="#ebs_resize">How to resize the Elastic Block Storage (EBS) volume</a></li>
  <li><a href="#fix_error">How to fix error</a></li>
  <li><a href="#ref">Reference</a></li>
</ol>

<hr />

<h2 id="1-notice-">1. Notice <a name="notice"></a></h2>
<ul>
  <li>A guide for setting the Amazon Web Services (AWS) Cloud9</li>
  <li>The name of region is Asia Pacific (Seoul) and the corresponding code is ap-northeast-2 [1].</li>
  <li>I recommend that you should ignore the commented instructions with an octothorpe, #.</li>
  <li>I recommend that you should fill in the appropriate letters between the parentheses, &lt;&gt;.</li>
</ul>

<hr />

<h2 id="2-what-is-aws-cloud9-">2. What is AWS Cloud9? <a name="aws_cloud9"></a></h2>
<p>AWS Cloud9 is a cloud-based integrated development environment (IDE) that lets you write, run, and debug your code with
just a browser. It includes a code editor, debugger, and terminal. Cloud9 comes prepackaged with essential tools for
popular programming languages, including JavaScript, Python, PHP, and more, so you don’t need to install files or
configure your development machine to start new projects [2].</p>

<hr />

<h2 id="3-how-to-create-an-iam-role-for-an-aws-cloud9-workspace-">3. How to create an IAM role for an AWS cloud9 workspace <a name="iam_role"></a></h2>
<p>You can create an Identity and Access Management (IAM) role on <a href="https://console.aws.amazon.com/iamv2/home#/roles">AWS IAM management console - Role</a>.
Fig. 1 shows how to create an IAM role and result of the created IAM role. You can refer to the AWS EKS workshop guide to
create an IAM role, <a href="https://www.eksworkshop.com/020_prerequisites/iamrole">Create an IAM role fol your workspace</a>.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_1_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_1_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_1_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_1_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_1_b-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_1_b-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_1_b-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_1_b.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 1. How to create an IAM role for an AWS cloud9 workspace.
</div>

<hr />

<h2 id="4-how-to-create-an-aws-cloud9-">4. How to create an AWS cloud9 <a name="cloud9_create"></a></h2>
<p>You can create an AWS cloud9 as shown in Fig. 2. There are two important things as follows: i) I recommend that you should
select a m5.large (8 GiB RAM + 2vCPU) instance among instance types; ii) You should select a public subnet. The options
for creating the AWS cloud9 as follows:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">No.</th>
      <th style="text-align: center">Environment type</th>
      <th style="text-align: center">Instance type</th>
      <th style="text-align: center">Platform</th>
      <th style="text-align: center">Cost-saving setting</th>
      <th style="text-align: center">Network (VPC)</th>
      <th style="text-align: center">Subnet</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">Create a new EC2 instance for environment (direct access)</td>
      <td style="text-align: center">m5.large (8 GiB RAM + 2vCPU)</td>
      <td style="text-align: center">Ubuntu Server 18.04 LTS</td>
      <td style="text-align: center">After 30 minutes (default)</td>
      <td style="text-align: center">Vujade_VPC</td>
      <td style="text-align: center">Vujade_public_a</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_2_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_2_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_2_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_2_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_2_b-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_2_b-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_2_b-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_2_b.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_2_c-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_2_c-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_2_c-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_2_c.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 2. How to create an AWS cloud9.
</div>

<hr />

<h2 id="5-how-to-set-configurations-of-the-aws-cloud9-">5. How to set configurations of the AWS cloud9 <a name="cloud9_config"></a></h2>
<p>You should set two configurations of the AWS cloud: i) Attaching the IAM role; ii) Disabling AWS managed temporary credentials.</p>
<ol>
  <li>Attaching the IAM role <br />
You can attach the IAM role which is created in the <a href="#iam_role">Section 3. How to create an IAM role for an AWS cloud9 workspace</a>
as shown in Fig. 3. You can refer to the AWS EKS workshop guide, <a href="https://www.eksworkshop.com/020_prerequisites/ec2instance">Attach the IAM role to your workspace</a>.</li>
  <li>Disabling AWS managed temporary credentials <br />
You can disable the AWS managed temporary credentials as shown in Fig. 4.</li>
</ol>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_3-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_3-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_3-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_3.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 3. How to attach the IAM role.
</div>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_4-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_4-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_4-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_4.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 4. How to disable AWS managed temporary credentials.
</div>

<hr />

<h2 id="6-how-to-install-utilities-for-developing-the-amazon-eks-on-the-aws-cloud9-">6. How to install utilities for developing the Amazon EKS on the AWS cloud9 <a name="utils_eks"></a></h2>
<p>You can easily install utilities for developing the Amazon EKS on the AWS cloud9 by executing <a href="/assets/blog/AWS/3_Cloud9/bash_install_utils_eks.sh">bash_install_utils_eks.sh</a>.
Please note that you should type a correct the name of the IAM role which is created in the <a href="#iam_role">Section 3. How to create an IAM role for an AWS cloud9 workspace</a>.
You can refer to the official guides [3]–[7].</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>bash bash_install_utils_eks.sh &lt;NAME_IAM_ROLE&gt;
</code></pre></div></div>
<details>
 <summary>&nbsp; bash_install_utils_eks.sh <a name="bash_install_utils_eks.sh"></a></summary>
 
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre></td><td class="code"><pre> <span class="c"># Dveloper: vujadeyoon</span>
 <span class="c"># Email: vujadeyoon@gmail.com</span>
 <span class="c"># Github: https://github.com/vujadeyoon</span>
 <span class="c"># Personal website: https://vujadeyoon.github.io</span>
 <span class="c">#</span>
 <span class="c"># Title: bash_install_utils_eks.sh</span>
 <span class="c"># Description: A bash script to install utilities for EKS.</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Set name of the created IAM role for the AWS cloud9.</span>
 <span class="nv">NAME_IAM_ROLE</span><span class="o">=</span><span class="nv">$1</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Installing utilities</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 <span class="nb">echo</span> <span class="s1">'Utilities'</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> yum
 <span class="nb">sudo </span>snap <span class="nb">install </span>yq
 <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> gettext bash-completion moreutils jq
 <span class="nb">sudo </span>pip <span class="nb">install</span> <span class="nt">--upgrade</span> awscli <span class="o">&amp;&amp;</span> <span class="nb">hash</span> <span class="nt">-r</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Environmnet configuration</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 <span class="nb">echo</span> <span class="s1">'Environment configuration'</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 <span class="nb">export </span><span class="nv">ACCOUNT_ID</span><span class="o">=</span><span class="si">$(</span>aws sts get-caller-identity <span class="nt">--output</span> text <span class="nt">--query</span> Account<span class="si">)</span>
 <span class="nb">export </span><span class="nv">AWS_REGION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> 169.254.169.254/latest/dynamic/instance-identity/document | jq <span class="nt">-r</span> <span class="s1">'.region'</span><span class="si">)</span>
 <span class="nb">test</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$AWS_REGION</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">echo </span>AWS_REGION is <span class="s2">"</span><span class="nv">$AWS_REGION</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">echo </span>AWS_REGION is not <span class="nb">set
 echo</span> <span class="s2">"export ACCOUNT_ID=</span><span class="k">${</span><span class="nv">ACCOUNT_ID</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">tee</span> <span class="nt">-a</span> ~/.bash_profile
 <span class="nb">echo</span> <span class="s2">"export AWS_REGION=</span><span class="k">${</span><span class="nv">AWS_REGION</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">tee</span> <span class="nt">-a</span> ~/.bash_profile
 aws configure <span class="nb">set </span>default.region <span class="k">${</span><span class="nv">AWS_REGION</span><span class="k">}</span>
 aws configure get default.region
 aws sts get-caller-identity <span class="nt">--query</span> Arn | <span class="nb">grep</span> <span class="k">${</span><span class="nv">NAME_IAM_ROLE</span><span class="k">}</span> <span class="nt">-q</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"IAM role valid"</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"IAM role NOT valid"</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Installing Elastic Load Balancing (ELB)</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 <span class="nb">echo</span> <span class="s1">'Elastic Load Balancing (ELB)'</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 aws iam get-role <span class="nt">--role-name</span> <span class="s2">"AWSServiceRoleForElasticLoadBalancing"</span> <span class="o">||</span> aws iam create-service-linked-role <span class="nt">--aws-service-name</span> <span class="s2">"elasticloadbalancing.amazonaws.com"</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Installing eksctl</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 <span class="nb">echo</span> <span class="s1">'EKSCTL'</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 curl <span class="nt">--silent</span> <span class="nt">--location</span> <span class="s2">"https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-s</span><span class="si">)</span><span class="s2">_amd64.tar.gz"</span> | <span class="nb">tar </span>xz <span class="nt">-C</span> /tmp
 <span class="nb">sudo mv</span> <span class="nt">-v</span> /tmp/eksctl /usr/local/bin
 eksctl completion bash <span class="o">&gt;&gt;</span> ~/.bash_completion
 <span class="nb">.</span> /etc/profile.d/bash_completion.sh
 <span class="nb">.</span> ~/.bash_completion
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Installing kubectl</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 <span class="nb">echo</span> <span class="s1">'KUBECTL'</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 <span class="nb">sudo </span>curl <span class="nt">--silent</span> <span class="nt">--location</span> <span class="nt">-o</span> /usr/local/bin/kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.17.11/2020-09-18/bin/linux/amd64/kubectl
 <span class="c">#</span>
 <span class="nb">sudo chmod</span> +x /usr/local/bin/kubectl
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Installing yq for yaml processing</span>
 <span class="nb">echo</span> <span class="s1">'yq() {
   docker run --rm -i -v "${PWD}":/workdir mikefarah/yq yq "$@"
 }'</span> | <span class="nb">tee</span> <span class="nt">-a</span> ~/.bashrc <span class="o">&amp;&amp;</span> <span class="nb">source</span> ~/.bashrc
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Verifying the binaries are in the path and executable</span>
 <span class="k">for </span><span class="nb">command </span><span class="k">in </span>kubectl jq envsubst aws
   <span class="k">do
     </span>which <span class="nv">$command</span> &amp;&gt;/dev/null <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$command</span><span class="s2"> in path"</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$command</span><span class="s2"> NOT FOUND"</span>
   <span class="k">done</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Enable kubectl bash_completion</span>
 kubectl completion bash <span class="o">&gt;&gt;</span>  ~/.bash_completion
 <span class="nb">.</span> /etc/profile.d/bash_completion.sh
 <span class="nb">.</span> ~/.bash_completion
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Set the AWS Load Balancer Controller version</span>
 <span class="nb">echo</span> <span class="s1">'export LBC_VERSION="v2.0.0"'</span> <span class="o">&gt;&gt;</span>  ~/.bash_profile
 <span class="nb">.</span>  ~/.bash_profile
 <span class="c">#</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 <span class="nb">echo</span> <span class="s1">'Helem'</span>
 <span class="nb">echo</span> <span class="s1">'============================================'</span>
 curl <span class="nt">-sSL</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
 helm version <span class="nt">--short</span>
 helm repo add stable https://charts.helm.sh/stable
 helm search repo stable
 helm completion bash <span class="o">&gt;&gt;</span> ~/.bash_completion
 <span class="nb">.</span> /etc/profile.d/bash_completion.sh
 <span class="nb">.</span> ~/.bash_completion
 <span class="nb">source</span> &lt;<span class="o">(</span>helm completion bash<span class="o">)</span>
 <span class="c">#</span>
 <span class="nb">echo</span> <span class="s1">'eksctl version is'</span> <span class="si">$(</span>eksctl version<span class="si">)</span>
 <span class="nb">echo</span> <span class="s1">'kubectl version is'</span> <span class="si">$(</span>kubectl version <span class="nt">--client</span> <span class="nt">--short</span><span class="si">)</span>
 
</pre></td></tr></tbody></table></code></pre></figure>

</details>

<hr />

<h2 id="7-how-to-create-and-import-a-ssh-key-">7. How to create and import a SSH key <a name="aws_ssh"></a></h2>
<p>Before proceeding with how to create and import a Secure Shell Protocol (SSH) key which can be used to create a cluster
and access a worker node in the Amazon EKS, I would like to point out that only a main developer for the Amazon EKS
should create and import the SSH key once. The other developer can use the SSH key that is shared from the main developer. 
You should follow two steps to create and import the SSH key as follows.</p>

<ol>
  <li>How to create the SSH key <br />
You can easily create the SSH key as below.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>ssh-keygen
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Generating public/private rsa key pair.
 Enter file <span class="k">in </span>which to save the key <span class="o">(</span>/home/ubuntu/.ssh/id_rsa<span class="o">)</span>: 
 Enter passphrase <span class="o">(</span>empty <span class="k">for </span>no passphrase<span class="o">)</span>: 
 Enter same passphrase again: 
 Your identification has been saved <span class="k">in</span> /home/ubuntu/.ssh/id_rsa.
 Your public key has been saved <span class="k">in</span> /home/ubuntu/.ssh/id_rsa.pub.
 The key fingerprint is:
 SHA256:R0r6qAcJ34PHBdS1m2ZrF2bgo+nUANwDPcECt0TUTvo ubuntu@ip-10-172-96-182
 The key<span class="s1">'s randomart image is:
 +---[RSA 3072]----+
 |    .=B=.o.      |
 |     +o+B  .     |
 |      +*+.+      |
 |  .   .+o= +     |
 |   o =.oS O +    |
 |    = =oEO = .   |
 |     o..= + .    |
 |     ..o . .     |
 |    ..  .        |
 +----[SHA256]-----+
</span></code></pre></div>    </div>
  </li>
  <li>How to import the created SSH key <br />
You can import the created SSH key as below. Please note that you can replace the <em>vujade-eks</em> with the name that you want.
In this case, The <em>vujade-eks</em> is used as SSH key name. You can get more information
<a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/import-key-pair.html">AWS CLI Command Reference - import-key-pair</a>
in details.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws ec2 import-key-pair <span class="nt">--key-name</span> vujade-eks <span class="nt">--public-key-material</span> file://~/.ssh/id_rsa.pub
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">{</span>
     <span class="s2">"KeyName"</span>: <span class="s2">"vujade-eks"</span>,
     <span class="s2">"KeyFingerprint"</span>: <span class="s2">"1f:51:ae:28:bf:89:e9:d8:1f:25:5d:37:2d:7d:b8:ca"</span>,
     <span class="s2">"KeyPairId"</span>: <span class="s2">"key-1g15s88175abcd1aa"</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>How to import the shared SSH key to a new AWS Cloud9 instance<br />
Please note that you must keep an original key which is located in ~/.aws/authorized_keys. If you lose the information,
you cannot access the AWS Cloud9. Thus, you follow below instructions carefully to keep the original authorized key.
    <ul>
      <li>Copy the shared ~/.ssh/id_rsa.</li>
      <li>Copy the shared ~/.ssh/id_rsa.pub.</li>
      <li>Add the key in the shared ~/.ssh/authorized_keys to the ~/.ssh/authorized_keys for the new AWS Cloud instance.</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="8-how-to-create-an-aws-kms-custom-managed-key-cmk-">8. How to create an AWS KMS custom managed key (CMK) <a name="aws_cmk"></a></h2>
<p>Like creating and importing the SSH key in the <a href="#aws_ssh">Section 7. How to create and import a SSH key</a>, only a main
developer for the Amazon EKS should create a CMK once. The other developer can use the CMK that is shared from the main
developer.</p>

<ol>
  <li>How to create the CMK <a name="aws_cmk_create"><br />
You can crate the CMK as below. Please note that you can replace the <em>vujade-eks</em> with the name that you want.
In this case, The <em>vujade-eks</em> is used as CMK key name. Please note that you can check your own account ID number from
the result. In this case, the account ID is <em>123456789123</em>.
</a>    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws kms create-alias <span class="nt">--alias-name</span> <span class="nb">alias</span>/vujade-eks <span class="nt">--target-key-id</span> <span class="si">$(</span>aws kms create-key <span class="nt">--query</span> KeyMetadata.Arn <span class="nt">--output</span> text<span class="si">)</span>
2 <span class="nv">$ </span><span class="nb">export </span><span class="nv">MASTER_ARN</span><span class="o">=</span><span class="si">$(</span>aws kms describe-key <span class="nt">--key-id</span> <span class="nb">alias</span>/vujade-eks <span class="nt">--query</span> KeyMetadata.Arn <span class="nt">--output</span> text<span class="si">)</span>
3 <span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export MASTER_ARN=</span><span class="k">${</span><span class="nv">MASTER_ARN</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">tee</span> <span class="nt">-a</span> ~/.bash_profile
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">export </span><span class="nv">MASTER_ARN</span><span class="o">=</span>arn:aws:kms:ap-northeast-2:123456789123:key/a0b1234c-de5f-6789-g01h-2i3456j789k0
</code></pre></div>    </div>
  </li>
  <li>How to check the created CMK <br />
You can check the created CMK by executing below command. You can get CMK key ID from the <a href="#aws_cmk_create">Section 8-1. How to create the CMK</a>.
In this case, the CMK key ID is <em>a0b1234c-de5f-6789-g01h-2i3456j789k0</em>.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws kms list-aliases <span class="nt">--key-id</span> a0b1234c-de5f-6789-g01h-2i3456j789k0
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">{</span>
     <span class="s2">"Aliases"</span>: <span class="o">[</span>
         <span class="o">{</span>
             <span class="s2">"AliasArn"</span>: <span class="s2">"arn:aws:kms:ap-northeast-2:123456789123:alias/vujade-eks"</span>,
             <span class="s2">"CreationDate"</span>: 1642430327.096,
             <span class="s2">"AliasName"</span>: <span class="s2">"alias/vujade-eks"</span>,
             <span class="s2">"LastUpdatedDate"</span>: 1642430327.096,
             <span class="s2">"TargetKeyId"</span>: <span class="s2">"a0b1234c-de5f-6789-g01h-2i3456j789k0"</span>
         <span class="o">}</span>
     <span class="o">]</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>How to get the AWS account ID <br />
You can also get the AWS account ID as follows.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws sts get-caller-identity <span class="nt">--query</span> Account <span class="nt">--output</span> text
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 123456789123
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<h2 id="9-how-to-resize-the-elastic-block-storage-ebs-volume-">9. How to resize the Elastic Block Storage (EBS) volume <a name="ebs_resize"></a></h2>
<p>You should resize the EBS of the Amazon Elastic Compute Cloud (Amazon EC2) on the <a href="https://ap-northeast-2.console.aws.amazon.com/ec2/v2">EC2 dashboard</a>
as shown in Fig. 5.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_5_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_5_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_5_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_5_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_5_b-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_5_b-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_5_b-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_5_b.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 5. How to resize the EBS volume.
</div>

<p>After you resize the EBS, you should follow below steps to apply the resized EBS.
You can check the name of target disk of which size is resized volume. In this case, the name of target block device is <em>nvme0n1</em>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>lsblk
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
    loop0         7:0    0  43.3M  1 loop /snap/snapd/14295
    loop1         7:1    0    25M  1 loop /snap/amazon-ssm-agent/4046
    loop2         7:2    0  99.4M  1 loop /snap/core/11993
    loop3         7:3    0  55.5M  1 loop /snap/core18/2253
    loop4         7:4    0  55.5M  1 loop /snap/core18/2284
    loop5         7:5    0  43.4M  1 loop /snap/snapd/14549
    loop6         7:6    0 110.5M  1 loop /snap/core/12603
    loop7         7:7    0   4.7M  1 loop /snap/yq/1515
    nvme0n1     259:0    0   100G  0 disk
    └─nvme0n1p1 259:1    0    10G  0 part /
</code></pre></div></div>

<p>Then you can grow partition as below.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>growpart /dev/nvme0n1 1
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    CHANGED: <span class="nv">partition</span><span class="o">=</span>1 <span class="nv">start</span><span class="o">=</span>2048 old: <span class="nv">size</span><span class="o">=</span>20969439 <span class="nv">end</span><span class="o">=</span>20971487 new: <span class="nv">size</span><span class="o">=</span>209713119,end<span class="o">=</span>209715167
</code></pre></div></div>

<p>You can resize the filesystem after checking the filesystem name. In this case, the filesystem name is <em>/dev/nvme0n1p1</em>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">df</span> <span class="nt">-h</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Filesystem      Size  Used Avail Use% Mounted on
    udev            3.8G     0  3.8G   0% /dev
    tmpfs           767M  800K  766M   1% /run
    /dev/nvme0n1p1  9.7G  9.0G  658M  94% /
    tmpfs           3.8G     0  3.8G   0% /dev/shm
    tmpfs           5.0M     0  5.0M   0% /run/lock
    tmpfs           3.8G     0  3.8G   0% /sys/fs/cgroup
    /dev/loop0       44M   44M     0 100% /snap/snapd/14295
    /dev/loop1       25M   25M     0 100% /snap/amazon-ssm-agent/4046
    /dev/loop2      100M  100M     0 100% /snap/core/11993
    /dev/loop3       56M   56M     0 100% /snap/core18/2253
    tmpfs           767M     0  767M   0% /run/user/1000
    /dev/loop4       56M   56M     0 100% /snap/core18/2284
    /dev/loop5       44M   44M     0 100% /snap/snapd/14549
    /dev/loop6      111M  111M     0 100% /snap/core/12603
    /dev/loop7      4.8M  4.8M     0 100% /snap/yq/1515
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>resize2fs /dev/nvme0n1p1
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    resize2fs 1.44.1 <span class="o">(</span>24-Mar-2018<span class="o">)</span>
    Filesystem at /dev/nvme0n1p1 is mounted on /<span class="p">;</span> on-line resizing required
    old_desc_blocks <span class="o">=</span> 2, new_desc_blocks <span class="o">=</span> 13
    The filesystem on /dev/nvme0n1p1 is now 26214139 <span class="o">(</span>4k<span class="o">)</span> blocks long.
</code></pre></div></div>

<p>Finally, you can check the resized EBS as below.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>lsblk
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
    loop0         7:0    0  43.3M  1 loop /snap/snapd/14295
    loop1         7:1    0    25M  1 loop /snap/amazon-ssm-agent/4046
    loop2         7:2    0  99.4M  1 loop /snap/core/11993
    loop3         7:3    0  55.5M  1 loop /snap/core18/2253
    loop4         7:4    0  55.5M  1 loop /snap/core18/2284
    loop5         7:5    0  43.4M  1 loop /snap/snapd/14549
    loop6         7:6    0 110.5M  1 loop /snap/core/12603
    loop7         7:7    0   4.7M  1 loop /snap/yq/1515
    nvme0n1     259:0    0   100G  0 disk
    └─nvme0n1p1 259:1    0   100G  0 part /
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">df</span> <span class="nt">-h</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Filesystem      Size  Used Avail Use% Mounted on
    udev            3.8G     0  3.8G   0% /dev
    tmpfs           767M  800K  766M   1% /run
    /dev/nvme0n1p1   97G  9.0G   88G  10% /
    tmpfs           3.8G     0  3.8G   0% /dev/shm
    tmpfs           5.0M     0  5.0M   0% /run/lock
    tmpfs           3.8G     0  3.8G   0% /sys/fs/cgroup
    /dev/loop0       44M   44M     0 100% /snap/snapd/14295
    /dev/loop1       25M   25M     0 100% /snap/amazon-ssm-agent/4046
    /dev/loop2      100M  100M     0 100% /snap/core/11993
    /dev/loop3       56M   56M     0 100% /snap/core18/2253
    tmpfs           767M     0  767M   0% /run/user/1000
    /dev/loop4       56M   56M     0 100% /snap/core18/2284
    /dev/loop5       44M   44M     0 100% /snap/snapd/14549
    /dev/loop6      111M  111M     0 100% /snap/core/12603
    /dev/loop7      4.8M  4.8M     0 100% /snap/yq/1515
</code></pre></div></div>

<hr />

<h2 id="10-how-to-fix-error-">10. How to fix error <a name="fix_error"></a></h2>
<h5 id="1-cannot-access-the-aws-cloud9-instance">1. Cannot access the AWS Cloud9 instance</h5>
<p>The VPC must have a public subnet. (A subnet is public if its traffic is routed to an internet gateway.) If you’re using
a public subnet, attach an internet gateway to the VPC so the SSM Agent for the instance can connect to Systems Manager.
If you’re using a private subnet, allow the instance for the subnet to communicate with the internet by hosting a NAT
gateway in a public subnet [8].
If you cannot access the AWS Cloud9 instance as shown in Fig. 6, you can check the subnet in the
<a href="/blog/2022/vpc/#route_table_ig">Amazon Virtual Private Cloud (VPC) - Section 7. How to set up a route table for the internet gateway</a>.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_6-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_6-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_6-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_6.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 6. No response for the AWS Cloud9.
</div>

<h5 id="2-cannot-access-the-aws-cloud9-instance">2. Cannot access the AWS Cloud9 instance</h5>
<p>If you lose an original authorized key which is located in ~/.aws/authorized_keys, you can never access the AWS Cloud
instance as shown in Fig. 7. In this case, I recommend you terminate the Cloud9 instance and create a new one.
You can get more information in the <a href="#aws_ssh">Section 7. How to create and import a SSH key</a>.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/3_Cloud9/fig_7-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/3_Cloud9/fig_7-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/3_Cloud9/fig_7-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/3_Cloud9/fig_7.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 7. No response for the AWS Cloud9.
</div>

<hr />

<h2 id="11-reference-">11. Reference <a name="ref"></a></h2>
<ol>
  <li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" title="Regions and Zones"> Regions and Zones</a></li>
  <li><a href="https://aws.amazon.com/cloud9" title="AWS Cloud9"> AWS Cloud9</a></li>
  <li><a href="https://www.eksworkshop.com/020_prerequisites/workspaceiam" title="Update IAM settings for your workspace"> Update IAM settings for your workspace</a></li>
  <li><a href="https://www.eksworkshop.com/beginner/050_deploy/servicerole" title="Ensure the ELB service role exists"> Ensure the ELB service role exists</a></li>
  <li><a href="https://www.eksworkshop.com/030_eksctl/prerequisites" title="Prerequisites"> Prerequisites</a></li>
  <li><a href="https://www.eksworkshop.com/020_prerequisites/k8stools" title="Install kubernetes tools"> Install kubernetes tools</a></li>
  <li><a href="https://www.eksworkshop.com/beginner/060_helm/helm_intro/install" title="Install HELM CLI"> Install HELM CLI</a></li>
  <li><a href="https://docs.aws.amazon.com/cloud9/latest/user-guide/vpc-settings.html" title="Amazon VPC requirements for AWS Cloud9"> Amazon VPC requirements for AWS Cloud9</a></li>
</ol>

<hr />]]></content><author><name></name></author><category term="software" /><category term="aws" /><summary type="html"><![CDATA[Setting up the AWS Cloud9]]></summary></entry><entry><title type="html">Amazon Virtual Private Cloud (VPC)</title><link href="https://vujadeyoon.github.io/blog/2022/vpc/" rel="alternate" type="text/html" title="Amazon Virtual Private Cloud (VPC)" /><published>2022-01-26T00:00:00+00:00</published><updated>2022-01-26T00:00:00+00:00</updated><id>https://vujadeyoon.github.io/blog/2022/vpc</id><content type="html" xml:base="https://vujadeyoon.github.io/blog/2022/vpc/"><![CDATA[<h2 id="table-of-contents">Table of contents</h2>
<ol>
  <li><a href="#notice">Notice</a></li>
  <li><a href="#amazon_vpc">What is Amazon VPC?</a></li>
  <li><a href="#region">AWS region</a></li>
  <li><a href="#vpc">How to create a VPC</a></li>
  <li><a href="#subnet">How to set up subnets</a></li>
  <li><a href="#internet_gateway">How to set up an internet gateway</a></li>
  <li><a href="#route_table_ig">How to set up a route table for the internet gateway</a></li>
  <li><a href="#elastic_ip">How to allocate an elastic IP address</a></li>
  <li><a href="#nat">How to set up a NAT gateway</a></li>
  <li><a href="#route_table_nat">How to set up a route table for the NAT gateway</a></li>
  <li><a href="#ref">Reference</a></li>
</ol>

<hr />

<h2 id="1-notice-">1. Notice <a name="notice"></a></h2>
<ul>
  <li>A guide for setting the Amazon Virtual Private Cloud (Amazon VPC)</li>
  <li>The name of region is Asia Pacific (Seoul) and the corresponding code is ap-northeast-2 [1].</li>
  <li>I refer to the Amazon VPC as VPC.</li>
  <li>I recommend that you should ignore the commented instructions with an octothorpe, #.</li>
  <li>I recommend that you should fill in the appropriate letters between the parentheses, &lt;&gt;.</li>
</ul>

<hr />

<h2 id="2-what-is-amazon-vpc-">2. What is Amazon VPC? <a name="amazon_vpc"></a></h2>
<p>Amazon VPC enables you to launch Amazon Web Services resources into a virtual network you’ve defined. This virtual network
resembles a traditional network that you’d operate in your own data center, with the benefits of using the scalable
infrastructure of AWS [2]. You can check the Amazon VPC in details on the
<a href="https://docs.aws.amazon.com/toolkit-for-visual-studio/latest/user-guide/vpc-tkv.html">Amazon Virtual Private Cloud (VPC)</a> [2].</p>

<p>Among the components of the VPC [3], we should set up the following components for the
<a href="https://aws.amazon.com/eks">Amazon Elastic Kubernetes Service (EKS)</a></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">No.</th>
      <th style="text-align: center">Component</th>
      <th style="text-align: center">Definition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center"><a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html">Virtual private cloud (VPC) [3]</a></td>
      <td style="text-align: center">A virtual network dedicated to your AWS account.</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center"><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html">Subnet</a></td>
      <td style="text-align: center">A range of IP addresses in your VPC.</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center"><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html">Route table</a></td>
      <td style="text-align: center">A set of rules, called routes, that are used to determine where network traffic is directed.</td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: center"><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Internet_Gateway.html">Internet gateway</a></td>
      <td style="text-align: center">A gateway that you attach to your VPC to enable communication between resources in your VPC and the internet.</td>
    </tr>
    <tr>
      <td style="text-align: center">5</td>
      <td style="text-align: center"><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html">Elastic IP</a></td>
      <td style="text-align: center">An Elastic IP address is a static IPv4 address designed for dynamic cloud computing.</td>
    </tr>
    <tr>
      <td style="text-align: center">6</td>
      <td style="text-align: center"><a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html">NAT gateway</a></td>
      <td style="text-align: center">A managed AWS service that allows Amazon Elastic Compute Cloud (EC2) instances in private subnets to connect to the internet, other VPCs, or on-premises networks.</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="3-aws-region-">3. AWS region <a name="region"></a></h2>
<p>As far as I mentioned in the Section <a href="#notice">1. Notice</a>, please note that the region and corresponding code are as follows:</p>
<ul>
  <li>Region: Asia Pacific (Seoul)</li>
  <li>Code: ap-northeast-2</li>
</ul>

<p>You can find more information about the regions and zones on the <a href="#https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">Regions and Zones [1]</a>.</p>

<hr />

<h2 id="4-how-to-create-a-vpc-">4. How to create a VPC <a name="vpc"></a></h2>
<p>You can create a VPC on the <a href="https://ap-northeast-2.console.aws.amazon.com/vpc/home?region=ap-northeast-2#vpcs:">Your VPCs</a> as shown in Fig. 1. 
You can define the name of VPC that will be created at the <code class="language-plaintext highlighter-rouge">Name tag - optional</code>. When you type text in the <code class="language-plaintext highlighter-rouge">Name tag - optional</code>,
the <code class="language-plaintext highlighter-rouge">Value - optional</code> field will automatically be filled with the same text. In this case,
I use the <code class="language-plaintext highlighter-rouge">Name tag - optional</code> and <code class="language-plaintext highlighter-rouge">IPv4 CIDR</code> for the created VPC as Vujade_VPC and 10.172.0.0/16, respectively.</p>

<p>Please note that you can add additional tag for the older version of the cluster [4] as follows. In this case, the tag is not required
because the considered version of the cluster is 2.21.</p>
<ul>
  <li>Key: kubernetes.io/cluster/<em>&lt;cluster-name&gt;</em></li>
  <li>Value: shared</li>
</ul>

<div class="row mt-30">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/1_VPC/fig_1-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/1_VPC/fig_1-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/1_VPC/fig_1-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/1_VPC/fig_1.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 1. Create a VPC.
</div>

<hr />

<h2 id="5-how-to-set-up-subnets-">5. How to set up subnets <a name="subnet"></a></h2>

<p>I recommend you should create public and private subnets. Please note that the data plane and management plane of
the Amazon EKS are on the private subnets. Before proceeding with how to set up subnets, I would like to point out two
important things:</p>
<ul>
  <li>Amazon EC2 instance type in availability zone</li>
  <li>Tagging for load balancers or ingress controllers in the Amazon EKS</li>
</ul>

<p>Some availability zones do not support particular instance types. Thus, if you receive the error “Your requested instance
type is not supported in your requested Availability Zone”, you should determine which availability zones support your
instance type [5]. In this case, a g4dn.xlarge instance is supported in ap-northeast-2a and ap-northeast-2c.</p>
<ul>
  <li>EC2 instance type: g4dn.xlarge</li>
  <li>Region: Asia Pacific (Seoul), ap-northeast-2</li>
  <li>Availability zone: A and C</li>
</ul>

<p>Please note that you should create a new tag if you hope to use load balancers or ingress controllers in the Amazon EKS [6].
In other words, the key and value for the tag are as follows:</p>
<ul>
  <li>key: kubernetes.io/role/internal-elb</li>
  <li>value: 1</li>
</ul>

<p>Fig 2 shows configurations for creating public subnet and private subnets for the data and management plane.
Please note that subnets for the data plane have additional tag that is mentioned above.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_b-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_b-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_b-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_b.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_c-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_c-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_c-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/2_Subnet/fig_2_c.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 2. Configurations for public and private subnets.
</div>

<p>The entire subnet configurations are as follows:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">No.</th>
      <th style="text-align: center">Kinds</th>
      <th style="text-align: center">VPC ID</th>
      <th style="text-align: center">Subnet name</th>
      <th style="text-align: center">Availability Zone</th>
      <th style="text-align: center">IPv4 CIDR block</th>
      <th style="text-align: center">Tags</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">Public</td>
      <td style="text-align: center">vpc-000d67a73829a5e11 (Vujade_VPC)</td>
      <td style="text-align: center">Vujade_public_a</td>
      <td style="text-align: center">Asia Pacific (Seoul) / ap-northeast-2a</td>
      <td style="text-align: center">10.172.96.128/26</td>
      <td style="text-align: center">Name: Vujade_public_a</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">Public</td>
      <td style="text-align: center">vpc-000d67a73829a5e11 (Vujade_VPC)</td>
      <td style="text-align: center">Vujade_public_b</td>
      <td style="text-align: center">Asia Pacific (Seoul) / ap-northeast-2b</td>
      <td style="text-align: center">10.172.96.192/26</td>
      <td style="text-align: center">Name: Vujade_public_b</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center">Public</td>
      <td style="text-align: center">vpc-000d67a73829a5e11 (Vujade_VPC)</td>
      <td style="text-align: center">Vujade_public_c</td>
      <td style="text-align: center">Asia Pacific (Seoul) / ap-northeast-2c</td>
      <td style="text-align: center">10.172.98.0/26</td>
      <td style="text-align: center">Name: Vujade_public_c</td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: center">Private (Data plane)</td>
      <td style="text-align: center">vpc-000d67a73829a5e11 (Vujade_VPC)</td>
      <td style="text-align: center">Vujade_EKS_data_plane_a</td>
      <td style="text-align: center">Asia Pacific (Seoul) / ap-northeast-2a</td>
      <td style="text-align: center">10.172.92.0/23</td>
      <td style="text-align: center">Name: Vujade_EKS_data_plane_a; kubernetes.io/role/internal-elb: 1</td>
    </tr>
    <tr>
      <td style="text-align: center">5</td>
      <td style="text-align: center">Private (Data plane)</td>
      <td style="text-align: center">vpc-000d67a73829a5e11 (Vujade_VPC)</td>
      <td style="text-align: center">Vujade_EKS_data_plane_c</td>
      <td style="text-align: center">Asia Pacific (Seoul) / ap-northeast-2c</td>
      <td style="text-align: center">10.172.94.0/23</td>
      <td style="text-align: center">Name: Vujade_EKS_data_plane_c; kubernetes.io/role/internal-elb: 1</td>
    </tr>
    <tr>
      <td style="text-align: center">6</td>
      <td style="text-align: center">Private (Management plane)</td>
      <td style="text-align: center">vpc-000d67a73829a5e11 (Vujade_VPC)</td>
      <td style="text-align: center">Vujade_EKS_management_plane_a</td>
      <td style="text-align: center">Asia Pacific (Seoul) / ap-northeast-2a</td>
      <td style="text-align: center">10.172.96.0/27</td>
      <td style="text-align: center">Name: Vujade_EKS_management_plane_a</td>
    </tr>
    <tr>
      <td style="text-align: center">7</td>
      <td style="text-align: center">Private (Management plane)</td>
      <td style="text-align: center">vpc-000d67a73829a5e11 (Vujade_VPC)</td>
      <td style="text-align: center">Vujade_EKS_management_plane_b</td>
      <td style="text-align: center">Asia Pacific (Seoul) / ap-northeast-2b</td>
      <td style="text-align: center">10.172.96.32/27</td>
      <td style="text-align: center">Name: Vujade_EKS_management_plane_b</td>
    </tr>
    <tr>
      <td style="text-align: center">8</td>
      <td style="text-align: center">Private (Management plane)</td>
      <td style="text-align: center">vpc-000d67a73829a5e11 (Vujade_VPC)</td>
      <td style="text-align: center">Vujade_EKS_management_plane_c</td>
      <td style="text-align: center">Asia Pacific (Seoul) / ap-northeast-2c</td>
      <td style="text-align: center">10.172.96.64/27</td>
      <td style="text-align: center">Name: Vujade_EKS_management_plane_c</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="6-how-to-set-up-an-internet-gateway-">6. How to set up an internet gateway <a name="internet_gateway"></a></h2>

<p>You should create an internet gateway for public subnets as shown in Fig. 3.
Please note that you should attach the created internet gateway to the corresponding VPC.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_b-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_b-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_b-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_b.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_c-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_c-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_c-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/3_InternetGateway/fig_3_c.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 3. How to set up an internet gateway.
</div>

<hr />

<h2 id="7-how-to-set-up-a-route-table-for-the-internet-gateway-">7. How to set up a route table for the internet gateway <a name="route_table_ig"></a></h2>

<p>Please note that you should set up two route tables for an internet gateway and a Network Address Translation (NAT)
gateway which corresponds to public and private subnets, respectively.
In this section, I introduce how to set up a route table for the created internet gateway. The way to install a route
table for the NAT gateway is addressed in the <a href="#route_table_nat">Section 10. How to set up a route table for the NAT gateway</a>.</p>

<p>Fig. 4 shows how to set up a route table for the internet gateway. You should edit route tables and subnet associations
after creating the route table.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_b-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_b-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_b-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_b.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_c-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_c-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_c-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/4_RouteTable_IG/fig_4_c.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 4. How to set up a route table for the internet gateway.
</div>

<h2 id="8-how-to-allocate-an-elastic-ip-address-">8. How to allocate an elastic IP address <a name="elastic_ip"></a></h2>

<p>You should allocate an elastic IP address that is required when creating a NAT gateway in the <a href="#route_table_nat">Section 10. How to set up a route table for the NAT gateway</a>.
I recommend that you should modify the name of the allocated elastic IP address after getting the elastic IP address as shown in Fig. 5.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/5_ElasticIP/fig_5_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/5_ElasticIP/fig_5_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/5_ElasticIP/fig_5_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/5_ElasticIP/fig_5_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/5_ElasticIP/fig_5_b-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/5_ElasticIP/fig_5_b-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/5_ElasticIP/fig_5_b-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/5_ElasticIP/fig_5_b.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 5. How to allocate an elastic IP address.
</div>

<hr />

<h2 id="9-how-to-set-up-a-nat-gateway-">9. How to set up a NAT gateway <a name="nat"></a></h2>

<p>You can easily set up a NAT gateway as shown in Fig. 6. I recommend that you should set a subnet and an elastic IP allocation ID to the created resources.
Especially, the recommend subnet is a public subnet in the availability zone A.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/6_NAT/fig_6_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/6_NAT/fig_6_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/6_NAT/fig_6_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/6_NAT/fig_6_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 6. How to set up a NAT gateway.
</div>

<hr />

<h2 id="10-how-to-set-up-a-route-table-for-the-nat-gateway-">10. How to set up a route table for the NAT gateway <a name="route_table_nat"></a></h2>

<p>A route table for the NAT gateway has been already created. Thus, you can first find the created route table for the NAT gateway with
the name of the VPC field. After finding the created route table, you can change the name of the route table and should
edit route table as shown in Fig. 7.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/7_RouteTable_NAT/fig_7_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/7_RouteTable_NAT/fig_7_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/7_RouteTable_NAT/fig_7_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/7_RouteTable_NAT/fig_7_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/2_VPC/7_RouteTable_NAT/fig_7_b-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/2_VPC/7_RouteTable_NAT/fig_7_b-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/2_VPC/7_RouteTable_NAT/fig_7_b-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/2_VPC/7_RouteTable_NAT/fig_7_b.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 7. How to set up a route table for the NAT gateway.
</div>

<hr />

<h2 id="11-reference-">11. Reference <a name="ref"></a></h2>
<ol>
  <li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" title="Regions and Zones"> Regions and Zones</a></li>
  <li><a href="https://docs.aws.amazon.com/toolkit-for-visual-studio/latest/user-guide/vpc-tkv.html" title="Amazon Virtual Private Cloud (VPC)"> Amazon Virtual Private Cloud (VPC)</a></li>
  <li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html" title="What is Amazon VPC?"> What is Amazon VPC?</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/network_reqs.html" title="Cluster VPC and subnet considerations - Subnet tagging"> Cluster VPC and subnet considerations - Subnet tagging</a></li>
  <li><a href="https://aws.amazon.com/premiumsupport/knowledge-center/ec2-instance-type-not-supported-az-error" title="Why am I receiving the error, Your requested instance type is not supported in your requested Availability Zone, when launching an EC2 instance?"> Why am I receiving the error, Your requested instance type is not supported in your requested Availability Zone, when launching an EC2 instance?</a></li>
  <li><a href="https://aws.amazon.com/premiumsupport/knowledge-center/eks-vpc-subnet-discovery" title="How can I tag the Amazon VPC subnets in my Amazon EKS cluster for automatic subnet discovery by load balancers or ingress controllers?"> How can I tag the Amazon VPC subnets in my Amazon EKS cluster for automatic subnet discovery by load balancers or ingress controllers?</a></li>
</ol>

<hr />]]></content><author><name></name></author><category term="software" /><category term="aws," /><category term="network" /><summary type="html"><![CDATA[The configurations of the Amazon VPC for Amazon Elastic Kubernetes Service (EKS)]]></summary></entry><entry><title type="html">AWS Identity and Access Management (IAM)</title><link href="https://vujadeyoon.github.io/blog/2022/iam/" rel="alternate" type="text/html" title="AWS Identity and Access Management (IAM)" /><published>2022-01-23T00:00:00+00:00</published><updated>2022-01-23T00:00:00+00:00</updated><id>https://vujadeyoon.github.io/blog/2022/iam</id><content type="html" xml:base="https://vujadeyoon.github.io/blog/2022/iam/"><![CDATA[<h2 id="table-of-contents">Table of contents</h2>
<ol>
  <li><a href="#notice">Notice</a></li>
  <li><a href="#aim">What is IAM?</a></li>
  <li><a href="#iam_dashboard">How to open IAM dashboard</a></li>
  <li><a href="#iam_add">How to add an IAM user</a></li>
  <li><a href="#ref">Reference</a></li>
</ol>

<hr />

<h2 id="1-notice-">1. Notice <a name="notice"></a></h2>
<ul>
  <li>A guide for adding an IAM user</li>
  <li>The name of region is Asia Pacific (Seoul) and the corresponding code is ap-northeast-2 [1].</li>
  <li>I recommend that you should ignore the commented instructions with an octothorpe, #.</li>
  <li>I recommend that you should fill in the appropriate letters between the parentheses, &lt;&gt;.</li>
</ul>

<hr />

<h2 id="2-what-is-iam-">2. What is IAM? <a name="iam"></a></h2>
<p>The AWS Identity and Access Management (IAM) is a web service that helps you securely control access to AWS resources.
You use IAM to control who is authenticated (signed in) and authorized (has permissions) to use resources [2].
You can check the IAM in details on the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html">What is IAM?</a> [2].</p>

<hr />

<h2 id="3-how-to-open-iam-dashboard-">3. How to open IAM dashboard <a name="iam_dashboard"></a></h2>

<p>You can open <a href="https://console.aws.amazon.com/iamv2/home#/home">IAM dashboard</a> to set IAM configurations.
You can click a button, Users, to manage configurations of IAM users. The Fig. 1 shows the
IAM dashboard and Users dashboard. You should click a blue button in the upper right corner, Add users, to add a new IAM user.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/1_IAM/fig_1_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/1_IAM/fig_1_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/1_IAM/fig_1_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/1_IAM/fig_1_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/1_IAM/fig_1_b-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/1_IAM/fig_1_b-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/1_IAM/fig_1_b-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/1_IAM/fig_1_b.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 1. The IAM and user dashboard.
</div>

<hr />

<h2 id="4-how-to-add-an-iam-user-">4. How to add an IAM user <a name="iam_add"></a></h2>

<p>You can easily add an IAM user by following the procedures as shown in Fig. 2. I recommend that you should follow the
configurations except for the permission policy. The Fig. 2 shows the procedures for creating a new IAM user with full
permission policies. Please note that you should remember access key ID, secret access key and password that are shown
in the last procedure. Both access key ID and secret access key are used to install the
<a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS CLI</a>.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/1_IAM/fig_2_a-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/1_IAM/fig_2_a-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/1_IAM/fig_2_a-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/1_IAM/fig_2_a.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/1_IAM/fig_2_b-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/1_IAM/fig_2_b-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/1_IAM/fig_2_b-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/1_IAM/fig_2_b.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/1_IAM/fig_2_c-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/1_IAM/fig_2_c-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/1_IAM/fig_2_c-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/1_IAM/fig_2_c.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/1_IAM/fig_2_d-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/1_IAM/fig_2_d-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/1_IAM/fig_2_d-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/1_IAM/fig_2_d.png" data-zoomable="" />

  </picture>

</figure>

    </div>
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    <source media="(max-width: 480px)" srcset="/assets/blog/AWS/1_IAM/fig_2_e-480.webp" />
    <source media="(max-width: 800px)" srcset="/assets/blog/AWS/1_IAM/fig_2_e-800.webp" />
    <source media="(max-width: 1400px)" srcset="/assets/blog/AWS/1_IAM/fig_2_e-1400.webp" />
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/blog/AWS/1_IAM/fig_2_e.png" data-zoomable="" />

  </picture>

</figure>

    </div>
</div>
<div class="caption">
    Fig. 2. Procedures for adding an IAM user.
</div>

<hr />

<h2 id="5-reference-">5. Reference <a name="ref"></a></h2>
<ol>
  <li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" title="Regions and Zones"> Regions and Zones</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html" title="What is IAM?"> What is IAM?</a></li>
</ol>

<hr />]]></content><author><name></name></author><category term="software" /><category term="aws," /><category term="iam" /><summary type="html"><![CDATA[AWS resources management with the IAM]]></summary></entry><entry><title type="html">Docker with NVIDIA Container Toolkit for Deep Learning</title><link href="https://vujadeyoon.github.io/blog/2022/docker_with_NVIDIA_container_toolkit_for_deep_learning/" rel="alternate" type="text/html" title="Docker with NVIDIA Container Toolkit for Deep Learning" /><published>2022-01-16T00:00:00+00:00</published><updated>2022-01-16T00:00:00+00:00</updated><id>https://vujadeyoon.github.io/blog/2022/docker_with_NVIDIA_container_toolkit_for_deep_learning</id><content type="html" xml:base="https://vujadeyoon.github.io/blog/2022/docker_with_NVIDIA_container_toolkit_for_deep_learning/"><![CDATA[<h2 id="table-of-contents">Table of contents</h2>
<ol>
  <li><a href="#notice">Notice</a></li>
  <li><a href="#envs">Summarized environments about the docker with the Nvidia Container Toolkit</a></li>
  <li><a href="#features_dockerfile">Summarized main features of the provided Dockerfile</a></li>
  <li><a href="#installation_docker">How to install the docker</a></li>
  <li><a href="#installation_nct">How to install the Nvidia Container Toolkit</a></li>
  <li><a href="#docker_preparations">Preparations to build a Dockerfile</a></li>
  <li><a href="#docker_build">How to build a Dockerfile</a></li>
  <li><a href="#docker_container">How to run a docker container</a></li>
  <li><a href="#docker_copy">How to copy files and folders between the host and the docker container</a></li>
  <li><a href="#save_load">How to save and load a docker image</a></li>
  <li><a href="#docker_command">Basic docker command</a></li>
  <li><a href="#ref">Reference</a></li>
</ol>

<hr />

<h2 id="1-notice-">1. Notice <a name="notice"></a></h2>
<ul>
  <li>A guide for Docker with the Nvidia Container Toolkit (i.e. Nvidia-Docker 2.0)</li>
  <li>This is an updated post of the <a href="https://github.com/vujadeyoon/Docker-Nvidia-Container-Toolkit">Docker with the Nvidia Container Toolkit [1]</a>
to cover how to build a Dockerfile for deep learning.
Thus, if you are not familar with the docker commands, I highly recommend you should read the
<a href="https://github.com/vujadeyoon/Docker-Nvidia-Container-Toolkit">Docker with the Nvidia Container Toolkit [1]</a></li>
  <li>I recommend that you should ignore the commented instructions with an octothorpe, #.</li>
  <li>I recommend that you should fill in the appropriate letters between the parentheses, &lt;&gt;.</li>
</ul>

<hr />

<h2 id="2-summarized-environments-about-the-docker-with-the-nvidia-container-toolkit--">2. Summarized environments about the docker with the Nvidia Container Toolkit  <a name="envs"></a></h2>
<ul>
  <li>Operating System (OS): Ubuntu MATE 20.04.2 LTS (Focal)</li>
  <li>Graphics Processing Unit (GPU): NVIDIA TITAN Xp, 1ea</li>
  <li>GPU driver: Nvidia-460.91.03</li>
  <li>CUDA toolkit: CUDA-11.1</li>
  <li>cuDNN: cuDNN v8.2.1</li>
  <li>Docker: Docker version 20.10.7, build 20.10.7-0ubuntu5~20.04.2</li>
  <li>Docker image: nvidia/cuda:10.2-cudnn7-devel-ubuntu18.04</li>
</ul>

<hr />

<h2 id="3-summarized-main-features-of-the-provided-dockerfile--">3. Summarized main features of the provided Dockerfile  <a name="features_dockerfile"></a></h2>
<p>You can check the whole Dockerfile in the <a href="#dockerfile">7-2. Dockerfile</a>.</p>
<ul>
  <li>TensorRT: 7.0.0.11</li>
  <li>Torch2TRT: 0.1.0</li>
  <li>FFmpeg: N-105288-g45e45a6060</li>
  <li>nv-codec-headers: 10.0.26.2</li>
</ul>

<hr />

<h2 id="4-how-to-install-the-docker-">4. How to install the docker <a name="installation_docker"></a></h2>
<ol>
  <li>Docker installation
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>curl https://get.docker.com | sh
2 <span class="nv">$ </span><span class="nb">sudo </span>systemctl start docker <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>systemctl <span class="nb">enable </span>docker
</code></pre></div>    </div>
  </li>
  <li>Check the docker version.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker <span class="nt">--version</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Docker version 20.10.7, build 20.10.7-0ubuntu5~20.04.2
</code></pre></div>    </div>
  </li>
</ol>
<hr />

<h2 id="5-how-to-install-the-nvidia-container-toolkit-">5. How to install the Nvidia Container Toolkit <a name="installation_nct"></a></h2>
<ol>
  <li>Set up the repository and the Gnu Privacy Guard (GPG) key.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ distribution</span><span class="o">=</span><span class="si">$(</span><span class="nb">.</span> /etc/os-release<span class="p">;</span><span class="nb">echo</span> <span class="nv">$ID$VERSION_ID</span><span class="si">)</span>
2 <span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/nvidia-docker/gpgkey | <span class="nb">sudo </span>apt-key add -
3 <span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/nvidia-docker/<span class="nv">$distribution</span>/nvidia-docker.list | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/nvidia-docker.list
4 <span class="nv">$ </span><span class="nb">sudo </span>apt-get update
</code></pre></div>    </div>
  </li>
  <li>Install the Nvidia-Docker 2.0 for the Nvidia Container Toolkit.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> nvidia-docker2
2 <span class="nv">$ </span><span class="nb">sudo </span>systemctl restart docker
</code></pre></div>    </div>
  </li>
  <li>Test the Nviida-Docker 2.0.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker run <span class="nt">--rm</span> <span class="nt">--gpus</span> all nvidia/cuda:10.2-base nvidia-smi
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Tue Dec 22 08:40:19 2020
 +-----------------------------------------------------------------------------+
 | NVIDIA-SMI 440.100      Driver Version: 440.100      CUDA Version: 10.2     |
 |-------------------------------+----------------------+----------------------+
 | GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
 | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
 |<span class="o">===============================</span>+<span class="o">======================</span>+<span class="o">======================</span>|
 |   0  TITAN Xp            Off  | 00000000:01:00.0  On |                  N/A |
 | 23%   30C    P8    10W / 250W |    518MiB / 12192MiB |      0%      Default |
 +-------------------------------+----------------------+----------------------+
    
 +-----------------------------------------------------------------------------+
 | Processes:                                                       GPU Memory |
 |  GPU       PID   Type   Process name                             Usage      |
 |<span class="o">=============================================================================</span>|
 +-----------------------------------------------------------------------------+
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<h2 id="6-preparations-to-build-a-dockerfile-">6. Preparations to build a Dockerfile <a name="docker_preparations"></a></h2>
<ol>
  <li>Directory structure
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── Bash
│   └── bash_docker_utility.sh
├── Dockerfile
├── docker_utility
│   ├── awscliv2.zip
│   ├── eksctl
│   ├── ffmpeg.tar.gz
│   ├── goofys
│   ├── kubectl
│   ├── nv-codec-headers-10.0.26.2.tar.gz
│   ├── TensorRT-7.0.0.11.Ubuntu-18.04.x86_64-gnu.cuda-10.2.cudnn7.6.tar.gz
│   └── torch2trt.tar.gz
├── LICENSE
└── README.md
</code></pre></div>    </div>
  </li>
  <li>
    <p>The version of the required utilities for the docker</p>

    <ul>
      <li>If you want to refer to the official site for each utility, please click the hyperlink in the below table.</li>
    </ul>

    <table>
      <thead>
        <tr>
          <th style="text-align: center">No.</th>
          <th style="text-align: center">Utility</th>
          <th style="text-align: center">Version</th>
          <th style="text-align: center">SHA-1</th>
          <th style="text-align: center">Git commit</th>
          <th> </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: center">1</td>
          <td style="text-align: center"><a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">awscliv2.zip</a></td>
          <td style="text-align: center">2</td>
          <td style="text-align: center">80153150f54149ca2ce5da1248130487fd791e92</td>
          <td style="text-align: center">-</td>
          <td> </td>
        </tr>
        <tr>
          <td style="text-align: center">2</td>
          <td style="text-align: center"><a href="https://github.com/weaveworks/eksctl">eksctl</a></td>
          <td style="text-align: center">0.79.0</td>
          <td style="text-align: center">b8c03f8706d4be4c7cc8a94aa316582809326964</td>
          <td style="text-align: center">-</td>
          <td> </td>
        </tr>
        <tr>
          <td style="text-align: center">3</td>
          <td style="text-align: center"><a href="https://git.ffmpeg.org/ffmpeg.git">ffmpeg.tar.gz</a></td>
          <td style="text-align: center">N-105288-g45e45a6060</td>
          <td style="text-align: center">dd3c209e500afac258db3a2fa1077d06b9650663</td>
          <td style="text-align: center">45e45a60</td>
          <td> </td>
        </tr>
        <tr>
          <td style="text-align: center">4</td>
          <td style="text-align: center"><a href="https://github.com/kahing/goofys">goofys</a></td>
          <td style="text-align: center">0.24.0</td>
          <td style="text-align: center">438a43f737772bf117753c3b40f524ca39814c12</td>
          <td style="text-align: center">-</td>
          <td> </td>
        </tr>
        <tr>
          <td style="text-align: center">5</td>
          <td style="text-align: center"><a href="https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html">kubectl</a></td>
          <td style="text-align: center">1.17.11</td>
          <td style="text-align: center">0790bcc0d98c8f19320359b4537359ea058cfadb</td>
          <td style="text-align: center">-</td>
          <td> </td>
        </tr>
        <tr>
          <td style="text-align: center">6</td>
          <td style="text-align: center"><a href="https://github.com/FFmpeg/nv-codec-headers">nv-codec-headers-10.0.26.2.tar.gz</a></td>
          <td style="text-align: center">10.0.26.2</td>
          <td style="text-align: center">1006a328ba4387ae46e4b1e4b208bd064223370d</td>
          <td style="text-align: center">-</td>
          <td> </td>
        </tr>
        <tr>
          <td style="text-align: center">7</td>
          <td style="text-align: center"><a href="https://developer.nvidia.com/tensorrt">TensorRT-7.0.0.11.Ubuntu-18.04.x86_64-gnu.cuda-10.2.cudnn7.6.tar.gz</a></td>
          <td style="text-align: center">7.0.0.11</td>
          <td style="text-align: center">1f17eb8c0b2f1ea0c7bf935cd209a6d6f0d23f93</td>
          <td style="text-align: center">-</td>
          <td> </td>
        </tr>
        <tr>
          <td style="text-align: center">8</td>
          <td style="text-align: center"><a href="https://github.com/NVIDIA-AI-IOT/torch2trt">torch2trt.tar.gz</a></td>
          <td style="text-align: center">0.1.0</td>
          <td style="text-align: center">f9fa0032a7b3e5a1b434fdab4a4d5a859f01d553</td>
          <td style="text-align: center">75637700</td>
          <td> </td>
        </tr>
      </tbody>
    </table>

    <p><br /></p>
    <ul>
      <li>How to get the SHA-1 in the Ubuntu
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sha1sum </span>NAME_FILE 
</code></pre></div>        </div>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    CHARACTER_SHA1_40 NAME_FILE
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Preparations for the utilities <br />
There are two options to prepare the utilities: i) <a href="#bash_docker_utility">6-4. bash_docker_utility.sh</a>; ii) <a href="https://docs.google.com/forms/d/e/1FAIpQLSc2mI35D6ArGfCReffYCUNj9TH4uRYcjsH60S4AOTEQpEWu4A/viewform?usp=sf_link">Google Request</a>.
I recommend that you should select the option, <a href="#bash_docker_utility">6-4. bash_docker_utility.sh</a> because of downloading the latest version of the utilities.
However, If you have any difficulties, please fill out the <a href="https://docs.google.com/forms/d/e/1FAIpQLSc2mI35D6ArGfCReffYCUNj9TH4uRYcjsH60S4AOTEQpEWu4A/viewform?usp=sf_link">Google Request form</a>.
After reviewing the completed request, I will give you via email that you provided a compressed file, docker_utility.zip <em><span style="color:#b409b2">(SHA-1: 4f77bf2bd59e8af8c7b31bc4d5137b6f6ac6484a)</span></em>
including all utilities. Thus, you should fill in the correct email address. 
After receiving the email, you may be able to get the compressed file using the <a href="https://github.com/wkentaro/gdown">gdown</a>
that is a python3 package for downloading a item from the Google Drive. <br />
Unlike the compressed file, docker_utility.zip, the <a href="#bash_docker_utility">6-4. bash_docker_utility.sh</a> does not have codes to download the <a href="https://developer.nvidia.com/tensorrt">TensorRT</a>.
Thus, you should download the <a href="https://developer.nvidia.com/tensorrt">TensorRT from the official site</a> when using the <a href="#bash_docker_utility">6-4. bash_docker_utility.sh</a>.
    <ul>
      <li>Using the <a href="#bash_docker_utility">6-4. bash_docker_utility.sh</a>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 <span class="nv">$ </span>bash ./Bash/bash_docker_utility.sh
</code></pre></div>        </div>
      </li>
      <li>Using the Google Drive after reviewing the <a href="https://docs.google.com/forms/d/e/1FAIpQLSc2mI35D6ArGfCReffYCUNj9TH4uRYcjsH60S4AOTEQpEWu4A/viewform?usp=sf_link">Google Request</a>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 <span class="nv">$ </span>gdown &lt;URL_TO_BE_RPOVIDED_AFTER_REVIEWING_THE_GOOLGE_REQUEST&gt;
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<details>
 <summary>&nbsp; 4. bash_docker_utility.sh <a name="bash_docker_utility"></a></summary>
 
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="code"><pre> <span class="c">#!/bin/bash</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Dveloper: vujadeyoon</span>
 <span class="c"># Email: vujadeyoon@gmail.com</span>
 <span class="c"># Github: https://github.com/vujadeyoon</span>
 <span class="c"># Personal website: https://vujadeyoon.github.io</span>
 <span class="c">#</span>
 <span class="c"># Title: bash_docker_utility.sh</span>
 <span class="c"># Description: Preparation for the required utilities.</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="nv">path_curr</span><span class="o">=</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>
 <span class="nv">path_parent</span><span class="o">=</span><span class="si">$(</span><span class="nb">dirname</span> <span class="k">${</span><span class="nv">path_curr</span><span class="k">}</span><span class="si">)</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="nv">path_docker_utility</span><span class="o">=</span><span class="k">${</span><span class="nv">path_curr</span><span class="k">}</span>/docker_utility
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Make a directory, docker_utility.</span>
 <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># AWSCLI version 2</span>
 curl <span class="nt">--silent</span> https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip <span class="nt">-o</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>/awscliv2.zip
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># eksctl</span>
 curl <span class="nt">--silent</span> <span class="nt">--location</span> <span class="s2">"https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-s</span><span class="si">)</span><span class="s2">_amd64.tar.gz"</span> | <span class="nb">tar </span>xz <span class="nt">-C</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>/
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># FFmpeg</span>
 git clone https://git.ffmpeg.org/ffmpeg.git <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>/ffmpeg
 <span class="nb">cd</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>/ffmpeg <span class="o">&amp;&amp;</span> git checkout 45e45a606077ccd0aab7eaffb8697e633b876fb2
 <span class="nb">cd</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span> <span class="o">&amp;&amp;</span> <span class="nb">tar</span> <span class="nt">-czvf</span> ffmpeg.tar.gz ffmpeg
 <span class="nb">rm</span> <span class="nt">-rf</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>/ffmpeg
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># goofys</span>
 wget <span class="nt">--quiet</span> https://github.com/kahing/goofys/releases/download/v0.24.0/goofys <span class="nt">-P</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># kubectl</span>
 curl <span class="nt">--silent</span> <span class="nt">--location</span> <span class="nt">-o</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>/kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.17.11/2020-09-18/bin/linux/amd64/kubectl
 <span class="nb">chmod</span> +x <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>/kubectl
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># nv-codec-headers</span>
 wget <span class="nt">--quiet</span> https://github.com/FFmpeg/nv-codec-headers/releases/download/n10.0.26.2/nv-codec-headers-10.0.26.2.tar.gz <span class="nt">-P</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># TensorRT</span>
 <span class="c"># You should download the TensorRT from the official site, https://developer.nvidia.com/tensorrt.</span>
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="c"># Torch2TRT</span>
 git clone https://github.com/NVIDIA-AI-IOT/torch2trt <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>/torch2trt
 <span class="nb">cd</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>/torch2trt <span class="o">&amp;&amp;</span> git checkout 756377002708121d43a3e66ba72f56af65696402
 <span class="nb">cd</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span> <span class="o">&amp;&amp;</span> <span class="nb">tar</span> <span class="nt">-czvf</span> torch2trt.tar.gz torch2trt
 <span class="nb">rm</span> <span class="nt">-rf</span> <span class="k">${</span><span class="nv">path_docker_utility</span><span class="k">}</span>/torch2trt
 <span class="c">#</span>
 <span class="c">#</span>
 <span class="nb">cd</span> <span class="k">${</span><span class="nv">path_curr</span><span class="k">}</span> <span class="o">||</span> <span class="k">return</span>
 
</pre></td></tr></tbody></table></code></pre></figure>

</details>

<hr />

<h2 id="7-how-to-build-a-dockerfile-">7. How to build a Dockerfile <a name="docker_build"></a></h2>
<ol>
  <li>Build a Dockerfile shown in the <a href="#dockerfile">7-2. Dockerfile</a>.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker build <span class="nt">-t</span> &lt;REPOSITORY&gt;:&lt;TAG&gt; <span class="nb">.</span>
</code></pre></div>    </div>
  </li>
</ol>
<details>
 <summary>&nbsp; 2. Dockerfile <a name="dockerfile"></a></summary>
 
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
</pre></td><td class="code"><pre> <span class="c"># Dveloper: vujadeyoon</span>
 <span class="c"># Email: vujadeyoon@gmail.com</span>
 <span class="c"># Github: https://github.com/vujadeyoon</span>
 <span class="c"># Personal website: https://vujadeyoon.github.io</span>
 <span class="c">#</span>
 <span class="c"># Title: Dockerfile</span>
 <span class="c"># Description: A Dockerfile for the NVIDIA Container Toolkit for Deep Learning</span>
 <span class="c">#</span>
 <span class="c">#</span>
 FROM nvidia/cuda:10.2-cudnn7-devel-ubuntu18.04
 
 
 LABEL <span class="nv">maintainer</span><span class="o">=</span><span class="s2">"vujadeyoon"</span>
 LABEL <span class="nv">email</span><span class="o">=</span><span class="s2">"vujadeyoon@gmial.com"</span>
 LABEL <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span>
 LABEL <span class="nv">description</span><span class="o">=</span><span class="s2">"Docker with NVIDIA Container Toolkit for Deep Learning"</span>
 
 
 ENV <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
 
 
 <span class="c"># 1. Install the essential ubuntu packages.</span>
 RUN apt-get update <span class="o">&amp;&amp;</span>  <span class="se">\</span>
     apt-get upgrade <span class="nt">-y</span> <span class="o">&amp;&amp;</span>  <span class="se">\</span>
     apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-install-recommends</span> <span class="se">\</span>
         build-essential <span class="se">\</span>
         apt-utils <span class="se">\</span>
         cmake <span class="se">\</span>
         git <span class="se">\</span>
         curl <span class="se">\</span>
         vim <span class="se">\</span>
         ssh <span class="se">\</span>
         <span class="nb">sudo</span> <span class="se">\</span>
         <span class="nb">tar</span> <span class="se">\</span>
         libcurl3-dev <span class="se">\</span>
         libfreetype6-dev <span class="se">\</span>
         pkg-config <span class="se">\</span>
         ca-certificates <span class="se">\</span>
         libjpeg-dev <span class="se">\</span>
         libpng-dev <span class="o">&amp;&amp;</span> <span class="se">\</span>
     apt-get clean <span class="o">&amp;&amp;</span> <span class="se">\</span>
     <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
 
 
 <span class="c"># 2. Install the useful ubuntu packages.</span>
 RUN apt-get update <span class="o">&amp;&amp;</span>  <span class="se">\</span>
     apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\</span>
         ffmpeg <span class="se">\</span>
         libgtk2.0-dev <span class="se">\</span>
         python3-matplotlib <span class="se">\</span>
         wget <span class="se">\</span>
         tmux <span class="se">\</span>
         zsh <span class="se">\</span>
         locales <span class="se">\</span>
         ncdu <span class="se">\</span>
         htop <span class="se">\</span>
         zip <span class="se">\</span>
         unzip <span class="se">\</span>
         rsync <span class="o">&amp;&amp;</span> <span class="se">\</span>
     apt-get clean <span class="o">&amp;&amp;</span> <span class="se">\</span>
     <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
 
 
 <span class="c"># 3. Set the locale</span>
 RUN locale-gen en_US.UTF-8
 ENV LANG en_US.UTF-8
 ENV LANGUAGE en_US:en
 ENV LC_ALL en_US.UTF-8
 
 
 <span class="c"># 4. Install python.</span>
 RUN apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
     apt-get <span class="nb">install </span>software-properties-common <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
     add-apt-repository ppa:deadsnakes/ppa <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
     apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\</span>
          python-pip <span class="se">\</span>
          python3-pip <span class="o">&amp;&amp;</span> <span class="se">\</span>
     apt-get clean <span class="o">&amp;&amp;</span> <span class="se">\</span>
     <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
 
 
 <span class="c">## 5. Set python3.7 as default</span>
 <span class="c">#RUN apt-get update &amp;&amp; \</span>
 <span class="c">#    apt-get install -y \</span>
 <span class="c">#        python3.7 \</span>
 <span class="c">#        python3.7-dev &amp;&amp; \</span>
 <span class="c">#    apt-get clean &amp;&amp; \</span>
 <span class="c">#    rm -rf /var/lib/apt/lists/* &amp;&amp; \</span>
 <span class="c">#    rm /usr/bin/python3 &amp;&amp; \</span>
 <span class="c">#    ln -s /usr/bin/python3.7 /usr/bin/python3</span>
 
 
 <span class="c"># 6. Install more python packages</span>
 RUN pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip <span class="o">&amp;&amp;</span> <span class="se">\</span>
     pip3 <span class="nb">install</span> <span class="nt">--upgrade</span> pip
 
 
 <span class="c"># 7. Python3 packages for mathematical functions and plotting</span>
 RUN pip3 <span class="nb">install</span> <span class="se">\</span>
     opencv-python<span class="o">==</span>4.5.1.48 <span class="se">\</span>
     opencv-contrib-python<span class="o">==</span>4.5.1.48 <span class="se">\</span>
     ffmpeg-python <span class="se">\</span>
     <span class="nv">Pillow</span><span class="o">==</span>7.2.0 <span class="se">\</span>
     imageio <span class="se">\</span>
     <span class="nv">kornia</span><span class="o">==</span>0.2.2 <span class="se">\</span>
     <span class="nv">matplotlib</span><span class="o">==</span>3.3.1 <span class="se">\</span>
     scikit-image <span class="se">\</span>
     scikit-learn <span class="se">\</span>
     pandas <span class="se">\</span>
     openpyxl <span class="se">\</span>
     plotly <span class="se">\</span>
     seaborn <span class="se">\</span>
     shapely
 
 
 <span class="c"># 8. Python3 packages for monitoring and debugging</span>
 RUN pip3 <span class="nb">install</span> <span class="se">\</span>
     jupyter <span class="se">\</span>
     wandb <span class="se">\</span>
     gpustat <span class="se">\</span>
     getgpu <span class="se">\</span>
     tqdm <span class="se">\</span>
     ipdb <span class="se">\</span>
     icecream
 
 
 <span class="c"># 9. Other python3 packages</span>
 RUN pip3 <span class="nb">install</span> <span class="se">\</span>
     scipy <span class="se">\</span>
     Cython <span class="se">\</span>
     prettyprinter <span class="se">\</span>
     colorlog <span class="se">\</span>
     randomcolor <span class="se">\</span>
     <span class="nv">future</span><span class="o">==</span>0.18.2 <span class="se">\</span>
     imutils <span class="se">\</span>
     psutil <span class="se">\</span>
     PyYAML <span class="se">\</span>
     pycrypto
 
 
 <span class="c"># 10. Install python3 packages for the deep learning research.</span>
 RUN pip3 <span class="nb">install</span> <span class="se">\</span>
     PyWavelets <span class="se">\</span>
     <span class="nv">pycuda</span><span class="o">==</span>2020.1 <span class="se">\</span>
     <span class="nv">torch</span><span class="o">==</span>1.4.0 <span class="se">\</span>
     <span class="nv">torchvision</span><span class="o">==</span>0.5.0 <span class="se">\</span>
     <span class="nv">torchsummary</span><span class="o">==</span>1.5.1
 
 
 <span class="c"># 11. Install python3 packages related to the server.</span>
 RUN pip3 <span class="nb">install</span> <span class="se">\</span>
     <span class="nv">flask</span><span class="o">==</span>1.1.2 <span class="se">\</span>
     Flask-RESTful<span class="o">==</span>0.3.8 <span class="se">\</span>
     <span class="nv">gevent</span><span class="o">==</span>21.1.2 <span class="se">\</span>
     <span class="nv">boto3</span><span class="o">==</span>1.17.9 <span class="se">\</span>
     <span class="nv">kubernetes</span><span class="o">==</span>12.0.1
 
 
 <span class="c"># 12. Make required directories.</span>
 RUN <span class="nb">mkdir</span> <span class="nt">-p</span> /home/Vujadeyoon/
 RUN <span class="nb">mkdir</span> <span class="nt">-p</span> /home/Vujadeyoon/vdisk/
 
 
 <span class="c"># 13. Install a python3 package, TensorRT 7.0.0.11.</span>
 <span class="c">#     i) Preparations.</span>
 RUN <span class="nb">mkdir</span> <span class="nt">-p</span> /home/Vujadeyoon/pip3_packages/
 COPY ./docker_utility/TensorRT-7.0.0.11.Ubuntu-18.04.x86_64-gnu.cuda-10.2.cudnn7.6.tar.gz /home/Vujadeyoon/pip3_packages/
 WORKDIR /home/Vujadeyoon/pip3_packages/
 <span class="c">#     ii) Uncompress the downloaded tar.gz file.</span>
 RUN <span class="nb">tar</span> <span class="nt">-xzvf</span> TensorRT-7.0.0.11.Ubuntu-18.04.x86_64-gnu.cuda-10.2.cudnn7.6.tar.gz
 RUN <span class="nb">mkdir</span> <span class="nt">-p</span> ./TensorRT-7.0.0.11/_arxiv/
 RUN <span class="nb">mv</span> ./TensorRT-7.0.0.11.Ubuntu-18.04.x86_64-gnu.cuda-10.2.cudnn7.6.tar.gz TensorRT-7.0.0.11/_arxiv/
 <span class="c">#     iii) Register an environmental variable.</span>
 ENV LD_LIBRARY_PATH <span class="nv">$LD_LIBRARY_PATH</span>:/home/Vujadeyoon/pip3_packages/TensorRT-7.0.0.11/lib
 <span class="c">#     iv) Copy plugins of the TensorRT to the CUDA toolkit directory.</span>
 RUN <span class="nb">mkdir</span> <span class="nt">-p</span> /usr/local/cuda-originals/cuda-10.2/
 RUN <span class="nb">cp</span> <span class="nt">-r</span> /usr/local/cuda-10.2/targets/ /usr/local/cuda-originals/cuda-10.2/
 RUN <span class="nb">cp</span> <span class="nt">-r</span> /home/Vujadeyoon/pip3_packages/TensorRT-7.0.0.11/include/<span class="k">*</span> /usr/local/cuda-10.2/targets/x86_64-linux/include/
 RUN <span class="nb">cp</span> <span class="nt">-r</span> /home/Vujadeyoon/pip3_packages/TensorRT-7.0.0.11/targets/x86_64-linux-gnu/lib/<span class="k">*</span> /usr/local/cuda-10.2/targets/x86_64-linux/lib/
 <span class="c">#     v) Install python3 packages related to the TensorRT.</span>
 WORKDIR /home/Vujadeyoon/pip3_packages/TensorRT-7.0.0.11/
 RUN pip3 <span class="nb">install</span> <span class="se">\</span>
     ./python/tensorrt-7.0.0.11-cp36-none-linux_x86_64.whl <span class="se">\</span>
     ./uff/uff-0.6.5-py2.py3-none-any.whl <span class="se">\</span>
     ./graphsurgeon/graphsurgeon-0.4.1-py2.py3-none-any.whl
 <span class="c">#     vi) Go to the base directory.</span>
 WORKDIR /home/Vujadeyoon/
 
 
 <span class="c"># 14. Install a python3 package, Torch2TRT.</span>
 <span class="c">#     i) Preparations.</span>
 RUN <span class="nb">mkdir</span> <span class="nt">-p</span> /home/Vujadeyoon/pip3_packages/
 COPY ./docker_utility/torch2trt.tar.gz /home/Vujadeyoon/pip3_packages/
 WORKDIR /home/Vujadeyoon/pip3_packages/
 <span class="c">#     ii) Uncompress the downloaded tar.gz file.</span>
 RUN <span class="nb">tar</span> <span class="nt">-xzvf</span> /home/Vujadeyoon/pip3_packages/torch2trt.tar.gz
 RUN <span class="nb">mkdir</span> <span class="nt">-p</span> ./torch2trt/_arxiv/
 RUN <span class="nb">mv</span> ./torch2trt.tar.gz torch2trt/_arxiv/
 <span class="c">#     iii) Install the python3 package, Torch2TRT.</span>
 WORKDIR /home/Vujadeyoon/pip3_packages/torch2trt/
 RUN python3 setup.py <span class="nb">install</span> <span class="nt">--plugins</span>
 <span class="c">#     iv) Go to the base directory.</span>
 WORKDIR /home/Vujadeyoon/
 
 
 <span class="c"># 15. Install the AWS CLI version 2 on Linux.</span>
 RUN <span class="nb">mkdir</span> <span class="nt">-p</span> /home/Vujadeyoon/AWS/
 COPY ./docker_utility/awscliv2.zip /home/Vujadeyoon/AWS/
 RUN unzip /home/Vujadeyoon/AWS/awscliv2.zip <span class="nt">-d</span> /home/Vujadeyoon/AWS/
 RUN /home/Vujadeyoon/AWS/aws/install
 RUN <span class="nb">rm</span> <span class="nt">-rf</span> /home/Vujadeyoon/AWS/
 
 
 <span class="c"># 16. Enroll the AWS credentials and config for development.</span>
 <span class="c"># RUN mkdir /root/.aws</span>
 <span class="c"># RUN echo '[default]' &gt;&gt; /root/.aws/credentials</span>
 <span class="c"># RUN echo 'aws_access_key_id = &lt;SECRET&gt;' &gt;&gt; /root/.aws/credentials</span>
 <span class="c"># RUN echo 'aws_secret_access_key = &lt;SECRET&gt;' &gt;&gt; /root/.aws/credentials</span>
 <span class="c"># RUN echo '[default]' &gt;&gt; /root/.aws/config</span>
 <span class="c"># RUN echo 'region = ap-northeast-2' &gt;&gt; /root/.aws/config</span>
 <span class="c"># RUN echo 'output = json' &gt;&gt; /root/.aws/config</span>
 
 
 <span class="c"># 17. Install the Goofys</span>
 COPY ./docker_utility/goofys /usr/local/bin/
 RUN <span class="nb">chmod</span> +x /usr/local/bin/goofys
 
 
 <span class="c"># 18. Install the EKSCTL.</span>
 COPY ./docker_utility/eksctl /usr/local/bin/
 RUN <span class="nb">chmod</span> +x /usr/local/bin/eksctl
 RUN eksctl completion bash <span class="o">&gt;&gt;</span> /root/.bash_completion
 
 
 <span class="c"># 19. Install the KUBECTL.</span>
 COPY ./docker_utility/kubectl /usr/local/bin/
 RUN <span class="nb">chmod</span> +x /usr/local/bin/kubectl
 RUN kubectl completion bash <span class="o">&gt;&gt;</span> /root/.bash_completion
 
 
 <span class="c"># 20. FFmpeg-GPU</span>
 RUN apt-get update <span class="o">&amp;&amp;</span>  <span class="se">\</span>
     apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\</span>
         yasm <span class="se">\</span>
         libtool <span class="se">\</span>
         libc6 <span class="se">\</span>
         libc6-dev <span class="se">\</span>
         libnuma1 <span class="se">\</span>
         libnuma-dev <span class="se">\</span>
         libmp3lame-dev <span class="se">\</span>
         psmisc <span class="se">\</span>
         libass-dev <span class="se">\</span>
         libgl1-mesa-glx <span class="o">&amp;&amp;</span> <span class="se">\</span>
     apt-get clean <span class="o">&amp;&amp;</span> <span class="se">\</span>
     <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
 RUN <span class="nb">mkdir</span> <span class="nt">-p</span> /home/Vujadeyoon/FFmpeg_GPU/
 COPY ./docker_utility/nv-codec-headers-10.0.26.2.tar.gz /home/Vujadeyoon/FFmpeg_GPU/
 COPY ./docker_utility/ffmpeg.tar.gz /home/Vujadeyoon/FFmpeg_GPU/
 WORKDIR /home/Vujadeyoon/FFmpeg_GPU/
 RUN <span class="nb">tar</span> <span class="nt">-xzvf</span> nv-codec-headers-10.0.26.2.tar.gz
 RUN <span class="nb">tar</span> <span class="nt">-xzvf</span> ffmpeg.tar.gz
 WORKDIR /home/Vujadeyoon/FFmpeg_GPU/nv-codec-headers-10.0.26.2/
 RUN make <span class="nb">install</span>
 <span class="c"># RUN git clone https://git.videolan.org/git/ffmpeg/nv-codec-headers.git</span>
 <span class="c"># RUN cd nv-codec-headers &amp;&amp; make install &amp;&amp; cd /data</span>
 WORKDIR /home/Vujadeyoon/FFmpeg_GPU/ffmpeg/
 RUN ./configure <span class="nt">--enable-cuda-sdk</span> <span class="nt">--enable-cuvid</span> <span class="nt">--enable-nvenc</span> <span class="nt">--enable-nonfree</span> <span class="nt">--enable-libnpp</span>  <span class="nt">--enable-libass</span> <span class="nt">--enable-libmp3lame</span> <span class="nt">--extra-cflags</span><span class="o">=</span><span class="nt">-I</span>/usr/local/cuda/include <span class="nt">--extra-ldflags</span><span class="o">=</span><span class="nt">-L</span>/usr/local/cuda/lib64 <span class="o">&amp;&amp;</span> make <span class="nt">-j</span> 8 <span class="o">&amp;&amp;</span> make <span class="nb">install</span>
 
 
 <span class="c"># 21. Update and clean the Ubuntu packages.</span>
 RUN apt-get update <span class="o">&amp;&amp;</span>  <span class="se">\</span>
     apt-get clean <span class="o">&amp;&amp;</span> <span class="se">\</span>
     <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
 
 
 <span class="c"># 22. Go to the base directory.</span>
 WORKDIR /home/Vujadeyoon/
 
 
 <span class="c"># 23. Run the command.</span>
 CMD <span class="o">[</span> <span class="s2">"/bin/bash"</span> <span class="o">]</span>
 
</pre></td></tr></tbody></table></code></pre></figure>

</details>

<hr />

<h2 id="8-how-to-run-a-docker-container-">8. How to run a docker container <a name="docker_container"></a></h2>
<ol>
  <li>Run a docker container corresponding to the docker image, &lt;REPOSITORY&gt;:&lt;TAG&gt; with some useful options.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--privileged</span> <span class="nt">--runtime</span> nvidia <span class="nt">-p</span> &lt;PORT_HOST&gt;:&lt;PORT_CONTAINER&gt; <span class="nt">-v</span> &lt;PATH_HOST&gt;:&lt;PATH_CONTAINER&gt; &lt;REPOSITORY&gt;:&lt;TAG&gt; <span class="s2">"/bin/bash"</span>
</code></pre></div>    </div>
  </li>
</ol>
<hr />

<h2 id="9-how-to-copy-files-and-folders-between-the-host-and-a-docker-container-">9. How to copy files and folders between the host and a docker container <a name="docker_copy"></a></h2>
<p>You can get the &lt;CONTAINER_ID&gt; using the below command. If you are not familar with the command, please refer to the <a href="#docker_command">11. Basic docker command</a>.
The items can be both folders or files.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker ps <span class="nt">--all</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  CONTAINER ID   IMAGE          COMMAND                  CREATED        STATUS                      PORTS     NAMES
</code></pre></div></div>

<ol>
  <li>Copy itmes from the host to the docker container.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>docker <span class="nb">cp</span> &lt;PATH_HOST&gt; &lt;CONTAINER_ID&gt;:&lt;PATH_CONTAINER&gt;
</code></pre></div>    </div>
  </li>
  <li>Copy itmes from the docker container to the host.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>docker <span class="nb">cp</span> &lt;CONTAINER_ID&gt;:&lt;PATH_CONTAINER&gt; &lt;PATH_HOST&gt;
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<h2 id="10-how-to-save-and-load-a-docker-image-">10. How to save and load a docker image <a name="save_load"></a></h2>
<ol>
  <li>Save a docker image.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker save &lt;REPOSITORY:TAG&gt; <span class="nt">-o</span> &lt;NAME_TAR&gt;.tar
</code></pre></div>    </div>
  </li>
  <li>Load a pre-built docker image.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker load <span class="nt">-i</span> &lt;NAME_TAR&gt;.tar
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<h2 id="11-basic-docker-command-">11. Basic docker command <a name="docker_command"></a></h2>
<ol>
  <li>Exit the docker container.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>ctrl + d
</code></pre></div>    </div>
  </li>
  <li>List docker images.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker images
</code></pre></div>    </div>
  </li>
  <li>List all docker containers.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker ps <span class="nt">--all</span>
</code></pre></div>    </div>
  </li>
  <li>Stop a docker container.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker stop &lt;CONTAINER_ID&gt;
</code></pre></div>    </div>
  </li>
  <li>Start the stopped docker container.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker start &lt;CONTAINER_ID&gt;
</code></pre></div>    </div>
  </li>
  <li>Attach a working docker container.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">sudo </span>docker attach &lt;CONTAINER_ID&gt;
</code></pre></div>    </div>
  </li>
  <li>Remove docker containers.
    <ol>
      <li>Remove docker containers corresponding to the container ID list.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 <span class="nv">$ </span><span class="nb">sudo </span>docker <span class="nb">rm</span> &lt;CONTAINER_ID_1&gt;, &lt;CONTAINER_ID_2&gt; ,..., &lt;CONTAINER_ID_N&gt; 
</code></pre></div>        </div>
      </li>
      <li>Remove all docker containers.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 <span class="nv">$ </span><span class="nb">sudo </span>docker <span class="nb">rm</span> <span class="sb">`</span><span class="nb">sudo </span>docker ps <span class="nt">-a</span> <span class="nt">-q</span><span class="sb">`</span>
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>Remove a docker images.
    <ol>
      <li>Remove docker images corresponding to the docker image list.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 <span class="nv">$ </span><span class="nb">sudo </span>docker rmi &lt;IMAGE_1&gt;, &lt;IMAGE_2&gt; ,..., &lt;IMAGE_N&gt;
</code></pre></div>        </div>
      </li>
      <li>Remove docker images with the corresponding docker containers from the given docker image list.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 <span class="nv">$ </span><span class="nb">sudo </span>docker rmi <span class="nt">-f</span> &lt;IMAGE_1&gt;, &lt;IMAGE_2&gt; ,..., &lt;IMAGE_N&gt;
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
</ol>

<hr />

<h2 id="12-reference-">12. Reference <a name="ref"></a></h2>
<ol>
  <li><a href="https://github.com/vujadeyoon/Docker-Nvidia-Container-Toolkit" title="Docker-Nvidia-Container-Toolkit"> Docker-Nvidia-Container-Toolkit</a></li>
  <li><a href="https://www.docker.com" title="Docker"> Docker</a></li>
  <li><a href="https://github.com/NVIDIA/nvidia-docker" title="Nvidia-Docker"> Github for the Nvidia-Docker</a></li>
  <li><a href="https://docs.nvidia.com/datacenter/cloud-native" title="Nvidia-Docker"> Document for the Nvidia-Docker</a></li>
</ol>

<hr />]]></content><author><name></name></author><category term="software" /><category term="aws" /><category term="deep-learning" /><category term="docker" /><summary type="html"><![CDATA[The Dockerfile and docker commands for the deep learning that can be used in practice]]></summary></entry></feed>