<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>        
    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Sungjun  Yoon | Amazon Elastic Kubernetes Service (EKS)</title>
    <meta name="author" content="Sungjun  Yoon" />
    <meta name="description" content="Setting up the Amazon EKS" />
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website" />


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

    <!-- Styles -->
    
    <link rel="shortcut icon" href="/assets/ico/github.ico"/>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://vujadeyoon.github.io/blog/2022/eks/">

    <!-- Dark Mode -->
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
  </head>

  <!-- Body -->
  <body class="fixed-top-nav">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://vujadeyoon.github.io/"><span class="font-weight-bold">Sungjun</span>   Yoon</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">Main</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">Blog</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/curriculum_vitae/">Curriculum Vitae</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">Projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">Publications</a>
              </li>

              <!-- Toogle theme mode -->
              <div class="toggle-container">
                <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Amazon Elastic Kubernetes Service (EKS)</h1>
    <p class="post-meta">January 28, 2022</p>
    <p class="post-tags">
      <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>
        ·  
        <a href="/blog/tag/aws,">
          <i class="fas fa-hashtag fa-sm"></i> aws,</a>  
          <a href="/blog/tag/eks">
          <i class="fas fa-hashtag fa-sm"></i> eks</a>  
          
        ·  
        <a href="/blog/category/software">
          <i class="fas fa-tag fa-sm"></i> software</a>  
          

    </p>
  </header>

  <article class="post-content">
    <h2 id="table-of-contents">Table of contents</h2>
<ol>
  <li><a href="#notice">Notice</a></li>
  <li><a href="#k8s">What is Kubernetes (K8s)?</a></li>
  <li><a href="#eks">What is Amazon Elastic Kubernetes Service (EKS)?</a></li>
  <li><a href="#cluster">How to create a cluster</a></li>
  <li><a href="#nodegroup">How to create a node group</a></li>
  <li><a href="#ca">How to configure a cluster autoscaler (CA)</a></li>
  <li><a href="#aws_lbc">How to install the AWS load balancer controller</a></li>
  <li><a href="#metric_server">How to install a metric server</a></li>
  <li><a href="#namespace">How to apply a namespace</a></li>
  <li><a href="#deployment">How to apply a deployment</a></li>
  <li><a href="#service">How to apply a service</a></li>
  <li><a href="#hpa">How to apply a horizontal pod autoscaler (HPA)</a></li>
  <li><a href="#ingress">How to apply an ingress</a></li>
  <li><a href="#kubectl_commands">Useful kubectl commands</a></li>
  <li><a href="#fix_error">How to fix error</a></li>
  <li><a href="#ref">Reference</a></li>
</ol>

<hr>

<h2 id="1-notice-">1. Notice <a name="notice"></a>
</h2>
<ul>
  <li>A guide for setting the Amazon Web Services (AWS) Cloud9</li>
  <li>The name of region is Asia Pacific (Seoul) and the corresponding code is ap-northeast-2 [1].</li>
  <li>I recommend that you should ignore the commented instructions with an octothorpe, #.</li>
  <li>I recommend that you should fill in the appropriate letters between the parentheses, &lt;&gt;.</li>
</ul>

<hr>

<h2 id="2-what-is-kubernetes-k8s-">2. What is Kubernetes (K8s)? <a name="k8s"></a>
</h2>
<p>Kubernetes is a portable, extensible, open-source platform for managing containerized workloads and services, that
facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem.
Kubernetes services, support, and tools are widely available. The name Kubernetes originates from Greek, meaning
helmsman or pilot. K8s as an abbreviation results from counting the eight letters between the “K” and the “s”. Google
open-sourced the Kubernetes project in 2014. Kubernetes combines over 15 years of Google’s experience running production
workloads at scale with best-of-breed ideas and practices from the community [2].</p>

<hr>

<h2 id="3-what-is-amazon-elastic-kubernetes-service-eks-">3. What is Amazon Elastic Kubernetes Service (EKS)? <a name="eks"></a>
</h2>
<p>Amazon Elastic Kubernetes Service (Amazon EKS) is a managed Kubernetes service that makes it easy for you to run
Kubernetes on AWS and on-premises. Kubernetes is an open-source system for automating deployment, scaling, and
management of containerized applications. Amazon EKS is certified Kubernetes-conformant, so existing applications that
run on upstream Kubernetes are compatible with Amazon EKS [3].</p>

<h5 id="1-amazon-eks-cluster">1. Amazon EKS cluster</h5>
<p>An Amazon EKS cluster, which calls cluster for short, consists of two primary components:</p>
<ul>
  <li>The Amazon EKS control plane</li>
  <li>Amazon EKS nodes that are registered with the control plane</li>
</ul>

<p>The Amazon EKS control plane consists of control plane nodes that run the Kubernetes software, such as etcd and the
Kubernetes API server. The control plane runs in an account managed by AWS, and the Kubernetes API is exposed via the
Amazon EKS endpoint associated with your cluster. Each Amazon EKS cluster control plane is single-tenant and unique, and
runs on its own set of Amazon EC2 instances [4].</p>

<p>The kinds of the Amazon EKS cluster are public (non-private) and private cluster.</p>
<ul>
  <li>Public cluster (non-private cluster): All node groups in the cluster are in the public subnet.</li>
  <li>Private cluster: All node groups in the cluster are in the private subnet. Thus, it enables that all pods (in nodes)
in the node groups are only internally accessed.</li>
</ul>

<h5 id="2-amazon-eks-managed-node-group">2. Amazon EKS managed node group</h5>
<p>A node group means a set of worker nodes which calls just nodes for short. A cluster consists of a number of node groups.
Please note that a cluster can be composed of various types of the node groups (e.g. g4dn.xlarge and t5.large).
There are two types of the node groups [5].</p>
<ul>
  <li>EKS managed node group
    <ul>
      <li>Flag: managedNodeGroups</li>
      <li>When creating a worker node, it supports Amazon Linux based EKS optimized Amazon Linux 2 AMI.</li>
      <li>It automates the provisioning and lifecycle management of nodes (Amazon EC2 instances) for Amazon EKS Kubernetes
clusters [6].</li>
    </ul>
  </li>
  <li>Self managed nodes
    <ul>
      <li>Flag: nodeGroups</li>
      <li>When creating a worker node, it supports other operating system (OS) which is not based on Amazon Linux (e.g. Windows).</li>
    </ul>
  </li>
</ul>

<h5 id="3-cluster-autosacler-ca">3. Cluster Autosacler (CA)</h5>
<p>The Kubernetes Cluster Autoscaler automatically adjusts the number of nodes in your cluster when pods fail or are
rescheduled onto other nodes [7].</p>

<h5 id="4-aws-load-balancer-controller">4. AWS Load Balancer Controller</h5>
<p>The AWS Load Balancer Controller manages AWS Elastic Load Balancers for a Kubernetes cluster. Please note that The
AWS Load Balancer Controller replaces the functionality of the AWS ALB Ingress Controller for Kubernetes [8].</p>

<h5 id="5-metrics-server">5. Metrics Server</h5>
<p>The Kubernetes Metrics Server is an aggregator of resource usage data in your cluster, and it is not deployed by default
in Amazon EKS clusters. The Metrics Server is commonly used by other Kubernetes add ons, such as the Horizontal Pod
Autoscaler (HPA) or the Kubernetes Dashboard [9].</p>

<h5 id="6-namespace">6. Namespace</h5>
<p>A namespace is a way to group services for an application. When you create a namespace, you specify how you want to
discover service instances that you register with AWS Cloud Map: using API calls or using DNS queries. You also specify
the name that you want your application to use to discover instances [10].</p>

<h5 id="7-deployment">7. Deployment</h5>
<p>A deployment provides declarative updates for pods and replicaset [11] In other words, the deployment manages a
replicated application on the cluster. The pods are the smallest deployable units of computing that you can create and
manage in Kubernetes [12]. The replicaset ensures that a specified number of pod replicas are running at any given time
[13].</p>

<h5 id="8-service">8. Service</h5>
<p>An abstract way to expose an application running on a set of pods as a network service [14].</p>

<h5 id="9-horizontal-pod-autoscaling">9. Horizontal Pod Autoscaling</h5>
<p>In Kubernetes, a horizontal pod autoscaler (HPA) automatically updates a workload resource (such as a Deployment or StatefulSet),
with the aim of automatically scaling the workload to match demand [15].
The statefulset is the workload API object used to manage stateful applications. it manages deployment and scaling of a
set of pods, with durable storage and persistent identifier for each pod [16].</p>

<h5 id="10-ingress">10. Ingress</h5>
<p>Ingress is an Application Programming Interface (API) object that manages external access to the services in a cluster,
typically Hypertext Transfer Protocol (HTTP) [17].</p>

<hr>

<h2 id="4-how-to-create-a-cluster-">4. How to create a cluster <a name="cluster"></a>
</h2>
<h5 id="1-how-to-create-a-cluster">1. How to create a cluster</h5>
<p>In about 40 minutes, you can create a cluster with a <a href="/assets/blog/AWS/4_EKS/dev/cluster/cluster.yaml">cluster.yaml</a>.
I recommend that you should check the field of the yaml file.</p>
<ul>
  <li>metadata:name: vujade-cluster</li>
  <li>metadata:region: ap-northeast-2</li>
  <li>metadata:version: “1.21”</li>
  <li>vpc:subnets:private:
    <ul>
      <li>ap-northeast-2a: { id: subnet-012a3456b78cde9f0 }</li>
      <li>ap-northeast-2c: { id: subnet-0123a4bc5d678e901 }</li>
    </ul>
  </li>
  <li>secretsEncryption:keyARN: arn:aws:kms:ap-northeast-2:123456789123:key/a0b1234c-de5f-6789-g01h-2i3456j789k0</li>
</ul>

<p>In this case, the <em>vpc:subnets:private</em> is required because of the private cluster. The values of the field which can be obtained on
<a href="https://ap-northeast-2.console.aws.amazon.com/vpc" target="_blank" rel="noopener noreferrer">VPC Dashboard</a> correspond to the subnets of the data plane which are
created in the <a href="/blog/2022/vpc/#subnet">Amazon Virtual Private Cloud (VPC) - Section 5. How to set up subnets</a>. Also, as far as I mentioned in
<a href="/blog/2022/vpc/#subnet">Amazon Virtual Private Cloud (VPC) - Section 5. How to set up subnets</a>, the considered EC2 instance type, g4dn.xlarge is only
supported ap-northeast-2a and ap-northeast-2c. The value of the <em>secretsEncryption:keyARN</em> is the MASTER_ARN which is
created in the <a href="/blog/2022/cloud9/#aws_cmk">Amazon Web Services (AWS) Cloud9 - Section 8. How to create an AWS KMS custom managed key (CMK)</a>. Please note that
any tags for the VPC are not required because the cluster version is 1.19+ as far as I mentioned in
<a href="/blog/2022/vpc/#vpc">Amazon Virtual Private Cloud (VPC) - Section 4. How to create a VPC</a>.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
<td class="code"><pre> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">eksctl.io/v1alpha5</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfig</span>
 
 <span class="na">metadata</span><span class="pi">:</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">vujade-cluster</span>
   <span class="na">region</span><span class="pi">:</span> <span class="s">ap-northeast-2</span>
   <span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.21"</span>
  
 <span class="na">vpc</span><span class="pi">:</span>
   <span class="na">subnets</span><span class="pi">:</span>
     <span class="na">private</span><span class="pi">:</span>
       <span class="na">ap-northeast-2a</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">id</span><span class="pi">:</span> <span class="nv">subnet-012a3456b78cde9f0</span> <span class="pi">}</span>
       <span class="na">ap-northeast-2c</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">id</span><span class="pi">:</span> <span class="nv">subnet-0123a4bc5d678e901</span> <span class="pi">}</span>
 <span class="na">secretsEncryption</span><span class="pi">:</span>
   <span class="na">keyARN</span><span class="pi">:</span> <span class="s">arn:aws:kms:ap-northeast-2:123456789123:key/a0b1234c-de5f-6789-g01h-2i3456j789k0</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl create cluster <span class="nt">-f</span> ./cluster.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    2022-01-27 06:49:03 <span class="o">[</span>ℹ]  eksctl version 0.80.0
    2022-01-27 06:49:03 <span class="o">[</span>ℹ]  using region ap-northeast-2
    2022-01-27 06:49:03 <span class="o">[</span>✔]  using existing VPC <span class="o">(</span>vpc-012abcde34fg5678h<span class="o">)</span> and subnets <span class="o">(</span>private:map[ap-northeast-2a:<span class="o">{</span>subnet-012a3456b78cde9f0 ap-northeast-2a 10.172.92.0/23<span class="o">}</span> ap-northeast-2c:<span class="o">{</span>subnet-0123a4bc5d678e901 ap-northeast-2c 10.172.94.0/23<span class="o">}]</span> public:map[]<span class="o">)</span>
    2022-01-27 06:49:03 <span class="o">[!]</span>  custom VPC/subnets will be used<span class="p">;</span> <span class="k">if </span>resulting cluster doesn<span class="s1">'t function as expected, make sure to review the configuration of VPC/subnets
    2022-01-27 06:49:03 [ℹ]  using Kubernetes version 1.21
    2022-01-27 06:49:03 [ℹ]  creating EKS cluster "vujade-cluster" in "ap-northeast-2" region with 
    2022-01-27 06:49:03 [ℹ]  will create a CloudFormation stack for cluster itself and 0 nodegroup stack(s)
    2022-01-27 06:49:03 [ℹ]  will create a CloudFormation stack for cluster itself and 0 managed nodegroup stack(s)
    2022-01-27 06:49:03 [ℹ]  if you encounter any issues, check CloudFormation console or try '</span>eksctl utils describe-stacks <span class="nt">--region</span><span class="o">=</span>ap-northeast-2 <span class="nt">--cluster</span><span class="o">=</span>vujade-cluster<span class="s1">'
    2022-01-27 06:49:03 [ℹ]  Kubernetes API endpoint access will use default of {publicAccess=true, privateAccess=false} for cluster "vujade-cluster" in "ap-northeast-2"
    2022-01-27 06:49:03 [ℹ]  CloudWatch logging will not be enabled for cluster "vujade-cluster" in "ap-northeast-2"
    2022-01-27 06:49:03 [ℹ]  you can enable it with '</span>eksctl utils update-cluster-logging <span class="nt">--enable-types</span><span class="o">={</span>SPECIFY-YOUR-LOG-TYPES-HERE <span class="o">(</span>e.g. all<span class="o">)}</span> <span class="nt">--region</span><span class="o">=</span>ap-northeast-2 <span class="nt">--cluster</span><span class="o">=</span>vujade-cluster<span class="s1">'
    2022-01-27 06:49:03 [ℹ]  
    2 sequential tasks: { create cluster control plane "vujade-cluster", wait for control plane to become ready 
    }
    2022-01-27 06:49:03 [ℹ]  building cluster stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:49:04 [ℹ]  deploying stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:49:34 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:50:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:51:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:52:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:53:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:54:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:55:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:56:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:57:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:58:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 06:59:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 07:00:04 [ℹ]  waiting for CloudFormation stack "eksctl-vujade-cluster-cluster"
    2022-01-27 07:02:05 [ℹ]  waiting for the control plane availability...
    2022-01-27 07:02:05 [✔]  saved kubeconfig as "/home/ubuntu/.kube/config"
    2022-01-27 07:02:05 [ℹ]  no tasks
    2022-01-27 07:02:05 [✔]  all EKS cluster resources for "vujade-cluster" have been created
    2022-01-27 07:02:06 [ℹ]  kubectl command should work with "/home/ubuntu/.kube/config", try '</span>kubectl get nodes<span class="s1">'
    2022-01-27 07:02:06 [✔]  EKS cluster "vujade-cluster" in "ap-northeast-2" region is ready
</span></code></pre></div></div>

<h5 id="2-how-to-check-the-created-cluster">2. How to check the created cluster</h5>
<p>You can check the created cluster with three options.</p>
<ol>
  <li>You can check the cluster on <a href="https://ap-northeast-2.console.aws.amazon.com/cloudformation" target="_blank" rel="noopener noreferrer">CloudFormation</a>.</li>
  <li>You can check the cluster on <a href="https://ap-northeast-2.console.aws.amazon.com/eks/home?region=ap-northeast-2#/clusters" target="_blank" rel="noopener noreferrer">Amazon Container Services - Clusters</a>.</li>
  <li>You can check the cluster with an eksctl command.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> 1 <span class="nv">$ </span>eksctl get cluster
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>     2022-01-27 14:27:46 <span class="o">[</span>ℹ]  eksctl version 0.80.0
     2022-01-27 14:27:46 <span class="o">[</span>ℹ]  using region ap-northeast-2
     NAME            REGION          EKSCTL CREATED
     vujade-cluster  ap-northeast-2  True
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="3-how-to-connect-a-cluster">3. How to connect a cluster</h5>
<p>You can connect the created cluster as follows. Please note that the field, <em>region</em> and <em>name</em> are the AWS region
and the cluster name, respectively.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws eks <span class="nt">--region</span> ap-northeast-2 update-kubeconfig <span class="nt">--name</span> vujade-cluster
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Added new context arn:aws:eks:ap-northeast-2:123456789123:cluster/vujade-cluster to /home/ubuntu/.kube/config
</code></pre></div></div>

<h5 id="4-how-to-delete-a-cluster">4. How to delete a cluster</h5>
<p>You can delete the created cluster as follows. Please note that the field, <em>name</em> is the cluster name.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl delete cluster <span class="nt">--name</span> vujade-cluster
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    2022-01-27 14:27:46 <span class="o">[</span>ℹ]  eksctl version 0.79.0
    2022-01-27 14:27:46 <span class="o">[</span>ℹ]  using region ap-northeast-2
    2022-01-27 14:27:46 <span class="o">[</span>ℹ]  deleting EKS cluster <span class="s2">"vujade-cluster"</span>
    2022-01-27 14:27:46 <span class="o">[</span>ℹ]  deleted 0 Fargate profile<span class="o">(</span>s<span class="o">)</span>
    2022-01-27 14:27:46 <span class="o">[</span>✔]  kubeconfig has been updated
    2022-01-18 07:43:29 <span class="o">[</span>ℹ]  cleaning up AWS load balancers created by Kubernetes objects of Kind Service or Ingress
    2022-01-27 14:27:30 <span class="o">[</span>ℹ]  1 task: <span class="o">{</span> delete cluster control plane <span class="s2">"vujade-cluster"</span> <span class="o">[</span>async] <span class="o">}</span>
    2022-01-27 14:27:30 <span class="o">[</span>ℹ]  will delete stack <span class="s2">"eksctl-vujade-cluster-cluster"</span>
    2022-01-27 14:27:30 <span class="o">[</span>✔]  all cluster resources were deleted
</code></pre></div></div>

<hr>

<h2 id="5-how-to-create-a-node-group-">5. How to create a node group <a name="nodegroup"></a>
</h2>
<h5 id="1-how-to-create-a-node-group">1. How to create a node group</h5>
<p>In about 20 minutes, you can create a node group with a <a href="/assets/blog/AWS/4_EKS/dev/nodegroup/nodegroup.yaml">nodegroup.yaml</a>.
Please note that the node group is based on the
EKS managed node group in this case. I recommend that you should check the field of the yaml file.</p>
<ul>
  <li>metadata:name: vujade-cluster</li>
  <li>metadata:region: ap-northeast-2</li>
  <li>managedNodeGroups:name: ng-dl</li>
  <li>managedNodeGroups:instanceType: g4dn.xlarge</li>
  <li>managedNodeGroups:minSize: 1</li>
  <li>managedNodeGroups:maxSize: 5</li>
  <li>managedNodeGroups:desiredCapacity: 1</li>
  <li>managedNodeGroups:volumeSize: 80</li>
  <li>managedNodeGroups:privateNetworking: true</li>
  <li>managedNodeGroups:ssh:allow: true</li>
  <li>managedNodeGroups:ssh:publicKeyName: vujade-eks</li>
</ul>

<p>The fields, <em>managedNodeGroups:minSize</em>, <em>managedNodeGroups:maxSize</em> and <em>managedNodeGroups:desiredCapacity</em> are
parameters for the Cluster Autoscaler (CA) which scales up and down EC2 instances in node groups.
the <em>managedNodeGroups:volumeSize</em> means the size of the Elastic Block Storage (EBS). The default value is 80.
In this case, the <em>managedNodeGroups:privateNetworking</em> is true because the cluster is private cluster. The value of
the field, <em>managedNodeGroups:ssh:publicKeyName</em> is the name of the SSH key obtained from the
<a href="/blog/2022/cloud9/#aws_ssh">Amazon Web Services (AWS) Cloud9 - Section 7. How to create and import a SSH key</a>.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
<td class="code"><pre> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">eksctl.io/v1alpha5</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfig</span>
 <span class="na">metadata</span><span class="pi">:</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">vujade-cluster</span>
   <span class="na">region</span><span class="pi">:</span> <span class="s">ap-northeast-2</span>
 <span class="na">managedNodeGroups</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ng-dl</span>
     <span class="na">instanceType</span><span class="pi">:</span> <span class="s">g4dn.xlarge</span>
     <span class="na">minSize</span><span class="pi">:</span> <span class="m">1</span>
     <span class="na">maxSize</span><span class="pi">:</span> <span class="m">5</span>
     <span class="na">desiredCapacity</span><span class="pi">:</span> <span class="m">1</span>
     <span class="na">volumeSize</span><span class="pi">:</span> <span class="m">80</span>
     <span class="na">privateNetworking</span><span class="pi">:</span> <span class="kc">true</span>
     <span class="na">ssh</span><span class="pi">:</span>
       <span class="na">allow</span><span class="pi">:</span> <span class="kc">true</span>
       <span class="na">publicKeyName</span><span class="pi">:</span> <span class="s">vujade-eks</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl create nodegroup <span class="nt">-f</span> ./eks_yaml/dev/nodegroup/nodegroup.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  eksctl version 0.80.0
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  using region ap-northeast-2
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  will use version 1.21 <span class="k">for </span>new nodegroup<span class="o">(</span>s<span class="o">)</span> based on control plane version
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  nodegroup <span class="s2">"ng-dl"</span> will use <span class="s2">""</span> <span class="o">[</span>AmazonLinux2/1.21]
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  using EC2 key pair <span class="s2">"vujade-eks"</span>
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  1 nodegroup <span class="o">(</span>ng-dl<span class="o">)</span> was included <span class="o">(</span>based on the include/exclude rules<span class="o">)</span>
    2022-01-27 07:11:22 <span class="o">[</span>ℹ]  will create a CloudFormation stack <span class="k">for </span>each of 1 managed nodegroups <span class="k">in </span>cluster <span class="s2">"vuajde-cluster"</span>
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  
    2 sequential tasks: <span class="o">{</span> fix cluster compatibility, 1 task: <span class="o">{</span> 1 task: <span class="o">{</span> create managed nodegroup <span class="s2">"ng-dl"</span> <span class="o">}</span> <span class="o">}</span> 
    <span class="o">}</span>
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  checking cluster stack <span class="k">for </span>missing resources
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  cluster stack has all required resources
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  building managed nodegroup stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  deploying stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:11:23 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:11:39 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:11:56 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:12:14 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:12:31 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:12:47 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:13:03 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:13:19 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:13:39 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:13:55 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:14:13 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:14:32 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:14:50 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:15:09 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vuajde-cluster-nodegroup-ng-dl"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  1 task: <span class="o">{</span> <span class="nb">install </span>Nvidia device plugin <span class="o">}</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  created <span class="s2">"kube-system:DaemonSet.apps/nvidia-device-plugin-daemonset"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  as you are using the EKS-Optimized Accelerated AMI with a GPU-enabled instance <span class="nb">type</span>, the Nvidia Kubernetes device plugin was automatically installed.
            to skip installing it, use <span class="nt">--install-nvidia-plugin</span><span class="o">=</span>false.
    2022-01-27 07:15:27 <span class="o">[</span>✔]  created 0 nodegroup<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>cluster <span class="s2">"vuajde-cluster"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  nodegroup <span class="s2">"ng-dl"</span> has 1 node<span class="o">(</span>s<span class="o">)</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  node <span class="s2">"ip-10-172-95-87.ap-northeast-2.compute.internal"</span> is ready
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>at least 1 node<span class="o">(</span>s<span class="o">)</span> to become ready <span class="k">in</span> <span class="s2">"ng-dl"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  nodegroup <span class="s2">"ng-dl"</span> has 1 node<span class="o">(</span>s<span class="o">)</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  node <span class="s2">"ip-10-172-95-87.ap-northeast-2.compute.internal"</span> is ready
    2022-01-27 07:15:27 <span class="o">[</span>✔]  created 1 managed nodegroup<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>cluster <span class="s2">"vuajde-cluster"</span>
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  checking security group configuration <span class="k">for </span>all nodegroups
    2022-01-27 07:15:27 <span class="o">[</span>ℹ]  all nodegroups have up-to-date cloudformation templates
</code></pre></div></div>

<h5 id="2-how-to-check-the-created-node-group">2. How to check the created node group</h5>
<ol>
  <li>Check node groups. <br>
You can check node groups as follows.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl get nodegroup <span class="nt">--cluster</span> vujade-cluster
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> 2022-01-28 00:47:46 <span class="o">[</span>ℹ]  eksctl version 0.80.0
 2022-01-28 00:47:46 <span class="o">[</span>ℹ]  using region ap-northeast-2
 CLUSTER         NODEGROUP       STATUS  CREATED                 MIN SIZE        MAX SIZE        DESIRED CAPACITY        INSTANCE TYPE   IMAGE ID        ASG NAME
 vujade-cluster  ng-dl           ACTIVE  2022-01-27T07:12:18Z    1               5               1                       g4dn.xlarge     AL2_x86_64_GPU  eks-ng-dl-0abc1d23-01a2-0a12-012a-a0bc1234d5e6
</code></pre></div>    </div>
  </li>
  <li>Check nodes. <br>
You can also check nodes in the node groups. Please note that you should connect the created cluster as described in
<a href="#cluster">Section 5. How to create a cluster</a> before listing nodes below.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get nodes <span class="nt">--show-labels</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> NAME                                              STATUS   ROLES    AGE   VERSION               LABELS
 ip-10-172-95-87.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   17h   v1.21.5-eks-9017834   alpha.eksctl.io/cluster-name<span class="o">=</span>vujade-cluster,alpha.eksctl.io/nodegroup-name<span class="o">=</span>ng-dl,beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/instance-type<span class="o">=</span>g4dn.xlarge,beta.kubernetes.io/os<span class="o">=</span>linux,eks.amazonaws.com/capacityType<span class="o">=</span>ON_DEMAND,eks.amazonaws.com/nodegroup-image<span class="o">=</span>ami-04a860d4e53598406,eks.amazonaws.com/nodegroup<span class="o">=</span>ng-dl,eks.amazonaws.com/sourceLaunchTemplateId<span class="o">=</span>lt-0fbc06a2d297490d2,eks.amazonaws.com/sourceLaunchTemplateVersion<span class="o">=</span>1,failure-domain.beta.kubernetes.io/region<span class="o">=</span>ap-northeast-2,failure-domain.beta.kubernetes.io/zone<span class="o">=</span>ap-northeast-2c,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>ip-10-172-95-87.ap-northeast-2.compute.internal,kubernetes.io/os<span class="o">=</span>linux,node.kubernetes.io/instance-type<span class="o">=</span>g4dn.xlarge,topology.kubernetes.io/region<span class="o">=</span>ap-northeast-2,topology.kubernetes.io/zone<span class="o">=</span>ap-northeast-2c
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="3-how-to-delete-a-node-group">3. How to delete a node group</h5>
<p>You can delete a node group as follows.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl delete nodegroup <span class="nt">--region</span><span class="o">=</span>ap-northeast-2 <span class="nt">--cluster</span><span class="o">=</span>vujade-cluster <span class="nt">--name</span><span class="o">=</span>ng-dl
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  eksctl version 0.79.0
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  using region ap-northeast-2
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  1 nodegroup <span class="o">(</span>ng-dl<span class="o">)</span> was included <span class="o">(</span>based on the include/exclude rules<span class="o">)</span>
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  will drain 1 nodegroup<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>cluster <span class="s2">"vujade-cluster"</span>
    2022-01-18 07:41:36 <span class="o">[!]</span>  no nodes found <span class="k">in </span>nodegroup <span class="s2">"ng-dl"</span> <span class="o">(</span>label selector: <span class="s2">"alpha.eksctl.io/nodegroup-name=ng-dl"</span><span class="o">)</span>
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  will delete 1 nodegroups from cluster <span class="s2">"vujade-cluster"</span>
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  1 task: <span class="o">{</span> 1 task: <span class="o">{</span> delete nodegroup <span class="s2">"ng-dl"</span> <span class="o">[</span>async] <span class="o">}</span> <span class="o">}</span>
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  will delete stack <span class="s2">"eksctl-vujade-cluster-nodegroup-ng-dl"</span>
    2022-01-18 07:41:36 <span class="o">[</span>ℹ]  will delete 0 nodegroups from auth ConfigMap <span class="k">in </span>cluster <span class="s2">"vujade-cluster"</span>
    2022-01-18 07:41:36 <span class="o">[</span>✔]  deleted 1 nodegroup<span class="o">(</span>s<span class="o">)</span> from cluster <span class="s2">"vujade-cluster"</span>
</code></pre></div></div>

<hr>

<h2 id="6-how-to-configure-a-cluster-autoscaler-ca-">6. How to configure a cluster autoscaler (CA) <a name="ca"></a>
</h2>
<p>You can configure a cluster autoscaler (CA) by executing following commands. You can get more information in the AWS EKS
workshop guide, <a href="https://www.eksworkshop.com/beginner/080_scaling/deploy_ca" target="_blank" rel="noopener noreferrer">Configure Cluster Autoscaler (CA)</a>.
Please note the CA only works when there is a node group at least.</p>

<p>I provide a bash script, <a href="/assets/blog/AWS/4_EKS/bash_install_ca.sh">bash_install_ca.sh</a> to install the CA easily. Please
note that you can get the <em>ACCOUNT_ID</em> in the <a href="/blog/2022/cloud9/#aws_cmk">Amazon Web Services (AWS) Cloud9 - Section 8. How to create an AWS KMS
custom managed key (CMK)</a>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>bash ./bash_install_ca.sh NAME_CLUSTER ACCOUNT_ID
</code></pre></div></div>

<h5 id="1-iam-roles-for-service-accounts">1. IAM roles for service accounts</h5>
<ol>
  <li>Enabling IAM roles for service accounts on your cluster (i.e. Creating IAM OIDC provider).
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl utils associate-iam-oidc-provider <span class="nt">--cluster</span> vujade-cluster <span class="nt">--approve</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> 2022-01-28 08:41:31 <span class="o">[</span>ℹ]  eksctl version 0.80.0
 2022-01-28 08:41:31 <span class="o">[</span>ℹ]  using region ap-northeast-2
 2022-01-28 08:41:32 <span class="o">[</span>ℹ]  will create IAM Open ID Connect provider <span class="k">for </span>cluster <span class="s2">"vujade-cluster"</span> <span class="k">in</span> <span class="s2">"ap-northeast-2"</span>
 2022-01-28 08:41:32 <span class="o">[</span>✔]  created IAM Open ID Connect provider <span class="k">for </span>cluster <span class="s2">"vujade-cluster"</span> <span class="k">in</span> <span class="s2">"ap-northeast-2"</span>
</code></pre></div>    </div>
  </li>
  <li>Creating an IAM policy for your service account that will allow your CA pod to interact with the autoscaling groups. <br>
You can create the IAM policy with <a href="/assets/blog/AWS/4_EKS/k8s-asg-policy.json">k8s-asg-policy.json</a> as below. Please
note that you don’t need to create the customer managed IAM policy if it already exists as below.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws iam create-policy <span class="nt">--policy-name</span> k8s-asg-policy <span class="nt">--policy-document</span> file://./k8s-asg-policy.json
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> An error occurred <span class="o">(</span>EntityAlreadyExists<span class="o">)</span> when calling the CreatePolicy operation: A policy called k8s-asg-policy already exists. Duplicate names are not allowed.
</code></pre></div>    </div>
  </li>
  <li>Finally, create an IAM role for the cluster-autoscaler Service Account in the kube-system namespace. <br>
You can obtain the policy ARN in <a href="https://console.aws.amazon.com/iamv2/home#/policies" target="_blank" rel="noopener noreferrer">IAM - Policies</a> with k8s-asg-policy.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl create iamserviceaccount <span class="se">\</span>
2   <span class="nt">--name</span> cluster-autoscaler <span class="se">\</span>
3   <span class="nt">--namespace</span> kube-system <span class="se">\</span>
4   <span class="nt">--cluster</span> vujade-cluster <span class="se">\</span>
5   <span class="nt">--attach-policy-arn</span> <span class="s2">"arn:aws:iam::123456789123:policy/k8s-asg-policy"</span> <span class="se">\</span>
6   <span class="nt">--approve</span> <span class="se">\</span>
7   <span class="nt">--override-existing-serviceaccounts</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> 2022-01-28 09:15:51 <span class="o">[</span>ℹ]  eksctl version 0.80.0
 2022-01-28 09:15:51 <span class="o">[</span>ℹ]  using region ap-northeast-2
 2022-01-28 09:15:52 <span class="o">[</span>ℹ]  1 iamserviceaccount <span class="o">(</span>kube-system/cluster-autoscaler<span class="o">)</span> was included <span class="o">(</span>based on the include/exclude rules<span class="o">)</span>
 2022-01-28 09:15:52 <span class="o">[!]</span>  metadata of serviceaccounts that exist <span class="k">in </span>Kubernetes will be updated, as <span class="nt">--override-existing-serviceaccounts</span> was <span class="nb">set
 </span>2022-01-28 09:15:52 <span class="o">[</span>ℹ]  1 task: <span class="o">{</span> 
     2 sequential sub-tasks: <span class="o">{</span> 
         create IAM role <span class="k">for </span>serviceaccount <span class="s2">"kube-system/cluster-autoscaler"</span>,
         create serviceaccount <span class="s2">"kube-system/cluster-autoscaler"</span>,
     <span class="o">}</span> <span class="o">}</span>2022-01-28 09:15:52 <span class="o">[</span>ℹ]  building iamserviceaccount stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span>
 2022-01-28 09:15:52 <span class="o">[</span>ℹ]  deploying stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span>
 2022-01-28 09:15:52 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span>
 2022-01-28 09:16:12 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span>
 2022-01-28 09:16:27 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-cluster-autoscaler"</span>
 2022-01-28 09:16:27 <span class="o">[</span>ℹ]  created serviceaccount <span class="s2">"kube-system/cluster-autoscaler"</span>
</code></pre></div>    </div>
  </li>
  <li>Make sure your service account with the ARN of the IAM role is annotated. <br>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system describe sa cluster-autoscaler 
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> Name:                cluster-autoscaler
 Namespace:           kube-system
 Labels:              app.kubernetes.io/managed-by<span class="o">=</span>eksctl
 Annotations:         eks.amazonaws.com/role-arn: arn:aws:iam::123456789123:role/eksctl-vujade-cluster-addon-iamserviceaccount-Role1-1DOGJCHJ8OE45
 Image pull secrets:  &lt;none&gt;
 Mountable secrets:   cluster-autoscaler-token-29s2h
 Tokens:              cluster-autoscaler-token-29s2h
 Events:              &lt;none&gt;
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="2-deploy-the-cluster-autoscaler-ca">2. Deploy the Cluster Autoscaler (CA)</h5>
<ol>
  <li>Deploy the Cluster Autoscaler to your cluster with the following command. <br>
You can get a yaml file for deploying a cluster from <a href="https://www.eksworkshop.com/beginner/080_scaling/deploy_ca.files/cluster-autoscaler-autodiscover.yaml" target="_blank" rel="noopener noreferrer">official EKS workshop site</a>
or <a href="/assets/blog/AWS/4_EKS/cluster-autoscaler-autodiscover.yaml">my GitHub</a>. Please note that you should modify the
cluster name to yours.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ./cluster-autoscaler-autodiscover.yaml
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> clusterrole.rbac.authorization.k8s.io/cluster-autoscaler created
 role.rbac.authorization.k8s.io/cluster-autoscaler created
 clusterrolebinding.rbac.authorization.k8s.io/cluster-autoscaler created
 rolebinding.rbac.authorization.k8s.io/cluster-autoscaler created
 deployment.apps/cluster-autoscaler created
</code></pre></div>    </div>
  </li>
  <li>To prevent CA from removing nodes where its own pod is running, we will add the
cluster-autoscaler.kubernetes.io/safe-to-evict annotation to its deployment with the following command.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system annotate deployment.apps/cluster-autoscaler cluster-autoscaler.kubernetes.io/safe-to-evict<span class="o">=</span><span class="s2">"false"</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> deployment.apps/cluster-autoscaler annotated
</code></pre></div>    </div>
  </li>
  <li>Finally let’s update the autoscaler image.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">export </span><span class="nv">K8S_VERSION</span><span class="o">=</span><span class="si">$(</span>kubectl version <span class="nt">--short</span> | <span class="nb">grep</span> <span class="s1">'Server Version:'</span> | <span class="nb">sed</span> <span class="s1">'s/[^0-9.]*\([0-9.]*\).*/\1/'</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="nb">.</span> <span class="nt">-f1</span>,2<span class="si">)</span>
2 <span class="nv">$ </span><span class="nb">export </span><span class="nv">AUTOSCALER_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="s2">"https://api.github.com/repos/kubernetes/autoscaler/releases"</span> | <span class="nb">grep</span> <span class="s1">'"tag_name":'</span> | <span class="nb">sed</span> <span class="nt">-s</span> <span class="s1">'s/.*-\([0-9][0-9\.]*\).*/\1/'</span> | <span class="nb">grep</span> <span class="nt">-m1</span> <span class="k">${</span><span class="nv">K8S_VERSION</span><span class="k">}</span><span class="si">)</span>
3 <span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">set </span>image deployment.apps/cluster-autoscaler cluster-autoscaler<span class="o">=</span>us.gcr.io/k8s-artifacts-prod/autoscaling/cluster-autoscaler:v<span class="k">${</span><span class="nv">AUTOSCALER_VERSION</span><span class="k">}</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> deployment.apps/cluster-autoscaler image updated
</code></pre></div>    </div>
  </li>
  <li>You can watch logs.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-f</span> deployment/cluster-autoscaler
</code></pre></div>    </div>
  </li>
  <li>Check the created cluster autoscaler.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get deploy <span class="nt">-A</span> 
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> NAMESPACE     NAME                 READY   UP-TO-DATE   AVAILABLE   AGE
 kube-system   cluster-autoscaler   1/1     1            1           7m39s
 kube-system   coredns              2/2     2            2           28h
</code></pre></div>    </div>
  </li>
</ol>

<hr>

<h2 id="7-how-to-install-the-aws-load-balancer-controller-">7. How to install the AWS load balancer controller <a name="aws_lbc"></a>
</h2>
<p>You can install the AWS load balanacer controller by executing following commands. You can get more information in the
<a href="https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html" target="_blank" rel="noopener noreferrer">AWS Load Balancer Controller</a>,
<a href="https://www.eksworkshop.com/beginner/130_exposing-service/ingress_controller_alb" target="_blank" rel="noopener noreferrer">Ingress Controller</a> and
<a href="https://www.eksworkshop.com/020_prerequisites/k8stools/#set-the-aws-load-balancer-controller-version" target="_blank" rel="noopener noreferrer">Install Kubernetes Tools</a>.</p>

<p>I provide a bash script, <a href="/assets/blog/AWS/4_EKS/bash_install_lbc.sh">bash_install_lbc.sh</a> to install the AWS load
balancer controller easily. Please note that you can get the <em>ACCOUNT_ID</em> and <em>NAME_ROLE_AWS_LBC</em> in the
<a href="/blog/2022/cloud9/#aws_cmk">Amazon Web Services (AWS) Cloud9 - Section 8. How to create an AWS KMS custom managed key (CMK)</a>
and <a href="#role_aws_lbc">Step 7. Attach the IAM policy to the IAM role</a>, respectively.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>bash ./bash_install_lbc.sh NAME_CLUSTER ACCOUNT_ID NAME_ROLE_AWS_LBC
</code></pre></div></div>

<h5 id="1-deploy-the-aws-load-balancer-controller">1. Deploy the AWS Load Balancer Controller</h5>
<ol>
  <li>We will verify if the AWS Load Balancer Controller version has been set.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'export LBC_VERSION="v2.3.1"'</span> <span class="o">&gt;&gt;</span>  ~/.bash_profile
2 <span class="nv">$ </span><span class="nb">.</span> ~/.bash_profile
3 <span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-x</span> <span class="k">${</span><span class="nv">LBC_VERSION</span><span class="k">}</span> <span class="o">]</span>
4     <span class="k">then
</span>5       tput setaf 2<span class="p">;</span> <span class="nb">echo</span> <span class="s1">'${LBC_VERSION} has been set.'</span>
6     <span class="k">else
</span>7       tput setaf 1<span class="p">;</span> <span class="nb">echo</span> <span class="s1">'${LBC_VERSION} has NOT been set.'</span>
8   <span class="k">fi</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="k">${</span><span class="nv">LBC_VERSION</span><span class="k">}</span> has been set.
</code></pre></div>    </div>
  </li>
  <li>Create IAM OIDC provider. <br>
You can skip this step if you already execute the command in <a href="#ca">7. How to configure a cluster autoscaler (CA)</a>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl utils associate-iam-oidc-provider <span class="nt">--cluster</span> vujade-cluster <span class="nt">--approve</span>
</code></pre></div>    </div>
  </li>
  <li>Create an IAM policy, AWSLoadBalancerControllerIAMPolicy. <br>
Please note that you don’t need to create the customer managed IAM policy if it already exists as below.
You can also download the <a href="/assets/blog/AWS/4_EKS/iam_policy.json">iam_policy.json</a>.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>curl <span class="nt">-o</span> iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.3.1/docs/install/iam_policy.json
2 <span class="nv">$ </span>aws iam create-policy <span class="se">\</span>
3   <span class="nt">--policy-name</span> AWSLoadBalancerControllerIAMPolicy <span class="se">\</span>
4   <span class="nt">--policy-document</span> file://iam_policy.json
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> An error occurred <span class="o">(</span>EntityAlreadyExists<span class="o">)</span> when calling the CreatePolicy operation: A policy called AWSLoadBalancerControllerIAMPolicy already exists. Duplicate names are not allowed.
</code></pre></div>    </div>
  </li>
  <li>Create a IAM role and ServiceAccount. <br>
You can obtain the policy ARN in <a href="https://console.aws.amazon.com/iamv2/home#/policies" target="_blank" rel="noopener noreferrer">IAM - Policies</a> with AWSLoadBalancerControllerIAMPolicy.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>eksctl create iamserviceaccount <span class="se">\</span>
2   <span class="nt">--cluster</span> vujade-cluster <span class="se">\</span>
3   <span class="nt">--namespace</span> kube-system <span class="se">\</span>
4   <span class="nt">--name</span> aws-load-balancer-controller <span class="se">\</span>
5   <span class="nt">--attach-policy-arn</span> arn:aws:iam::123456789123:policy/AWSLoadBalancerControllerIAMPolicy <span class="se">\</span>
6   <span class="nt">--override-existing-serviceaccounts</span> <span class="se">\</span>
7   <span class="nt">--approve</span>
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> 2022-01-28 13:32:15 <span class="o">[</span>ℹ]  eksctl version 0.80.0
 2022-01-28 13:32:15 <span class="o">[</span>ℹ]  using region ap-northeast-2
 2022-01-28 13:32:16 <span class="o">[</span>ℹ]  1 existing iamserviceaccount<span class="o">(</span>s<span class="o">)</span> <span class="o">(</span>kube-system/cluster-autoscaler<span class="o">)</span> will be excluded
 2022-01-28 13:32:16 <span class="o">[</span>ℹ]  1 iamserviceaccount <span class="o">(</span>kube-system/aws-load-balancer-controller<span class="o">)</span> was included <span class="o">(</span>based on the include/exclude rules<span class="o">)</span>
 2022-01-28 13:32:16 <span class="o">[!]</span>  metadata of serviceaccounts that exist <span class="k">in </span>Kubernetes will be updated, as <span class="nt">--override-existing-serviceaccounts</span> was <span class="nb">set
 </span>2022-01-28 13:32:16 <span class="o">[</span>ℹ]  1 task: <span class="o">{</span> 
     2 sequential sub-tasks: <span class="o">{</span> 
         create IAM role <span class="k">for </span>serviceaccount <span class="s2">"kube-system/aws-load-balancer-controller"</span>,
         create serviceaccount <span class="s2">"kube-system/aws-load-balancer-controller"</span>,
     <span class="o">}</span> <span class="o">}</span>2022-01-28 13:32:16 <span class="o">[</span>ℹ]  building iamserviceaccount stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span>
 2022-01-28 13:32:16 <span class="o">[</span>ℹ]  deploying stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span>
 2022-01-28 13:32:16 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span>
 2022-01-28 13:32:34 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span>
 2022-01-28 13:32:53 <span class="o">[</span>ℹ]  waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"</span>
 2022-01-28 13:32:54 <span class="o">[</span>ℹ]  created serviceaccount <span class="s2">"kube-system/aws-load-balancer-controller"</span>
</code></pre></div>    </div>
  </li>
  <li>Download the IAM policy. <br>
You can also download the <a href="/assets/blog/AWS/4_EKS/iam_policy_v1_to_v2_additional.json">iam_policy_v1_to_v2_additional.json</a>.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>curl <span class="nt">-o</span> iam_policy_v1_to_v2_additional.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.3.1/docs/install/iam_policy_v1_to_v2_additional.json 
</code></pre></div>    </div>
  </li>
  <li>Create the IAM policy and note the ARN that is returned. <br>
Please note that you don’t need to create the customer managed IAM policy if it already exists as below.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws iam create-policy <span class="se">\</span>
2   <span class="nt">--policy-name</span> AWSLoadBalancerControllerAdditionalIAMPolicy <span class="se">\</span>
3   <span class="nt">--policy-document</span> file://iam_policy_v1_to_v2_additional.json 
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> An error occurred <span class="o">(</span>EntityAlreadyExists<span class="o">)</span> when calling the CreatePolicy operation: A policy called AWSLoadBalancerControllerAdditionalIAMPolicy already exists. Duplicate names are not allowed.
</code></pre></div>    </div>
  </li>
  <li>Attach the IAM policy to the IAM role. <a name="role_aws_lbc"><br>
You can find the role name as follows:
</a>    <ul>
     <li>Open the AWS CloudFormation console</li>
     <li>Select the eksctl-your-cluster-name-addon-iamserviceaccount-kube-system-aws-load-balancer-controller stack.</li>
     <li>Click the Resources tab.</li>
     <li>The role name is in the Physical ID column. bag</li>
 </ul>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>aws iam attach-role-policy <span class="se">\</span>
2   <span class="nt">--role-name</span> eksctl-vujade-cluster-addon-iamserviceaccount-Role1-1ABC2D3E4FGHI <span class="se">\</span>
3   <span class="nt">--policy-arn</span> arn:aws:iam::123456789123:policy/AWSLoadBalancerControllerAdditionalIAMPolicy 
</code></pre></div>    </div>
  </li>
  <li>Add the eks-charts repository.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>helm repo add eks https://aws.github.io/eks-charts
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="s2">"eks"</span> has been added to your repositories
</code></pre></div>    </div>
  </li>
  <li>Update your local repo to make sure that you have the most recent charts.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>helm repo update
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> Hang tight <span class="k">while </span>we grab the latest from your chart repositories...
 ...Successfully got an update from the <span class="s2">"eks"</span> chart repository
 ...Successfully got an update from the <span class="s2">"stable"</span> chart repository
 Update Complete. ⎈Happy Helming!⎈
</code></pre></div>    </div>
  </li>
  <li>Install the TargetGroupBinding CRDs.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-k</span> <span class="s2">"github.com/aws/eks-charts/stable/aws-load-balancer-controller/crds?ref=master"</span>
2 <span class="nv">$ </span>kubectl get crd 
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>customresourcedefinition.apiextensions.k8s.io/ingressclassparams.elbv2.k8s.aws created
customresourcedefinition.apiextensions.k8s.io/targetgroupbindings.elbv2.k8s.aws created
    
NAME                                         CREATED AT
eniconfigs.crd.k8s.amazonaws.com             2022-01-27T06:57:16Z
ingressclassparams.elbv2.k8s.aws             2022-01-28T13:59:28Z
securitygrouppolicies.vpcresources.k8s.aws   2022-01-27T06:57:19Z
targetgroupbindings.elbv2.k8s.aws            2022-01-28T13:59:28Z
</code></pre></div>    </div>
  </li>
  <li>Install the AWS Load Balancer Controller.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>helm <span class="nb">install </span>aws-load-balancer-controller eks/aws-load-balancer-controller <span class="se">\</span>
2   <span class="nt">-n</span> kube-system <span class="se">\</span>
3   <span class="nt">--set</span> <span class="nv">clusterName</span><span class="o">=</span>vujade-cluster <span class="se">\</span>
4   <span class="nt">--set</span> serviceAccount.create<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
5   <span class="nt">--set</span> serviceAccount.name<span class="o">=</span>aws-load-balancer-controller
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>NAME: aws-load-balancer-controller
LAST DEPLOYED: Fri Jan 28 14:02:37 2022
NAMESPACE: kube-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
AWS Load Balancer controller installed!
</code></pre></div>    </div>
  </li>
  <li>Verify that the controller is installed.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get deployment <span class="nt">-n</span> kube-system aws-load-balancer-controller 
</code></pre></div>    </div>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
aws-load-balancer-controller   2/2     2            2           38s
</code></pre></div>    </div>
  </li>
</ol>
<hr>

<h2 id="8-how-to-install-a-metric-server-">8. How to install a metric server <a name="metric_server"></a>
</h2>
<p>You can install a metric server which is a scalable, efficient source of container resource metrics for Kubernetes
built-in autoscaling pipelines by executing following commands. You can get more information in the 
<a href="https://www.eksworkshop.com/beginner/080_scaling/deploy_hpa" target="_blank" rel="noopener noreferrer">Configure Horizontal Pod Autoscaler (HPA)</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.5.0/components.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    serviceaccount/metrics-server created
    clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
    clusterrole.rbac.authorization.k8s.io/system:metrics-server created
    rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
    clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
    clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
    service/metrics-server created
    deployment.apps/metrics-server created
    apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get apiservice v1beta1.metrics.k8s.io <span class="nt">-o</span> json | jq <span class="s1">'.status'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">{</span>
      <span class="s2">"conditions"</span>: <span class="o">[</span>
        <span class="o">{</span>
          <span class="s2">"lastTransitionTime"</span>: <span class="s2">"2022-01-28T14:15:04Z"</span>,
          <span class="s2">"message"</span>: <span class="s2">"all checks passed"</span>,
          <span class="s2">"reason"</span>: <span class="s2">"Passed"</span>,
          <span class="s2">"status"</span>: <span class="s2">"True"</span>,
          <span class="s2">"type"</span>: <span class="s2">"Available"</span>
        <span class="o">}</span>
      <span class="o">]</span>
    <span class="o">}</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get pods <span class="nt">-A</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAMESPACE     NAME                                           READY   STATUS    RESTARTS   AGE
    kube-system   aws-load-balancer-controller-cb56f956d-cmvh7   1/1     Running   0          13m
    kube-system   aws-load-balancer-controller-cb56f956d-d76rf   1/1     Running   0          13m
    kube-system   aws-node-frdxk                                 1/1     Running   0          31h
    kube-system   cluster-autoscaler-77d7c6c9b8-8bzck            1/1     Running   0          155m
    kube-system   coredns-6dbb778559-2dhqq                       1/1     Running   0          31h
    kube-system   coredns-6dbb778559-t4twm                       1/1     Running   0          31h
    kube-system   kube-proxy-glbbl                               1/1     Running   0          31h
    kube-system   metrics-server-6dfddc5fb8-zq97v                1/1     Running   0          111s
    kube-system   nvidia-device-plugin-daemonset-q2fbv           1/1     Running   0          31h
</code></pre></div></div>
<hr>

<h2 id="9-how-to-apply-a-namespace-">9. How to apply a namespace <a name="namespace"></a>
</h2>
<h5 id="1-preparations">1. Preparations</h5>
<p>You can check the <a href="/assets/blog/AWS/4_EKS/dev/namespace/namespace.yaml">namespace.yaml</a>.</p>

<h5 id="2-how-to-apply-a-namespace">2. How to apply a namespace</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> namespace.yaml 
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    namespace/ns-vujade created
</code></pre></div></div>

<h5 id="3-how-to-check-the-applied-namespace">3. How to check the applied namespace</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get namespace
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAME              STATUS   AGE
    default           Active   2d4h
    kube-node-lease   Active   2d4h
    kube-public       Active   2d4h
    kube-system       Active   2d4h
    ns-vujade         Active   50s
</code></pre></div></div>

<h5 id="4-how-to-delete-the-applied-namespace">4. How to delete the applied namespace</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> namespace.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    namespace <span class="s2">"ns-vujade"</span> deleted
</code></pre></div></div>

<hr>

<h2 id="10-how-to-apply-a-deployment-">10. How to apply a deployment <a name="deployment"></a>
</h2>
<h5 id="1-preparations-1">1. Preparations</h5>
<p>You can check the <a href="/assets/blog/AWS/4_EKS/dev/deployment/dep_dl.yaml">dep_dl.yaml</a>.</p>

<h5 id="2-how-to-apply-a-deployment">2. How to apply a deployment</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> deployment.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    deployment.apps/dep-dl created
</code></pre></div></div>

<h5 id="3-how-to-check-the-applied-deployment">3. How to check the applied deployment</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get deployment <span class="nt">-A</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAMESPACE     NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
    kube-system   aws-load-balancer-controller   2/2     2            2           21h
    kube-system   cluster-autoscaler             1/1     1            1           23h
    kube-system   coredns                        2/2     2            2           2d4h
    kube-system   metrics-server                 1/1     1            1           21h
    ns-vujade     dep-dl                         3/3     3            3           32s
</code></pre></div></div>

<h5 id="4-how-to-delete-the-applied-deployment">4. How to delete the applied deployment</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> deployment.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    deployment.apps <span class="s2">"dep-dl"</span> deleted
</code></pre></div></div>

<hr>

<h2 id="11-how-to-apply-a-service-">11. How to apply a service <a name="service"></a>
</h2>
<h5 id="1-preparations-2">1. Preparations</h5>
<p>You can check the <a href="/assets/blog/AWS/4_EKS/dev/service/svc_dl.yaml">svc_dl.yaml</a>.</p>

<h5 id="2-how-to-apply-a-service">2. How to apply a service</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> service.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    service/svc-dl created
</code></pre></div></div>

<h5 id="3-how-to-check-the-applied-service">3. How to check the applied service</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get service <span class="nt">-A</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAMESPACE     NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>           AGE
    default       kubernetes                          ClusterIP   172.20.0.1       &lt;none&gt;        443/TCP           2d4h
    kube-system   aws-load-balancer-webhook-service   ClusterIP   172.20.122.144   &lt;none&gt;        443/TCP           21h
    kube-system   kube-dns                            ClusterIP   172.20.0.10      &lt;none&gt;        53/UDP,53/TCP     2d4h
    kube-system   metrics-server                      ClusterIP   172.20.46.230    &lt;none&gt;        443/TCP           21h
    ns-vujade     svc-dl                              NodePort    172.20.205.201   &lt;none&gt;        11001:31803/TCP   15s
</code></pre></div></div>

<h5 id="4-how-to-delete-the-applied-service">4. How to delete the applied service</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> service.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    service <span class="s2">"svc-dl"</span> deleted
</code></pre></div></div>

<hr>

<h2 id="12-how-to-apply-a-horizontal-pod-autoscaler-hpa-">12. How to apply a horizontal pod autoscaler (HPA) <a name="hpa"></a>
</h2>
<h5 id="1-preparations-3">1. Preparations</h5>
<p>You can check the <a href="/assets/blog/AWS/4_EKS/dev/hpa/hpa_dl.yaml">hpa_dl.yaml</a>.</p>

<h5 id="2-how-to-apply-a-hpa">2. How to apply a HPA</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> hpa.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    horizontalpodautoscaler.autoscaling/hpa-dl created
</code></pre></div></div>

<h5 id="3-how-to-check-the-applied-hpa">3. How to check the applied HPA</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get hpa <span class="nt">-A</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAMESPACE   NAME     REFERENCE           TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
    ns-vujade   hpa-dl   Deployment/dep-dl   0%/65%    3         12        3          20s
</code></pre></div></div>

<h5 id="4-how-to-delete-the-applied-hpa">4. How to delete the applied HPA</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> hpa.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    horizontalpodautoscaler.autoscaling <span class="s2">"hpa-dl"</span> deleted
</code></pre></div></div>

<h5 id="5-how-does-the-hpa-work">5. How does the HPA work?</h5>
<p>The HPA is based on how many resources are being used compared to the requests allocated to the pod.
In other words, the condition for scale-out of pods by the HPA as follows:</p>

<p>\begin{equation}
\label{eq:cauchy-schwarz}
averageUtilization \le 100 * \frac{CPU_{Total}}{N_{Pod} \times CPU_{Request}}
\end{equation}</p>

<ul>
  <li>
<strong><em>CPU<sub>Total</sub></em></strong> is the total central processing unit (CPU) usage in a worker node.</li>
  <li>
<strong><em>N<sub>Pod</sub></em></strong> is the number of pod in a worker node.</li>
  <li>
<strong><em>CPU<sub>Request</sub></em></strong> is assigned in the deployment. It means minimum resources that the CPU must be guaranteed.
Please note that the CPU usage is controlled in units of milli-cores (i.e m) by the Kubernetes. A single CPU is
equivalent to 1m.</li>
</ul>

<hr>

<h2 id="13-how-to-apply-an-ingress-">13. How to apply an ingress <a name="ingress"></a>
</h2>
<h5 id="1-preparations-4">1. Preparations</h5>
<p>You can check the <a href="/assets/blog/AWS/4_EKS/dev/ingress/ingress.yaml">ingress.yaml</a>.</p>

<h5 id="2-how-to-apply-an-ingress">2. How to apply an ingress</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ingress.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ingress.extensions/alb-ing-eks-vujade created
</code></pre></div></div>

<h5 id="3-how-to-check-the-applied-ingress">3. How to check the applied ingress</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get ingress <span class="nt">-A</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAMESPACE   NAME                  CLASS    HOSTS   ADDRESS                                                                                PORTS   AGE
    ns-vujade   alb-ing-eks-vujade   &lt;none&gt;   <span class="k">*</span>       internal-k8s-nsvujade-albingea-1716e099f7-114012471.ap-northeast-2.elb.amazonaws.com   80      54s
</code></pre></div></div>

<h5 id="4-how-to-delete-the-applied-ingress">4. How to delete the applied ingress</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> ingress.yaml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ingress.extensions <span class="s2">"alb-ing-eks-vujade"</span> deleted
</code></pre></div></div>

<hr>

<h2 id="14-useful-kubectl-commands-">14. Useful kubectl commands <a name="kubectl_commands"></a>
</h2>
<h5 id="1-how-to-list-nodes-in-details">1. How to list nodes in details</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get nodes <span class="nt">-A</span> <span class="nt">-o</span> wide
</code></pre></div></div>

<h5 id="2-how-to-list-pods-in-details">2. How to list pods in details</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl get pods <span class="nt">-A</span> <span class="nt">-o</span> wide
</code></pre></div></div>

<h5 id="3-how-to-watch-logs-for-a-pod">3. How to watch logs for a pod</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl logs <span class="nt">-f</span> <span class="nt">--namespace</span> <span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span> <span class="k">${</span><span class="nv">NAME_POD</span><span class="k">}</span>
</code></pre></div></div>

<h5 id="4-how-to-execute-a-command-for-a-pod">4. How to execute a command for a pod</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">--namespace</span> <span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span> <span class="k">${</span><span class="nv">NAME_POD</span><span class="k">}</span> <span class="k">${</span><span class="nv">COMMAND</span><span class="k">}</span>
</code></pre></div></div>

<hr>

<h2 id="15-how-to-fix-error-">15. How to fix error <a name="fix_error"></a>
</h2>
<h5 id="1-cannot-create-a-node-group">1. Cannot create a node group</h5>
<p>When the node is deployed in a private subnet, the subnet must have a route to a NAT gateway where a public IP address is assigned.
<a href="/blog/2022/vpc/#route_table_nat">Amazon Virtual Private Cloud (VPC) - Section 10. How to set up a route table for the NAT gateway</a>.
The error messages are as follows.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    2022-01-18 08:32:14 <span class="o">[</span>✖]  unexpected status <span class="s2">"ROLLBACK_IN_PROGRESS"</span> <span class="k">while </span>waiting <span class="k">for </span>CloudFormation stack <span class="s2">"eksctl-vujade-cluster-nodegroup-ng-dl"</span>
    2022-01-18 08:32:14 <span class="o">[</span>ℹ]  fetching stack events <span class="k">in </span>attempt to troubleshoot the root cause of the failure
    2022-01-18 08:32:14 <span class="o">[</span>✖]  AWS::EKS::Nodegroup/ManagedNodeGroup: CREATE_FAILED – <span class="s2">"Nodegroup ng-dl failed to stabilize: [{Code: NodeCreationFailure,Message: Instances failed to join the kubernetes cluster,ResourceIds: [i-0a12bc3d45e67fg8h]}]"</span>
    2022-01-18 08:32:14 <span class="o">[</span>ℹ]  1 error<span class="o">(</span>s<span class="o">)</span> occurred and nodegroups haven<span class="s1">'t been created properly, you may wish to check CloudFormation console
</span></code></pre></div></div>

<hr>

<h2 id="16-reference-">16. Reference <a name="ref"></a>
</h2>
<ol>
  <li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" title="Regions and Zones" target="_blank" rel="noopener noreferrer"> Regions and Zones</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes" title="What is Kubernetes?" target="_blank" rel="noopener noreferrer"> What is Kubernetes?</a></li>
  <li><a href="https://aws.amazon.com/eks/features" title="Amazon EKS features" target="_blank" rel="noopener noreferrer"> Amazon EKS features</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/clusters.html" title="Amazon EKS clusters" target="_blank" rel="noopener noreferrer"> Amazon EKS clusters</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-compute.html" title="Amazon EKS nodes" target="_blank" rel="noopener noreferrer"> Amazon EKS nodes</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html" title="Managed node groups" target="_blank" rel="noopener noreferrer"> Managed node groups</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/autoscaling.html" title="Autoscaling" target="_blank" rel="noopener noreferrer"> Autoscaling</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html" title="AWS Load Balancer Controller" target="_blank" rel="noopener noreferrer"> AWS Load Balancer Controller</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/metrics-server.html" title="Installing the Kubernetes Metrics Server" target="_blank" rel="noopener noreferrer"> Installing the Kubernetes Metrics Server</a></li>
  <li><a href="https://docs.aws.amazon.com/cloud-map/latest/dg/working-with-namespaces.html" title="Working with Namespaces" target="_blank" rel="noopener noreferrer"> Working with Namespaces</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment" title="Deployments" target="_blank" rel="noopener noreferrer"> Deployments</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/pods" title="Pods" target="_blank" rel="noopener noreferrer"> Pods</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset" title="ReplicaSet" target="_blank" rel="noopener noreferrer"> ReplicaSet</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/services-networking/service" title="Service" target="_blank" rel="noopener noreferrer"> Service</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale" title="Horizontal Pod Autoscaling" target="_blank" rel="noopener noreferrer"> Horizontal Pod Autoscaling</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset" title="StatefulSets" target="_blank" rel="noopener noreferrer"> StatefulSets</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress" title="Ingress" target="_blank" rel="noopener noreferrer"> Ingress</a></li>
</ol>

<hr>


  </article>

</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2023 <a href="https://vujadeyoon.github.io" target="_blank">Sungjun Yoon</a>. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Mansory & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/mansory.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script src="/assets/js/common.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
  </body>
</html>

